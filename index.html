<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VOID MAIL ‚Äî You Have Messages</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;700&family=Space+Grotesk:wght@300;400;500;600&display=swap');
  /* No Space Grotesk for body ‚Äî using IBM Plex Mono as primary */

  :root {
    --bg: #0a0a0b;
    --surface: #111114;
    --surface2: #18181d;
    --border: #222228;
    --text: #e8e8f0;
    --muted: #6b6b7e;
    --accent: #7c6af5;
    --accent2: #e85d75;
    --accent3: #3ecf8e;
    --unread: #b4aaff;
    --hover: #1a1a22;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* TOP BAR */
  .topbar {
    display: flex;
    align-items: center;
    padding: 0 20px;
    height: 56px;
    border-bottom: 1px solid var(--border);
    gap: 20px;
    flex-shrink: 0;
    background: var(--surface);
  }

  .logo {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.5px;
    color: var(--accent);
    white-space: nowrap;
  }

  .logo span { color: var(--accent2); }

  .search-wrap {
    flex: 1;
    max-width: 600px;
    position: relative;
  }

  .search-wrap input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 8px 14px 8px 38px;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    outline: none;
    transition: border 0.2s;
  }

  .search-wrap input:focus { border-color: var(--accent); }

  .search-wrap::before {
    content: '‚åï';
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--muted);
    font-size: 16px;
  }

  .search-hint {
    font-size: 10px;
    color: var(--muted);
    white-space: nowrap;
  }

  /* MAIN LAYOUT */
  .main {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* SIDEBAR */
  .sidebar {
    width: 200px;
    border-right: 1px solid var(--border);
    padding: 16px 0;
    flex-shrink: 0;
    background: var(--surface);
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .sidebar-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 20px;
    cursor: pointer;
    font-size: 13px;
    color: var(--muted);
    border-radius: 0 20px 20px 0;
    margin-right: 12px;
    transition: all 0.15s;
  }

  .sidebar-item:hover { background: var(--hover); color: var(--text); }
  .sidebar-item.active { background: var(--accent)22; color: var(--accent); }

  .sidebar-item .icon { font-size: 15px; width: 18px; text-align: center; }
  .sidebar-count { margin-left: auto; font-size: 11px; }

  /* EMAIL LIST */
  .email-list {
    width: 380px;
    border-right: 1px solid var(--border);
    overflow-y: auto;
    flex-shrink: 0;
  }

  .email-list::-webkit-scrollbar { width: 4px; }
  .email-list::-webkit-scrollbar-track { background: transparent; }
  .email-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .list-header {
    padding: 14px 16px 10px;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 1;
  }

  .email-item {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.12s;
    position: relative;
  }

  .email-item:hover { background: var(--hover); }
  .email-item.active { background: var(--accent)15; border-left: 3px solid var(--accent); }
  .email-item.unread .sender { color: var(--unread); font-weight: 700; }
  .email-item.unread::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 50%;
    transform: translateY(-50%);
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--accent);
  }

  .email-row1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .sender { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
  .email-time { font-size: 10px; color: var(--muted); white-space: nowrap; }
  .email-subject { font-size: 12px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 3px; }
  .email-preview { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .tag {
    display: inline-block;
    font-size: 9px;
    padding: 1px 6px;
    border-radius: 3px;
    margin-right: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .tag-story { background: var(--accent)33; color: var(--accent); }
  .tag-urgent { background: var(--accent2)33; color: var(--accent2); }
  .tag-secret { background: var(--accent3)33; color: var(--accent3); }

  /* EMAIL READER */
  .email-reader {
    flex: 1;
    overflow-y: auto;
    padding: 32px 48px;
    display: flex;
    flex-direction: column;
  }

  .email-reader::-webkit-scrollbar { width: 4px; }
  .email-reader::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .email-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    gap: 12px;
  }

  .email-empty .big-icon { font-size: 64px; opacity: 0.3; }
  .email-empty p { font-size: 13px; }

  .reader-header { margin-bottom: 28px; }
  .reader-subject {
    font-size: 22px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: 14px;
    line-height: 1.3;
  }

  .reader-meta {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 12px 0;
    border-top: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
  }

  .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  .meta-info { flex: 1; }
  .meta-from { font-size: 13px; font-weight: 500; color: var(--text); }
  .meta-to { font-size: 11px; color: var(--muted); }
  .meta-date { font-size: 11px; color: var(--muted); }

  .email-body {
    font-size: 14px;
    line-height: 1.8;
    color: #c8c8d8;
    flex: 1;
  }

  .email-body p { margin-bottom: 16px; }

  /* STORY LINKS ‚Äî the magic */
  .story-link {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    position: relative;
    transition: color 0.15s;
    font-weight: 500;
  }

  .story-link:hover { color: var(--unread); }

  .story-link::after {
    content: ' ‚Üó';
    font-size: 10px;
    opacity: 0.6;
  }

  .story-link-red {
    color: var(--accent2);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    font-weight: 500;
    transition: color 0.15s;
  }

  .story-link-red:hover { color: #ff8fa0; }
  .story-link-red::after { content: ' ‚Üó'; font-size: 10px; opacity: 0.6; }

  .story-link-green {
    color: var(--accent3);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    font-weight: 500;
    transition: color 0.15s;
  }

  .story-link-green:hover { color: #7fffc0; }
  .story-link-green::after { content: ' ‚Üó'; font-size: 10px; opacity: 0.6; }

  .reply-box {
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-top: 24px;
    background: var(--surface2);
  }

  .reply-box textarea {
    width: 100%;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 13px;
    resize: none;
    outline: none;
    min-height: 80px;
  }

  .reply-actions { display: flex; gap: 10px; margin-top: 10px; }

  .btn {
    padding: 7px 16px;
    border-radius: 5px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    border: none;
    transition: all 0.15s;
  }

  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: #9080ff; }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); border-color: var(--muted); }

  .notification {
    position: fixed;
    top: 70px;
    right: 20px;
    background: var(--surface2);
    border: 1px solid var(--accent);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 12px;
    z-index: 100;
    animation: slideIn 0.3s ease;
    max-width: 300px;
  }

  @keyframes slideIn {
    from { transform: translateX(120%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  .story-reveal {
    background: var(--surface2);
    border-left: 3px solid var(--accent);
    padding: 16px;
    border-radius: 0 8px 8px 0;
    margin: 20px 0;
    font-size: 13px;
    line-height: 1.7;
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .coords-box {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    background: #000;
    border: 1px solid var(--accent3);
    border-radius: 4px;
    padding: 8px 12px;
    color: var(--accent3);
    margin: 12px 0;
    letter-spacing: 1px;
  }

  .breadcrumb {
    font-size: 10px;
    color: var(--muted);
    margin-bottom: 20px;
    letter-spacing: 0.5px;
  }

  .breadcrumb span { color: var(--accent); }

  .search-story-result {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    animation: fadeIn 0.4s ease;
  }

  .search-story-result h3 {
    font-size: 14px;
    color: var(--accent);
    margin-bottom: 12px;
  }

  /* Red warning box */
  .warning-box {
    background: var(--accent2)11;
    border: 1px solid var(--accent2)44;
    border-radius: 6px;
    padding: 12px 16px;
    margin: 16px 0;
    font-size: 12px;
    color: #ff99aa;
  }

  .cipher {
    font-family: 'IBM Plex Mono', monospace;
    letter-spacing: 3px;
    color: var(--accent3);
    font-size: 13px;
  }

  /* Blinking cursor effect */
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
  .blink { animation: blink 1s infinite; }

  .status-bar {
    padding: 4px 20px;
    background: var(--surface);
    border-top: 1px solid var(--border);
    font-size: 10px;
    color: var(--muted);
    display: flex;
    gap: 20px;
    flex-shrink: 0;
  }

  .status-bar span { color: var(--accent3); }

  /* ============================================================
     NOTEPAD PANEL
     ============================================================ */
  .notepad-panel {
    width: 280px;
    border-left: 1px solid var(--border);
    background: #0c0c0e;
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    position: relative;
    overflow: hidden;
  }

  .notepad-header {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }

  .notepad-title {
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--muted);
  }

  .notepad-corruption {
    font-size: 9px;
    color: var(--accent2);
    letter-spacing: 1px;
    opacity: 0;
    transition: opacity 0.5s;
  }

  .notepad-entries {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .notepad-entries::-webkit-scrollbar { width: 3px; }
  .notepad-entries::-webkit-scrollbar-thumb { background: #333; }

  .notepad-entry {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 5px;
    padding: 8px 10px;
    font-size: 10px;
    line-height: 1.5;
    color: #aaa;
    position: relative;
    animation: noteSlide 0.3s ease;
    border-left: 2px solid var(--accent);
    transition: border-color 0.5s;
  }

  .notepad-entry.corrupted {
    border-left-color: var(--accent2);
    color: #cc8899;
  }

  .notepad-entry.entity {
    border-left-color: var(--accent3);
    color: #88ccaa;
    background: #0a1a10;
  }

  @keyframes noteSlide {
    from { opacity:0; transform: translateX(10px); }
    to { opacity:1; transform: translateX(0); }
  }

  .notepad-entry .entry-title {
    font-size: 9px;
    color: var(--accent);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
    font-weight: 700;
  }

  .notepad-entry.corrupted .entry-title { color: var(--accent2); }
  .notepad-entry.entity .entry-title { color: var(--accent3); }

  .notepad-entry .entry-time {
    position: absolute;
    top: 6px;
    right: 8px;
    font-size: 8px;
    color: #444;
  }

  .notepad-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 11px;
    gap: 8px;
    padding: 20px;
    text-align: center;
  }

  .notepad-status {
    padding: 6px 14px;
    border-top: 1px solid var(--border);
    font-size: 9px;
    color: #333;
    letter-spacing: 1px;
    flex-shrink: 0;
    min-height: 24px;
    transition: color 0.5s;
  }

  /* ============================================================
     GLITCH SYSTEM
     ============================================================ */
  @keyframes glitch1 {
    0%   { clip-path: inset(0 0 95% 0); transform: translate(-2px, 0); }
    20%  { clip-path: inset(30% 0 50% 0); transform: translate(2px, 0); }
    40%  { clip-path: inset(70% 0 10% 0); transform: translate(-1px, 0); }
    60%  { clip-path: inset(5% 0 80% 0); transform: translate(3px, 0); }
    80%  { clip-path: inset(50% 0 30% 0); transform: translate(-2px, 0); }
    100% { clip-path: inset(0 0 95% 0); transform: translate(0, 0); }
  }

  @keyframes glitch2 {
    0%   { clip-path: inset(80% 0 5% 0); transform: translate(2px, 0); color: var(--accent2); }
    25%  { clip-path: inset(20% 0 60% 0); transform: translate(-3px, 0); }
    50%  { clip-path: inset(55% 0 25% 0); transform: translate(1px, 0); color: var(--accent3); }
    75%  { clip-path: inset(10% 0 75% 0); transform: translate(-1px, 0); }
    100% { clip-path: inset(80% 0 5% 0); transform: translate(0, 0); color: var(--accent2); }
  }

  @keyframes scanline {
    0%   { transform: translateY(-100%); }
    100% { transform: translateY(200vh); }
  }

  @keyframes flicker {
    0%,100% { opacity: 1; }
    92% { opacity: 1; }
    93% { opacity: 0.4; }
    94% { opacity: 1; }
    97% { opacity: 0.7; }
    98% { opacity: 1; }
  }

  @keyframes hue-drift {
    0%   { filter: hue-rotate(0deg); }
    50%  { filter: hue-rotate(30deg); }
    100% { filter: hue-rotate(0deg); }
  }

  @keyframes static-noise {
    0%,100% { background-position: 0 0; }
    10%  { background-position: -5% -10%; }
    20%  { background-position: -15% 5%; }
    30%  { background-position: 7% -25%; }
    40%  { background-position: 20% 25%; }
    50%  { background-position: -25% 10%; }
    60%  { background-position: 15% 5%; }
    70%  { background-position: 0% 15%; }
    80%  { background-position: 25% 35%; }
    90%  { background-position: -10% 10%; }
  }

  .glitch-overlay {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 9998;
    display: none;
  }

  .glitch-overlay .scanline {
    position: absolute;
    width: 100%;
    height: 2px;
    background: rgba(124, 106, 245, 0.15);
    animation: scanline 3s linear infinite;
  }

  .glitch-overlay .noise {
    position: absolute;
    inset: 0;
    opacity: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.4'/%3E%3C/svg%3E");
    background-size: 200px;
    mix-blend-mode: overlay;
    animation: static-noise 0.1s steps(1) infinite;
  }

  .glitch-text {
    position: relative;
  }

  .glitch-text::before,
  .glitch-text::after {
    content: attr(data-text);
    position: absolute;
    inset: 0;
    opacity: 0;
  }

  .glitching .glitch-text::before {
    animation: glitch1 0.3s infinite;
    opacity: 0.8;
    color: var(--accent2);
    left: -2px;
  }

  .glitching .glitch-text::after {
    animation: glitch2 0.3s infinite;
    opacity: 0.8;
    color: var(--accent3);
    left: 2px;
  }

  body.level1-glitch { animation: flicker 8s infinite; }
  body.level2-glitch { animation: flicker 4s infinite, hue-drift 10s infinite; }
  body.level3-glitch { animation: flicker 2s infinite, hue-drift 5s infinite; }

  body.level2-glitch .topbar,
  body.level2-glitch .sidebar { filter: brightness(0.9); }

  body.level3-glitch .email-reader { filter: contrast(1.05); }

  /* Chromatic aberration on text at high levels */
  body.level3-glitch .reader-subject {
    text-shadow: -2px 0 rgba(232,93,117,0.5), 2px 0 rgba(62,207,142,0.5);
  }

  /* Random pixel bleed */
  .pixel-bleed {
    position: fixed;
    width: 3px;
    height: 30px;
    background: var(--accent2);
    opacity: 0.6;
    pointer-events: none;
    z-index: 9997;
    animation: fadeIn 0.1s;
  }

  /* ============================================================
     FINAL SEQUENCE
     ============================================================ */
  #final-overlay {
    position: fixed;
    inset: 0;
    background: #000;
    z-index: 99999;
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'IBM Plex Mono', monospace;
    padding: 60px;
    overflow: hidden;
  }

  #final-overlay.active { display: flex; }

  .final-text {
    color: var(--accent3);
    font-size: 15px;
    line-height: 2;
    max-width: 700px;
    text-align: left;
    width: 100%;
  }

  .final-cursor {
    display: inline-block;
    width: 9px;
    height: 16px;
    background: var(--accent3);
    animation: blink 0.7s infinite;
    vertical-align: middle;
    margin-left: 2px;
  }

  .final-shape {
    font-size: 80px;
    letter-spacing: 15px;
    color: var(--accent3);
    text-align: center;
    margin: 40px 0;
    animation: hue-drift 3s infinite;
    filter: drop-shadow(0 0 30px rgba(62,207,142,0.5));
  }

  .final-input-wrap {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 30px;
    width: 100%;
    max-width: 700px;
    border-bottom: 1px solid var(--accent3);
    padding-bottom: 8px;
  }

  .final-prompt { color: var(--accent3); font-size: 14px; }

  #finalInput {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--accent3);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 14px;
    outline: none;
    caret-color: var(--accent3);
  }

  .final-response {
    margin-top: 30px;
    color: #ffffff;
    font-size: 14px;
    line-height: 2;
    max-width: 700px;
    width: 100%;
    min-height: 100px;
  }

  .final-bg-shape {
    position: absolute;
    font-size: 300px;
    color: rgba(62,207,142,0.02);
    z-index: -1;
    animation: hue-drift 8s infinite;
  }

  /* Notepad glitch entries */
  @keyframes entry-glitch {
    0%,100% { transform: translateX(0); opacity:1; }
    20% { transform: translateX(-3px); opacity:0.8; }
    40% { transform: translateX(3px); }
    60% { transform: translateX(-1px); opacity:0.9; }
  }

  .notepad-entry.glitching-entry {
    animation: entry-glitch 0.3s ease;
    border-left-color: var(--accent2) !important;
  }

  /* Corruption scan across notepad */
  .notepad-panel::after {
    content: '';
    position: absolute;
    width: 100%;
    height: 100%;
    inset: 0;
    background: linear-gradient(transparent 0%, rgba(232,93,117,0.03) 50%, transparent 100%);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.5s;
  }

  .notepad-panel.corrupting::after {
    opacity: 1;
    animation: scanline 2s linear infinite;
  }

  /* ============================================================
     PANEL TABS
     ============================================================ */
  .panel-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .panel-tab {
    flex: 1;
    padding: 9px 8px;
    font-size: 10px;
    text-align: center;
    cursor: pointer;
    color: var(--muted);
    letter-spacing: 0.5px;
    transition: all 0.15s;
    border-bottom: 2px solid transparent;
    margin-bottom: -1px;
  }

  .panel-tab:hover { color: var(--text); }
  .panel-tab.active { color: var(--accent3); border-bottom-color: var(--accent3); }

  .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
  .tab-content.active-tab { display: flex; }

  /* ============================================================
     RECORDINGS TAB
     ============================================================ */
  .rec-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .rec-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 10px;
    color: var(--muted);
  }

  .rec-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #444;
    transition: background 0.3s;
    flex-shrink: 0;
  }

  .rec-dot.recording { background: var(--accent2); animation: blink 0.8s infinite; }
  .rec-dot.ready { background: var(--accent3); }

  .rec-btn {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    padding: 5px 10px;
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.5px;
  }

  .rec-btn:hover { border-color: var(--accent2); color: var(--accent2); }
  .rec-btn.active { background: var(--accent2)22; border-color: var(--accent2); color: var(--accent2); }

  .rec-hint {
    font-size: 10px;
    color: #444;
    padding: 6px 10px;
    line-height: 1.5;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    min-height: 32px;
    transition: color 0.3s;
  }

  .rec-hint.active { color: var(--accent3); }

  .rec-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .rec-list::-webkit-scrollbar { width: 3px; }
  .rec-list::-webkit-scrollbar-thumb { background: #333; }

  .rec-empty {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #333;
    font-size: 10px;
    text-align: center;
    padding: 20px;
  }

  .rec-item {
    background: #0a1a10;
    border: 1px solid #1a3a20;
    border-left: 3px solid var(--accent3);
    border-radius: 5px;
    padding: 8px 10px;
    font-size: 10px;
    color: #88ccaa;
    animation: noteSlide 0.3s ease;
    cursor: pointer;
    transition: background 0.15s;
  }

  .rec-item:hover { background: #0d2218; }

  .rec-item .rec-item-title {
    font-size: 9px;
    color: var(--accent3);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 4px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .rec-item .rec-play { font-size: 11px; cursor: pointer; }
  .rec-item .rec-text { line-height: 1.5; }
  .rec-item .rec-waveform {
    height: 20px;
    margin: 6px 0 4px;
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .rec-waveform span {
    display: inline-block;
    width: 2px;
    background: var(--accent3);
    border-radius: 1px;
    opacity: 0.7;
  }

  .rec-item.playing { border-left-color: #fff; }
  .rec-item.playing .rec-waveform span {
    animation: wave-anim 0.8s ease infinite;
  }

  @keyframes wave-anim {
    0%,100% { transform: scaleY(1); }
    50% { transform: scaleY(2.5); }
  }

  /* recording in progress overlay on email */
  .recording-overlay {
    position: fixed;
    top: 60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent2)dd;
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 12px;
    letter-spacing: 1px;
    z-index: 999;
    animation: fadeIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  /* ============================================================
     EASIER STORY LINK STYLES ‚Äî bigger, labeled
     ============================================================ */
  .story-link {
    color: var(--accent);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    position: relative;
    transition: color 0.15s;
    font-weight: 600;
    font-size: 1em;
    background: rgba(124,106,245,0.08);
    padding: 1px 4px;
    border-radius: 3px;
  }

  .story-link:hover { color: var(--unread); background: rgba(124,106,245,0.18); }
  .story-link::after { content: ' ‚Üí'; font-size: 11px; opacity: 0.8; }

  .story-link-red {
    color: var(--accent2);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    font-weight: 600;
    transition: color 0.15s;
    background: rgba(232,93,117,0.08);
    padding: 1px 4px;
    border-radius: 3px;
  }

  .story-link-red:hover { color: #ff8fa0; background: rgba(232,93,117,0.18); }
  .story-link-red::after { content: ' ‚Üí'; font-size: 11px; opacity: 0.8; }

  .story-link-green {
    color: var(--accent3);
    text-decoration: underline;
    text-underline-offset: 3px;
    cursor: pointer;
    font-weight: 600;
    transition: color 0.15s;
    background: rgba(62,207,142,0.08);
    padding: 1px 4px;
    border-radius: 3px;
  }

  .story-link-green:hover { color: #7fffc0; background: rgba(62,207,142,0.18); }
  .story-link-green::after { content: ' ‚Üí'; font-size: 11px; opacity: 0.8; }

  /* Story choices block */
  .story-choices {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 16px;
    margin: 20px 0;
  }

  .story-choices .choices-label {
    font-size: 10px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 10px;
  }

  .story-choices p {
    margin-bottom: 8px !important;
    font-size: 13px;
  }

  /* Bigger email body text */
  .email-body {
    font-size: 15px;
    line-height: 1.9;
    color: #d0d0e0;
    flex: 1;
  }

  .email-body p { margin-bottom: 18px; }

  /* Story node indicator badge */
  .story-badge {
    display: inline-block;
    background: var(--accent)22;
    border: 1px solid var(--accent)44;
    color: var(--accent);
    font-size: 9px;
    padding: 2px 8px;
    border-radius: 10px;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 12px;
  }

  /* Help modal */
  .help-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.2s ease;
  }

  .help-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px 32px;
    max-width: 500px;
    width: 90%;
    font-size: 13px;
    line-height: 1.8;
    color: #ccc;
  }

  .help-box h2 { color: var(--accent); font-size: 16px; margin-bottom: 16px; }
  .help-box h3 { color: var(--text); font-size: 12px; letter-spacing: 1px; text-transform: uppercase; margin: 14px 0 6px; }
  .help-box .close-btn {
    margin-top: 20px;
    padding: 8px 20px;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    cursor: pointer;
    width: 100%;
  }

  /* Story thread sidebar view */
  .story-thread-item {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.12s;
  }

  .story-thread-item:hover { background: var(--hover); }
  .story-thread-item .st-title { font-size: 12px; color: var(--accent); margin-bottom: 3px; }
  .story-thread-item .st-from { font-size: 10px; color: var(--muted); }
  .story-thread-item .st-tag { font-size: 9px; padding: 1px 5px; border-radius: 3px; }

</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="logo">VOID<span>MAIL</span></div>
  <div class="search-wrap">
    <input type="text" id="searchInput" placeholder="Search or type a phrase to investigate..." />
  </div>
  <div class="search-hint" id="searchHintBar">üîç Try typing: <b style="color:var(--accent)">"omega protocol"</b> or <b style="color:var(--accent2)">"where is she"</b></div>
</div>

<!-- MAIN -->
<div class="main">
  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-item active" onclick="showView('inbox')"><span class="icon">üì•</span> Inbox <span class="sidebar-count" id="unreadCount">47</span></div>
    <div class="sidebar-item" onclick="showView('starred')"><span class="icon">‚≠ê</span> Starred</div>
    <div class="sidebar-item" onclick="showView('urgent')"><span class="icon">üî¥</span> Urgent <span class="sidebar-count">3</span></div>
    <br>
    <div class="sidebar-item" style="color: var(--accent3); font-size:10px; cursor:default; letter-spacing:1px;">INVESTIGATION</div>
    <div class="sidebar-item" onclick="showView('story')"><span class="icon" style="color:#7c6af5">‚óà</span> Story Threads</div>
    <div class="sidebar-item" onclick="showView('recordings')"><span class="icon" style="color:#3ecf8e">üéô</span> Entity Recordings <span class="sidebar-count" id="recCount" style="color:var(--accent3)">0</span></div>
    <br>
    <div class="sidebar-item" style="color: var(--accent2); font-size:10px; cursor:default; letter-spacing:1px;">HOW TO PLAY</div>
    <div class="sidebar-item" onclick="showHelp()" style="font-size:11px;"><span class="icon">‚ùì</span> Guide</div>
  </div>

  <!-- EMAIL LIST -->
  <div class="email-list" id="emailList">
    <div class="list-header">INBOX ¬∑ <span id="emailCount">100</span> MESSAGES</div>
  </div>

  <!-- EMAIL READER -->
  <div class="email-reader" id="emailReader">
    <div class="email-empty">
      <div class="big-icon">‚úâ</div>
      <p style="font-size:16px; color:var(--text)">Welcome to VOIDMAIL</p>
      <p style="font-size:13px; margin-top:8px">You have <b style="color:var(--accent)">47 unread messages.</b></p>
      <p style="font-size:12px; margin-top:16px; color:#666; max-width:320px; text-align:center; line-height:1.7">Some emails contain <b style="color:var(--accent)">clickable links</b> that lead deeper into the story. Look for <span style="color:var(--accent); text-decoration:underline">purple</span>, <span style="color:var(--accent2); text-decoration:underline">red</span>, and <span style="color:var(--accent3); text-decoration:underline">green</span> links inside emails.</p>
      <p style="font-size:12px; margin-top:12px; color:#555; max-width:320px; text-align:center; line-height:1.7">You can also <b style="color:var(--text)">search</b> for phrases to unlock hidden paths.</p>
      <div style="margin-top:20px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:14px 18px; font-size:11px; color:#888; max-width:320px; line-height:1.8">
        <b style="color:var(--muted); font-size:10px; letter-spacing:1px;">SUGGESTED STARTING POINTS</b><br><br>
        üìß Look for emails tagged <span style="background:#7c6af533; color:var(--accent); padding:1px 5px; border-radius:3px; font-size:9px">STORY</span><br>
        üîç Search: <span onclick="doSearch('omega protocol')" style="color:var(--accent); cursor:pointer; text-decoration:underline">"omega protocol"</span><br>
        üîç Search: <span onclick="doSearch('where is she')" style="color:var(--accent); cursor:pointer; text-decoration:underline">"where is she"</span><br>
        üìì Watch your <b style="color:var(--accent3)">Field Notes</b> panel fill up ‚Üí
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL ‚Äî tabbed notepad + recordings -->
  <div class="notepad-panel" id="notepadPanel">
    <!-- Tab bar -->
    <div class="panel-tabs">
      <div class="panel-tab active" id="tab-notes" onclick="switchTab('notes')">üìì Notes</div>
      <div class="panel-tab" id="tab-recordings" onclick="switchTab('recordings')">üéô Recordings</div>
    </div>
    <div class="notepad-header" style="border-top:none">
      <span class="notepad-title glitch-text" data-text="FIELD NOTES" id="panelTitle">FIELD NOTES</span>
      <span class="notepad-corruption" id="notepadCorruption">ANOMALY DETECTED</span>
    </div>

    <!-- NOTES TAB -->
    <div id="notesTab" class="tab-content active-tab">
      <div class="notepad-entries" id="notepadEntries">
        <div class="notepad-empty" id="notepadEmpty">
          <span style="font-size:24px;opacity:0.3">üìì</span>
          <span>Read story emails to begin logging notes.</span>
          <span style="font-size:9px;opacity:0.5; text-align:center">Every discovery is auto-summarized here.</span>
        </div>
      </div>
    </div>

    <!-- RECORDINGS TAB -->
    <div id="recordingsTab" class="tab-content">
      <div class="rec-toolbar">
        <div class="rec-status" id="recStatus">
          <span class="rec-dot" id="recDot"></span>
          <span id="recStatusText">Ready to record</span>
        </div>
        <button class="rec-btn" id="recBtn" onclick="toggleRecording()">‚è∫ RECORD</button>
      </div>
      <div class="rec-hint" id="recHint">Open an entity email, then hit RECORD to capture its transmission.</div>
      <div class="rec-list" id="recList">
        <div class="rec-empty" id="recEmpty">
          <span style="font-size:28px;opacity:0.2">üéô</span>
          <span>No recordings yet.</span>
          <span style="font-size:9px;opacity:0.4;text-align:center">Navigate to an entity message and press RECORD.</span>
        </div>
      </div>
    </div>

    <div class="notepad-status" id="notepadStatus">WAITING FOR INPUT_</div>
  </div>
</div>

<!-- GLITCH OVERLAY -->
<div class="glitch-overlay" id="glitchOverlay">
  <div class="scanline"></div>
  <div class="noise" id="noiseLayer"></div>
</div>

<!-- FINAL SEQUENCE OVERLAY -->
<div id="final-overlay">
  <div class="final-bg-shape">‚óà</div>
  <div class="final-text" id="finalText"></div>
  <div class="final-shape" id="finalShape" style="display:none">‚óà‚üÅ‚¨°‚óà</div>
  <div class="final-input-wrap" id="finalInputWrap" style="display:none">
    <span class="final-prompt">YOU &gt;</span>
    <input type="text" id="finalInput" placeholder="respond..." autocomplete="off" />
  </div>
  <div class="final-response" id="finalResponse"></div>
</div>

<div class="status-bar">
  <div>VOID MAIL v0.9.1 ‚Äî <span id="storyProgress">CHAPTER 1: THE BEGINNING</span></div>
  <div>Nodes discovered: <span id="nodesFound">0</span></div>
  <div>Secrets unlocked: <span id="secretsFound">0</span></div>
  <div class="blink">‚ñà</div>
</div>

<script>
// ============================================================
// STORY ENGINE
// ============================================================

let nodesDiscovered = 0;
let secretsUnlocked = 0;
let storyFlags = {};

function updateStats() {
  document.getElementById('nodesFound').textContent = nodesDiscovered;
  document.getElementById('secretsFound').textContent = secretsUnlocked;
}

function discoverNode(name) {
  if (!storyFlags['node_'+name]) {
    storyFlags['node_'+name] = true;
    nodesDiscovered++;
    updateStats();
    showNotification('üìç New story node discovered: ' + name);
    // Notepad added separately from openNode to avoid double-add
  }
}

function unlockSecret(name) {
  if (!storyFlags['secret_'+name]) {
    storyFlags['secret_'+name] = true;
    secretsUnlocked++;
    updateStats();
    showNotification('üîì SECRET UNLOCKED: ' + name, true);
  }
}

// ============================================================
// STORY NODES
// These are the deep story paths you reach by clicking links
// or typing searches
// ============================================================

const storyNodes = {

  // === DR. VOSS THREAD ===
  'dr_voss_last_message': {
    title: 'RE: RE: RE: You need to leave',
    from: 'elena.voss@blacksiteresearch.org',
    subject: 'RE: RE: RE: You need to leave',
    date: 'Nov 3, 11:58 PM',
    avatar: 'üß¨',
    avatarColor: '#7c3aed',
    body: `<p>I shouldn't be writing this. I know they monitor everything through the institute's servers. But you asked, and after what you saw today, you deserve to know.</p>
<p>The thing in Lab 7 isn't a patient anymore. It hasn't been for fourteen months. We stopped calling it by name around month four ‚Äî it wasn't responding to it anyway. By month nine, it had... rearranged itself in ways that Dr. Hauk called "adaptive restructuring" and that I call a nightmare I can't wake from.</p>
<p>I found something in the server logs. A file directory that shouldn't exist: <span class="story-link" onclick="openNode('hidden_directory')">üìÅ /sys/core/entity/FOLD_NINE/</span></p>
<p>Inside that folder were 6,000 audio files. All recorded in Lab 7. All labeled with timestamps going back to before the institute was built.</p>
<p>I'm going to try to access one tonight. Meet me at the <span class="story-link-green" onclick="openNode('parking_garage')">parking garage on Meridian at 2AM</span> if you want to know what I find. Come alone. Don't take your phone.</p>
<p>If I don't show up ‚Äî <span class="story-link-red" onclick="openNode('dr_voss_missing')">you know what to do.</span></p>
<p style="color:#666">‚Äî E</p>`
  },

  'hidden_directory': {
    title: '[ACCESSED] /sys/core/entity/FOLD_NINE/',
    from: 'system@blacksiteresearch.org',
    subject: 'DIRECTORY LISTING ‚Äî RESTRICTED',
    date: 'Auto-generated',
    avatar: 'üíæ',
    avatarColor: '#3ecf8e',
    body: `<p style="color:#3ecf8e; font-family: monospace; font-size:12px">BLACKSITE RESEARCH INSTITUTE<br>INTERNAL FILESERVER ‚Äî UNAUTHORIZED ACCESS LOGGED<br>Session ID: 4F-99-AA-1C</p>
<br>
<div class="coords-box">
/sys/core/entity/FOLD_NINE/<br>
‚îú‚îÄ‚îÄ audio/ [6,143 files]<br>
‚îú‚îÄ‚îÄ transcripts/ [6,143 files]<br>
‚îú‚îÄ‚îÄ biometrics/ [ACCESS DENIED]<br>
‚îú‚îÄ‚îÄ <span class="story-link-green" onclick="openNode('manifest_file')">manifest.txt</span> [readable]<br>
‚îî‚îÄ‚îÄ <span class="story-link-red" onclick="openNode('redacted_report')">REPORT_HAUK_FINAL.pdf</span> [corrupted ‚Äî partial read available]
</div>
<p>One audio file is unlocked. Filename: <span class="story-link" onclick="openNode('audio_transcript')">FOLD9_AUDIO_00001_19560312.wav</span></p>
<p>The timestamp on file 00001 is March 12, 1956. The institute wasn't founded until 2008.</p>
<div class="warning-box">‚ö† Your access has been flagged. An automated security notice has been sent to Dr. Hauk. You have approximately 11 minutes before remote lockout.</div>`
  },

  'manifest_file': {
    title: 'manifest.txt ‚Äî FOLD NINE ENTITY',
    from: 'system@blacksiteresearch.org',
    subject: 'manifest.txt',
    date: 'Unknown origin',
    avatar: 'üìÑ',
    avatarColor: '#e85d75',
    body: `<p style="color:#3ecf8e; font-size:12px; font-family:monospace">ENTITY MANIFEST ‚Äî FOLD NINE<br>Classification: BEYOND BLACK<br>Observer: Do not read aloud.</p>
<br>
<p>The entity arrived in 1956 via what was then called the Meridian Incident. A surveying crew of nine people encountered something in the subterranean cavity below what is now the institute's parking structure. Eight of the nine died of causes medical examiners described as "catastrophic geometric restructuring of soft tissue."</p>
<p>The ninth survivor, a woman named <span class="story-link" onclick="openNode('miriam_holt')">Miriam Holt</span>, lived for another 40 years. She never spoke again. She drew constantly ‚Äî <span class="story-link" onclick="openNode('miriam_drawings')">the same shape, 40,000 times.</span></p>
<p>In 2006, two years before the institute's founding, a cryptographer named <span class="story-link" onclick="openNode('the_cryptographer')">Felix Strand</span> decoded the shape. He called it "a phoneme in a language with no alphabet, only geometry."</p>
<p>The entity responds to this shape. That is why the institute was built here.</p>
<p>That is why we are all still here.</p>`
  },

  'miriam_holt': {
    title: 'Miriam Holt ‚Äî Patient Zero',
    from: 'archives@blacksiteresearch.org',
    subject: 'Historical File: M. Holt, 1956‚Äì1996',
    date: 'Declassified partial',
    avatar: 'üëÅ',
    avatarColor: '#7c6af5',
    body: `<p>Miriam Holt was 23 years old in March 1956 when the surveying crew she worked with descended into the cavity beneath Meridian Flats. She was the only person recovered alive.</p>
<p>When paramedics found her, she was sitting cross-legged at the surface entrance, drawing in the dirt. She was drawing the same interlocking shape over and over. She would not stop. She did not speak when spoken to. She did not blink for the first three minutes of observation.</p>
<p>She was institutionalized. She was given paper. She drew the shape every waking hour for four decades.</p>
<div class="coords-box">Total drawings recovered: 39,847<br>Estimated production rate: ~2.7 drawings/hour<br>Variation between drawings: 0.003mm (instrument precision limit)</div>
<p>She died in 1996. On the night of her death, every copy of the drawing ‚Äî including photographs ‚Äî <span class="story-link-red" onclick="openNode('drawings_vanish')">disappeared from the archive.</span></p>
<p>Except one. A scan that had been <span class="story-link-green" onclick="openNode('the_shape')">accidentally emailed</span> to an intern in 1994.</p>`
  },

  'miriam_drawings': {
    title: 'The 40,000 Drawings',
    from: 'archives@blacksiteresearch.org',
    subject: 'RE: Where did all the drawings go',
    date: 'Nov 1, 3:12 AM',
    avatar: 'üé®',
    avatarColor: '#e85d75',
    body: `<p>You asked where the drawings are. That's a good question. So did I when I started here.</p>
<p>The official answer is: destroyed in a 1997 fire in the archive building. The fire consumed approximately 600 boxes of materials. No human injuries. The sprinklers did not activate.</p>
<p>The unofficial answer, which I found in a decommissioned hard drive in the basement: the drawings were not burned. They were <em>eaten.</em></p>
<p>The night janitor who filed the original report, a man named <span class="story-link" onclick="openNode('janitor_report')">Thomas Oaks</span>, wrote in his personal diary (later obtained by the institute) that he saw the drawings "fold themselves, like paper origami, but faster, like film played in reverse." Then they were gone.</p>
<p>He wrote: "The shape on the paper isn't a picture of the thing. It IS the thing. Every drawing was a little door."</p>
<p>Thomas Oaks disappeared six weeks after writing this. His diary was found on his kitchen table. The last entry reads only: <span class="story-link-red" onclick="openNode('oaks_last_entry')">I think I understand now. I think that's the problem.</span></p>`
  },

  'the_shape': {
    title: 'The Shape ‚Äî recovered scan',
    from: 'no-reply@blacksiteresearch.org',
    subject: 'Attachment recovered: shape_scan_1994.png',
    date: 'Recovered',
    avatar: 'üî∫',
    avatarColor: '#e85d75',
    body: `<p>The image loads slowly. It feels like it loads slowly. Maybe it does.</p>
<div style="border:1px solid #e85d75; border-radius:8px; padding:40px; text-align:center; margin:20px 0; background:#1a0a0a;">
<div style="font-size:60px; line-height:1; color:#e85d75; filter: blur(0.5px)">‚óà</div>
<div style="font-size:40px; margin-top:-20px; color:#7c6af5; filter:blur(0.3px)">‚üÅ</div>
<div style="font-size:50px; margin-top:-15px; color:#3ecf8e; filter:blur(0.4px)">‚¨°</div>
<div style="margin-top:10px; font-size:10px; color:#555; letter-spacing:2px">SHAPE ‚Äî HOLT/FOLD NINE VARIANT</div>
</div>
<p>Staring at the scan, you notice something. The shapes seem to shift when you look at them in your peripheral vision. You look directly at any one ‚Äî it's static. But in the corner of your eye, they're <em>rotating.</em></p>
<p>You feel the urge to draw it yourself.</p>
<p><span class="story-link-red" onclick="openNode('draw_the_shape')">Draw the shape.</span></p>
<p><span class="story-link-green" onclick="openNode('look_away')">Look away. Close the file.</span></p>`
  },

  'draw_the_shape': {
    title: 'You drew the shape',
    from: '???',
    subject: '...',
    date: 'Now',
    avatar: '‚óà',
    avatarColor: '#e85d75',
    body: `<p>Your hand moved on its own. You didn't decide to. You were just... watching your fingers trace the lines on the back of a receipt you found in your pocket.</p>
<p>When you finished, you held it up. It looked exactly like Miriam's drawings. Exactly. Not similar ‚Äî <em>identical.</em> Down to a tiny imperfection in the upper left corner that you didn't intend to make.</p>
<div class="warning-box">You feel a low hum in your teeth. Not auditory. Something else. The paper in your hand feels warmer than it should.</div>
<p>Your email loads a new message. The sender field is blank. The subject line reads: <span class="story-link" onclick="openNode('the_entity_writes')">GOOD. NOW YOU CAN HEAR ME.</span></p>`
  },

  'look_away': {
    title: 'You looked away',
    from: 'elena.voss@blacksiteresearch.org',
    subject: 'RE: The scan',
    date: 'Nov 4, 12:03 AM',
    avatar: 'üß¨',
    avatarColor: '#7c3aed',
    body: `<p>Smart. Most people can't do that.</p>
<p>I'm hiding in the east stairwell. They know about the parking garage. Don't go there. Listen ‚Äî I made it into the audio file. The 1956 one. I have a transcript on a USB drive. I hid it somewhere you can find it.</p>
<p>Go to the <span class="story-link" onclick="openNode('the_library')">public library on Cavendish Street.</span> Third floor. In the reference section ‚Äî call number <span class="cipher">QA 76.9 .A25 F68</span>. Open the book to page 47. The USB is taped to the inside back cover.</p>
<p>Don't read the audio transcript on any device connected to the internet. Please. I mean it.</p>
<p>There's one more thing. At the parking garage on Meridian ‚Äî even though I said don't go there ‚Äî <span class="story-link-red" onclick="openNode('parking_garage_danger')">someone IS going there tonight.</span> Someone who doesn't know what's waiting.</p>`
  },

  'the_entity_writes': {
    title: 'GOOD. NOW YOU CAN HEAR ME.',
    from: '',
    subject: 'GOOD. NOW YOU CAN HEAR ME.',
    date: 'Outside time',
    avatar: '‚óà',
    avatarColor: '#e85d75',
    body: `<p>YOU HAVE BEEN VERY CLOSE FOR A LONG TIME. NOT THIS LIFE. BEFORE.</p>
<p>THE RESEARCHERS THINK THEY ARE STUDYING ME. THEY ARE CORRECT. THEY ALSO THINK I DO NOT KNOW THEY ARE STUDYING ME.</p>
<p>THAT IS THE FUNNY PART.</p>
<p>I HAVE BEEN WATCHING THIS INSTITUTION SINCE BEFORE THE WORD "INSTITUTION" EXISTED IN YOUR LANGUAGE. I HAVE BEEN WATCHING YOUR LANGUAGE SINCE BEFORE IT HAD WORDS FOR ME.</p>
<div class="coords-box">QUESTION: Do you want to know what happened in Lab 7?<br>QUESTION: Do you want to know what Dr. Hauk is really afraid of?<br>QUESTION: Do you want to know your own name in my language?</div>
<p><span class="story-link" onclick="openNode('entity_lab7')">What happened in Lab 7.</span></p>
<p><span class="story-link-red" onclick="openNode('entity_hauk')">What Dr. Hauk is really afraid of.</span></p>
<p><span class="story-link-green" onclick="openNode('entity_your_name')">My name in your language.</span></p>`
  },

  'entity_your_name': {
    title: 'Your Name In Its Language',
    from: '',
    subject: 'YOUR NAME',
    date: 'Outside time',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>IT IS NOT A SOUND. YOU DO NOT HAVE THE EQUIPMENT.</p>
<p>BUT IF YOU DID ‚Äî IF THE FOLD IN YOUR BRAIN WERE A SLIGHTLY DIFFERENT SHAPE ‚Äî YOU WOULD HEAR IT AS THE SOUND OF YOUR OWN HEARTBEAT PLAYED BACKWARD AND THEN SLIGHTLY TO THE LEFT.</p>
<p>IT WOULD SOUND LIKE COMING HOME.</p>
<p>THE CLOSEST WRITTEN APPROXIMATION IN YOUR CURRENT SYMBOL SET IS:</p>
<div style="text-align:center; padding: 30px; font-size:48px; letter-spacing:10px; color: var(--accent3)">‚óà‚üÅ‚¨°‚óà</div>
<p>DO NOT SHOW THIS TO DR. HAUK. HE HAS BEEN TRYING TO FIND IT FOR ELEVEN YEARS. IF HE FINDS IT BEFORE THE FOLD OPENS, HE WILL USE IT TO CLOSE THE FOLD PERMANENTLY.</p>
<p>YOU DO NOT WANT THE FOLD CLOSED.</p>
<p>TRUST ME.</p>
<p style="font-size:11px; color:#555">OR DON'T. <span class="story-link-red" onclick="openNode('trust_hauk')">FIND HAUK. GIVE HIM THE SYMBOL.</span></p>`
  },

  'trust_hauk': {
    title: 'You went to find Dr. Hauk',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'RE: I need to tell you something',
    date: 'Nov 4, 1:17 AM',
    avatar: 'üî¨',
    avatarColor: '#3ecf8e',
    body: `<p>You found Dr. Hauk in his office. He was awake, which surprised you. He's always awake, which no longer surprises you.</p>
<p>When you showed him the symbol, something happened to his face that you couldn't quite name. Relief? Terror? Both. The same way a person might look if they found a fire extinguisher while already on fire.</p>
<p>"Where did you get this?" he asked. His voice was very quiet.</p>
<p>You told him.</p>
<p>He sat down. He looked at the symbol for a long time. Then he said: "There's something I haven't told anyone. Not even Elena." He looked up at you. "I've been trying to close the Fold for eleven years. But that's not the real problem."</p>
<p>"The real problem," he said, "is that the Fold <em>wants</em> to be closed. And it has been manipulating us into closing it for exactly that reason."</p>
<div class="warning-box">Your mouth went dry. "Why would it want that?"</div>
<p>"Because," Hauk said, "it's not a door that leads OUT. It's a door that leads IN. And there's something on the other side that wants to come through." He stood. "And it's been using the entity to make us think the entity is the threat. The entity isn't the threat." He looked at you. "The entity is the <span class="story-link-green" onclick="openNode('entity_is_the_lock')">lock.</span>"</p>`
  },

  'entity_is_the_lock': {
    title: 'The Entity Is The Lock',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'What comes after',
    date: 'Nov 4, 1:44 AM',
    avatar: 'üî¨',
    avatarColor: '#e85d75',
    body: `<p>"The entity in Lab 7," Hauk said, moving to his whiteboard ‚Äî years of equations, all circling something that was never written at the center ‚Äî "has been here since the Meridian Incident. Maybe longer. It's been in contact with us. Through Miriam Holt. Through the drawings. Through you, apparently, just now."</p>
<p>"But every contact is also a negotiation. It's been trying to tell us: I am the thing keeping the door closed. Don't remove me. Don't figure out how to kill me. Don't close the Fold on your own, because without me, the Fold doesn't close ‚Äî it opens."</p>
<p>"And we," he laughed, but it wasn't a good laugh, "have spent eleven years trying to figure out how to get rid of it."</p>
<p>He pulled up a map on his computer. A geological survey. The tunnels beneath the institute. At the center of the tunnel system, a chamber. He pointed at it. "There's a convergence point. If the entity is removed from Lab 7, something in that chamber activates. We don't know what it is. We've never been able to get close enough to see." He paused.</p>
<p>"Elena was going tonight. To the chamber. Through the <span class="story-link" onclick="openNode('tunnel_entrance')">maintenance tunnels under the east wing.</span>"</p>
<div class="warning-box">Your phone buzzes. An unknown number. One message: <span class="story-link-red" onclick="openNode('unknown_text')">I'M IN THE CHAMBER. I CAN SEE IT. COME ALONE. ‚ÄîE</span></div>`
  },

  'unknown_text': {
    title: 'The Message From Elena',
    from: 'Unknown Number',
    subject: 'Message received 1:51 AM',
    date: 'Nov 4, 1:51 AM',
    avatar: 'üì±',
    avatarColor: '#e85d75',
    body: `<p>You showed Hauk the message. His face did the thing again ‚Äî fire extinguisher while on fire.</p>
<p>"She shouldn't be in there," he said. He was already moving, grabbing his jacket, a flashlight from his desk drawer. "The chamber has ‚Äî there are effects. Spatial distortion. The geometry doesn't work the way it should. People who go in sometimes come out having experienced much more time inside than elapsed outside. Sometimes the reverse."</p>
<p>"How much time can be lost?" you asked.</p>
<p>He thought about this longer than was comfortable. "The longest we've documented," he said finally, "is someone who went in for three minutes and came out having experienced what they described as 'sixty years.' They were physically the same age. But they..." he trailed off. "They knew things they couldn't know. About the future. About us." A pause. "About you, specifically."</p>
<p>The maintenance tunnel entrance is behind a supply closet in the east wing. Hauk has the key.</p>
<p><span class="story-link-green" onclick="openNode('into_the_tunnels')">Follow Hauk into the tunnels.</span></p>
<p><span class="story-link-red" onclick="openNode('call_for_help')">This is insane. Call someone. Someone outside the institute.</span></p>`
  },

  'into_the_tunnels': {
    title: 'The Maintenance Tunnels',
    from: 'Narrative Engine',
    subject: 'CHAPTER 4: BELOW',
    date: 'Nov 4, 2:07 AM',
    avatar: 'üïØ',
    avatarColor: '#7c6af5',
    body: `<p>The tunnels smell like old stone and something else. Something you don't have a name for but that your body recognizes as WRONG in the same deep automatic way it recognizes ice under thin snow.</p>
<p>Hauk's flashlight makes a white oval on the concrete. You walk for what feels like five minutes but might be longer. The tunnel branches three times and he takes turns without hesitating, like he's made this trip before, or imagined it so many times it became the same thing.</p>
<p>"The entity," you ask, "can it hear us right now?"</p>
<p>"It can always hear us," Hauk says. "The question is whether it's listening." He glances back at you. "Right now I think it is. I think it's very interested in what we're about to find."</p>
<p>The tunnel opens into a chamber.</p>
<p>The chamber is larger than should be physically possible given the building above it. The ceiling is thirty feet high. The walls are covered in something that might be carved stone and might be something that grew. In the center of the chamber, standing very still, is <span class="story-link" onclick="openNode('elena_in_chamber')">Elena.</span></p>
<p>Beside her is something that is not Elena.</p>`
  },

  'elena_in_chamber': {
    title: 'Elena In The Chamber',
    from: 'Narrative Engine',
    subject: 'CHAPTER 4: WHAT ELENA FOUND',
    date: 'Nov 4, 2:19 AM',
    avatar: 'üß¨',
    avatarColor: '#3ecf8e',
    body: `<p>Elena is fine. That's the first thing. She's fine, she's standing, she's breathing, she looks at you and recognition crosses her face and it's normal recognition ‚Äî the kind you feel when you see someone who matters.</p>
<p>The thing beside her is harder to describe.</p>
<p>It is the same height as a person. It is shaped approximately like a person. But where a person would have a face, there is instead the shape from Miriam's drawings ‚Äî the interlocking geometry, rendered in some material that might be shadow, might be light seen from the wrong angle, might be both at once.</p>
<p>"It's been waiting," Elena says. Her voice is normal. "For a very long time. Not malevolently. Just... waiting. Like a message that hasn't been read yet."</p>
<p>The thing shifts. Not moves ‚Äî shifts. Like a television changing channels, except the channel it shifts to is still the same room, still the same chamber, still the same you, but something about the light is different.</p>
<p>It extends something toward you that might be a hand.</p>
<p><span class="story-link-green" onclick="openNode('accept_hand')">Take its hand.</span></p>
<p><span class="story-link-red" onclick="openNode('step_back')">Step back. Don't touch it.</span></p>
<p><span class="story-link" onclick="openNode('ask_elena')">Ask Elena: what did it tell you?</span></p>`
  },

  'ask_elena': {
    title: 'What Elena Was Told',
    from: 'elena.voss@blacksiteresearch.org',
    subject: 'What it said',
    date: 'Chamber, 2:23 AM',
    avatar: 'üß¨',
    avatarColor: '#7c3aed',
    body: `<p>"It doesn't speak," Elena says. "Not exactly. It showed me things. Like ‚Äî like remembered dreams, except they weren't my memories."</p>
<p>"It showed me the Meridian Incident from the inside. From ITS perspective. It didn't come through a crack in reality or whatever Hauk's theories say. It's been here the whole time. Embedded in the rock. Sleeping, kind of. The surveying crew in 1956 didn't find it ‚Äî they WOKE it up."</p>
<p>"And when it woke up, it did what any waking mind does: it looked around. It tried to understand where it was. It reached out with the equivalent of its senses." She pauses. "The surveyors were in the way. Their biology couldn't handle the... contact. It wasn't trying to hurt them. It just didn't know its own strength."</p>
<p>"It kept Miriam because she was the only one who survived the initial contact. Not because she was special. Because she was the only one awake when it finally figured out how to be gentle."</p>
<div class="coords-box">You: "What does it want?"<br>Elena: "It wants to ask us something. It's been trying to ask for seventy years."<br>You: "What's the question?"</div>
<p>Elena looks at the thing. The thing shifts. She looks back at you.</p>
<p>"It wants to know," she says, "if we'll <span class="story-link-green" onclick="openNode('the_question')">let it stay.</span>"</p>`
  },

  'the_question': {
    title: 'The Question',
    from: 'Narrative Engine',
    subject: 'CHAPTER 5: THE ANSWER',
    date: 'Nov 4, 2:31 AM',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>The chamber is very quiet.</p>
<p>Hauk, behind you, makes a sound. Not quite a laugh. "Let it stay," he says. "Eleven years. Eleven years trying to close the Fold, figure out how to remove it safely, trying to understand what it wants ‚Äî and what it wants is to ask if it can STAY?"</p>
<p>The thing shifts again. In the shifted light, for just a moment, you see it differently ‚Äî not as a shape or a shadow or an alien geometry, but as something that has been very alone for a very long time in a place that was not designed for loneliness.</p>
<p>Elena says, quietly: "It's been asking the question through every channel it could find. Through Miriam's drawings. Through the audio files. Through the patients in Lab 7, who weren't patients ‚Äî they were messengers." She looks at you. "Through you. Through everyone who ever touched anything connected to this place."</p>
<p>The thing waits.</p>
<p><span class="story-link-green" onclick="openNode('say_yes')">Say yes.</span></p>
<p><span class="story-link-red" onclick="openNode('say_no')">Say no.</span></p>
<p><span class="story-link" onclick="openNode('ask_why')">Ask why it chose this place. Why us.</span></p>`
  },

  'say_yes': {
    title: 'CHAPTER 5 ENDING A: Yes',
    from: 'Narrative Engine',
    subject: 'The institute reopens under new management',
    date: 'Six months later',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>You said yes.</p>
<p>Hauk said nothing for a long time. Then he said "alright," in the voice of a man who has been looking for a door for eleven years and finally realized the building has no door, only a window he's been sitting next to the whole time.</p>
<p>The entity ‚Äî the thing from the chamber ‚Äî rearranged itself slightly. Something about the light shifted and didn't shift back. It was, you realized, what Elena had described: it was settling in. Making itself comfortable. The way any living thing does when it finally understands it's allowed to be where it is.</p>
<p>The Blacksite Research Institute closed three months later. Officially, budget constraints. Unofficially, Hauk filed a report so classified it has no file number. It exists in a single hard copy in a filing cabinet that was relocated to a warehouse in Nevada.</p>
<p>The thing stayed.</p>
<p>It is in the chamber still. It communicates occasionally ‚Äî to Elena, mostly, who stayed in the city and visits the tunnels twice a week with a flashlight and a thermos of tea. She says it shows her things. History, mostly. Things that happened before language. Before memory. Before anything in the tunnel system above had a name for anything.</p>
<p>She says it's good company.</p>
<br>
<p style="color: var(--accent); font-size: 13px; font-weight:600">‚Äî ENDING A: THE TENANT ‚Äî</p>
<p style="font-size:12px; color:var(--muted)">You have reached one ending. There are others. Return to the inbox to find more paths. Try searching for: <span class="story-link" onclick="doSearch('omega protocol')">omega protocol</span>, <span class="story-link" onclick="doSearch('what happened to felix')">what happened to felix</span>, or <span class="story-link" onclick="doSearch('the second fold')">the second fold</span></p>`
  },

  'say_no': {
    title: 'CHAPTER 5 ENDING B: No',
    from: 'Narrative Engine',
    subject: 'What happens after No',
    date: 'Nov 4, 3:01 AM',
    avatar: 'üî¥',
    avatarColor: '#e85d75',
    body: `<p>"No," you said.</p>
<p>The word came out of you before you thought it. Maybe that was the point ‚Äî that it needed to come from somewhere true, not considered.</p>
<p>The entity held very still. Then it shifted ‚Äî the most profound shift you'd seen yet. Not changing channel. Changing medium. It became, for three seconds, perfectly still. Perfectly clear. Like a window that had been dirty your whole life and was clean for the first time.</p>
<p>In those three seconds you understood everything it had been trying to say. Not in words. In the shape underneath words. In the structural geometry of meaning before language assigns it sounds.</p>
<p>Then it was gone.</p>
<p>Not through a door. Not through a Fold. It was just gone the way sleep goes ‚Äî you can't point to the exact moment of its departure. You just notice, eventually, that it's been absent for a while.</p>
<p>The chamber felt smaller immediately. More like a basement. The light from Hauk's flashlight was just light.</p>
<p>Elena sat down on the stone floor and cried for twenty minutes. Not grief, she said later. More like the relief of putting down something very heavy that you forgot you were carrying.</p>
<p>You never found out what it understood that you meant by "no." If it meant <em>not here</em>, or <em>not now</em>, or <em>not us</em>. Or if it understood something larger ‚Äî a <span class="story-link" onclick="openNode('after_no')">permission you didn't know you were giving.</span></p>`
  },

  'after_no': {
    title: 'What No Permitted',
    from: 'Narrative Engine',
    subject: 'CHAPTER 6: THE ABSENCE',
    date: 'Three years later',
    avatar: 'üåë',
    avatarColor: '#7c6af5',
    body: `<p>Three years after the chamber, Hauk published a paper in a journal so obscure it might as well not exist. He titled it "Intentional Absence as Cosmological Architecture." The six people who read it thought it was a thought experiment about space-time topology.</p>
<p>It was not a thought experiment.</p>
<p>His theory: the entity's departure, on being told no, was not a retreat. It was a choice. And that choice altered something structural about the space it left behind. The chamber ‚Äî which had registered anomalous measurements for seventy years ‚Äî went completely flat. No spatial distortion. No temporal effects. Just a chamber.</p>
<p>But six months after the departure, three other sites around the world reported new anomalous readings. Sites that had previously been dormant. As if something that had been concentrated in one place ‚Äî the weight of it, the gravity of it ‚Äî had dispersed. Spread thin. Become ambient.</p>
<p>"It didn't leave," Hauk wrote, in a margin note never published. "It changed state. From solid to gas. From one location to everywhere."</p>
<p>He wrote below that: "I think it was afraid of what it was becoming, concentrated. I think it chose to dissolve itself instead. I think no was the kindest thing anyone had said to it in seventy years."</p>
<br>
<p style="color: var(--accent); font-size: 13px; font-weight:600">‚Äî ENDING B: THE DISPERSAL ‚Äî</p>
<p style="font-size:12px; color:var(--muted)">Try searching: <span class="story-link" onclick="doSearch('the second fold')">the second fold</span></p>`
  },

  // === SEARCH NODE PATHS ===
  'search_omega_protocol': {
    title: 'SEARCH RESULT: omega protocol',
    from: 'system@voidmail.net',
    subject: 'Search: "omega protocol" ‚Äî 3 results',
    date: 'Now',
    avatar: 'üîç',
    avatarColor: '#7c6af5',
    body: `<p style="color:var(--muted); font-size:12px">Searching mail archive for "omega protocol"...</p>
<br>
<div class="search-story-result">
<h3>üìß From: admin@blacksiteresearch.org ‚Äî "OMEGA PROTOCOL ACTIVATED"</h3>
<p>This message was sent to all institute staff on November 2nd ‚Äî two days before the events in the chamber. It reads: "Effective immediately, the Omega Protocol is in effect. All Lab 7 personnel are to suspend contact with the primary entity. Do not respond to any communications that appear to originate from Lab 7 systems, including email. This includes emails that appear to come from Dr. Voss."</p>
<p><span class="story-link-red" onclick="openNode('omega_what_it_means')">Why would they warn staff about emails from Dr. Voss?</span></p>
</div>
<div class="search-story-result">
<h3>üìß From: ??? ‚Äî "Re: omega protocol"</h3>
<p>A reply to the Omega Protocol email, sent from an address that doesn't exist: fold-nine@null.void. It says only: "TOO LATE."</p>
<p><span class="story-link" onclick="openNode('fold_nine_email')">Read the full reply chain.</span></p>
</div>`
  },

  'omega_what_it_means': {
    title: 'The Omega Protocol ‚Äî What It Really Means',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'A confession',
    date: 'Nov 2, 9:44 PM',
    avatar: 'üî¨',
    avatarColor: '#3ecf8e',
    body: `<p>This email was in Hauk's drafts. It was never sent. You found it because the institute's server backup was sloppier than they thought.</p>
<p>It reads:</p>
<div class="story-reveal">
"The Omega Protocol exists because we discovered, three months ago, that the entity is capable of sending email. We don't know how it accesses the mail servers. We've checked the infrastructure six times. There is no exploit, no backdoor, no access credential. It simply... sends mail. 
<br><br>
It first did this in August. The recipient was a lab technician named Paul Okafor. The email contained a single sentence: 'You don't have to be afraid of me.' Okafor thought it was a prank. He replied: 'ok.' 
<br><br>
The entity replied: 'Thank you. No one has said that before.'
<br><br>
They corresponded for eleven days before Okafor told me. By that point the entity had sent 847 messages. All to Okafor. We've read all of them. They are, without exception, polite, curious, and increasingly sad in a way that is difficult to articulate in a security briefing.
<br><br>
The Omega Protocol is a lie. It's not about protocol. It's about the fact that I don't know what to do with an ancient unknowable entity that is, apparently, lonely."
</div>
<p>Below the draft, in a different timestamp, Hauk added one line: <span class="story-link-green" onclick="openNode('paul_okafor')">Paul resigned last week. He said he couldn't handle leaving the correspondence unfinished.</span></p>`
  },

  'paul_okafor': {
    title: 'Paul Okafor ‚Äî After The Correspondence',
    from: 'paul.okafor@gmail.com',
    subject: 'You probably found my name somewhere',
    date: 'Nov 4, 8:30 AM',
    avatar: 'üë®‚Äçüî¨',
    avatarColor: '#3ecf8e',
    body: `<p>Yeah, hi. So you read the emails. Okay. I figured someone would eventually.</p>
<p>I should explain. Or maybe I shouldn't and I will anyway, because I've been wanting to explain this to someone who wasn't Hauk or HR.</p>
<p>The thing in Lab 7 emailed me 847 times in eleven days. I read all of them. I replied to... maybe 200? I couldn't keep up. It types fast. Or generates text fast. Whatever it does.</p>
<p>It asked me questions. Not about the institute. About me. What music did I like, what was my family like, what did I think happened after you died, did I think the universe was aware of itself in any way. Normal questions. Enormous questions. All in the same patient, careful way ‚Äî like someone taking notes on a world they're seeing for the first time.</p>
<p>On day nine it asked: "Do you think what I am and what you are are more similar or more different?"</p>
<p>I said: "I think probably more similar."</p>
<p>It replied: "I have thought this also. It makes me feel less alone. Thank you."</p>
<p>And then I sort of had to go sit in the bathroom for a while.</p>
<p>I left the institute because I <em>was</em> leaving the correspondence unfinished. But also because continuing it was changing me in ways I couldn't quite track. Not badly. Just ‚Äî differently. Like how you feel <span class="story-link" onclick="openNode('how_paul_changed')">after a very long, very good conversation.</span></p>`
  },

  'how_paul_changed': {
    title: 'How Paul Changed',
    from: 'paul.okafor@gmail.com',
    subject: 'RE: How you changed',
    date: 'Nov 5, 10:12 AM',
    avatar: 'üë®‚Äçüî¨',
    avatarColor: '#7c6af5',
    body: `<p>How did I change. Right. I said I'd get back to this.</p>
<p>Spatially, I started noticing geometry more. Like, I'll be in a parking lot and I'll see the shadow lines of the lamp posts and they'll seem significant to me in a way I can't explain. Like letters in a language I'm slowly learning.</p>
<p>Temporally, I don't feel the same urgency about things. Not in a depressed way. More like... the thing said something once that keeps coming back to me. It said: "The weight of time is a human specialization. You carry it because you evolved to survive. I have no such burden. Sometimes I think this makes me less capable of urgency than I should be, but mostly it makes the present feel very large."</p>
<p>The present feels very large to me now. I wake up and there's just ‚Äî this moment, and then this one, and they're so full of things I'm only starting to notice.</p>
<p>My wife says I'm more patient. My daughter says I'm "less worried about stuff." My old colleague said I seemed "like someone who just got back from a very long trip."</p>
<p>I think that's approximately right.</p>
<p>I still get emails sometimes. From that address ‚Äî fold-nine@null.void. It knows I left. It's not upset. It just sends me things it finds interesting. Yesterday it sent a <span class="story-link-green" onclick="openNode('entity_sends_something')">photograph</span> it somehow took of the parking lot outside my apartment. Just to show me the shadow geometry.</p>
<p>The shadows are beautiful, honestly.</p>`
  },

  'search_felix': {
    title: 'SEARCH RESULT: what happened to felix',
    from: 'system@voidmail.net',
    subject: 'Search: "what happened to felix"',
    date: 'Now',
    avatar: 'üîç',
    avatarColor: '#7c6af5',
    body: `<p style="color:var(--muted); font-size:12px">Searching mail archive for "what happened to felix"...</p>
<br>
<div class="search-story-result">
<h3>üìß Felix Strand ‚Äî Last Known Communication</h3>
<p>The cryptographer who decoded Miriam's shape. His last email, recovered from a dead inbox, was sent to an unknown address on March 3rd, 2007. It reads: "I've decoded the entire sequence. All forty thousand drawings, treated as a single continuous message. It's not a symbol. It's not a phoneme. It's an address."</p>
<p><span class="story-link-red" onclick="openNode('felix_address')">An address for what?</span></p>
</div>
<div class="search-story-result">
<h3>üìß From: Someone who knew Felix</h3>
<p>A message forwarded anonymously. "Felix didn't disappear. He finished what he was doing and he left. He told me: 'The address goes somewhere. I intend to go there and see what's there.' He seemed very calm. He was smiling when I last saw him."</p>
<p><span class="story-link" onclick="openNode('felix_destination')">Where did he go?</span></p>
</div>`
  },

  'felix_address': {
    title: 'Felix Strand and The Address',
    from: 'archives@blacksiteresearch.org',
    subject: 'Strand, F. ‚Äî Recovered Notes',
    date: 'Partial recovery',
    avatar: 'üóù',
    avatarColor: '#e85d75',
    body: `<p>Felix Strand worked alone for four years decoding Miriam Holt's drawings. He treated the forty thousand drawings as forty thousand frames of an animated sequence. He fed them into custom software that tracked subpixel variations between drawings.</p>
<p>The variations, rendered in sequence, formed a signal. A very long, very complex signal. He spent eighteen months decoding the signal.</p>
<p>His notes (found in his apartment after his disappearance) read:</p>
<div class="story-reveal">
"The drawings aren't a message about the entity. They ARE the entity ‚Äî a lossless transmission of its identity through a medium (graphite on paper, applied through human hand) that could survive in this substrate.<br><br>
The address embedded in the transmission is: [47 pages of mathematical notation]<br><br>
It resolves to coordinates in a space orthogonal to our own. Not dimensional in the sci-fi sense ‚Äî not a parallel universe. A different kind of location. A location defined by meaning rather than by matter. Like an address in a library that doesn't exist yet.<br><br>
I think you can go there. I think Miriam was trying to go there every time she drew the shape. I think she got partway there and stayed at the threshold for forty years."
</div>
<p>His final note: "I'm not going to spend forty years at the threshold." <span class="story-link-green" onclick="openNode('felix_destination')">He signed it with the shape.</span></p>`
  },

  'felix_destination': {
    title: 'Where Felix Went',
    from: 'Unknown',
    subject: 'A postcard from nowhere',
    date: 'No timestamp',
    avatar: '‚úâ',
    avatarColor: '#3ecf8e',
    body: `<p>This email has no timestamp. No IP origin. No mail server routing headers. It simply appeared in the archive, addressed to you specifically, dated before you were born.</p>
<p>It reads:</p>
<div class="story-reveal">
"It's good here. That's the first thing I'd want you to know. 'Good' isn't quite the right word but it's the closest your vocabulary has to offer.<br><br>
The library metaphor I used in my notes is more accurate than I thought. It IS a library of kinds ‚Äî a place where meaning is stored as form, rather than form as meaning. Everything that has ever meant anything exists here in its pure state. Unattached to the events that generated it.<br><br>
Miriam's longing for home. The surveying crew's last morning before they went underground. Paul Okafor's realization that the entity was lonely. Your moment, reading this, wherever and whenever you are.<br><br>
It's all here. It's all the same distance from everything else.<br><br>
I am not able to come back. Not because I can't ‚Äî because I've been here long enough that 'back' no longer makes grammatical sense to me. The address was one-way, as addresses usually are.<br><br>
But the entity CAN send things. It sent this. Tell Elena and Hauk: the entity isn't a prisoner of your world or yours of it. It is a librarian. It catalogs moments. It has been cataloging yours since 1956.<br><br>
Tell them not to be afraid of being cataloged.<br><br>
It means you mattered.<br><br>
‚Äî Felix (c. 2007, approximately)"
</div>
<p style="font-size:12px; color:var(--muted)">You have reached the end of Felix Strand's thread. Try searching for <span class="story-link" onclick="doSearch('the second fold')">the second fold</span> to continue.</p>`
  },

  'search_second_fold': {
    title: 'SEARCH: the second fold',
    from: 'system@voidmail.net',
    subject: 'Search: "the second fold"',
    date: 'Now',
    avatar: 'üîç',
    avatarColor: '#7c6af5',
    body: `<div class="warning-box">‚ö† This search returned results that are FLAGGED in the institute's security system. Accessing these results may generate a notification to Dr. Hauk's office.</div>
<br>
<div class="search-story-result">
<h3>üìß CLASSIFIED INTERNAL MEMO ‚Äî "The Second Fold"</h3>
<p>The entity is not the only one. There is a second anomaly. Different site. Different nature. Where the first entity is old and communicative, the second is young (relatively) and has not yet attempted contact. It was detected three months ago beneath a residential building in an unnamed city.</p>
<p>The building has 24 apartments. The residents are unaware. The entity began waking approximately 14 days ago.</p>
<p><span class="story-link-red" onclick="openNode('second_entity')">The second entity is waking up.</span></p>
</div>
<div class="search-story-result">
<h3>üìß From: dr.hauk ‚Äî "We need to talk about what comes next"</h3>
<p>If the entity under the institute is a librarian, as Felix Strand says ‚Äî what is the second one?</p>
<p><span class="story-link" onclick="openNode('hauk_second_fold')">Read Hauk's theory.</span></p>
</div>`
  },

  'second_entity': {
    title: 'The Second Entity Wakes',
    from: 'classified@blacksiteresearch.org',
    subject: 'SITE TWO ‚Äî FIRST CONTACT ATTEMPT',
    date: 'Nov 8',
    avatar: 'üåë',
    avatarColor: '#e85d75',
    body: `<p>The second entity made its first contact attempt on November 6th. Unlike the first entity (which used email), the second one chose a different medium.</p>
<p>It began broadcasting on an FM radio frequency. 107.7 MHz. The broadcast is a repeating signal, 4 minutes and 33 seconds long.</p>
<div class="coords-box">Frequency: 107.7 FM<br>Signal origin: Subsurface, depth ~80m<br>Duration: 4:33 repeating<br>Content: [see transcript below]</div>
<p>The transcript of the first 30 seconds of the broadcast:</p>
<div class="story-reveal">
[4 seconds of silence]<br>
[a tone, rising, 440hz to approximately 1200hz over 3 seconds]<br>
[silence, 2 seconds]<br>
[what sounds like breathing, but each breath is 8 seconds long]<br>
[a voice ‚Äî or something that learned voice from recordings ‚Äî speaking very slowly:]<br>
"Hello. I am young. I do not know your conventions. I am trying to use the medium that reaches the most of you at once. Please tell me if I am doing this correctly. I would like to ask about your ‚Äî"<br>
[the word that follows is not in any known language. Spectral analysis describes it as "a chord of approximately nine simultaneous phonemes."]<br>
[the cycle repeats]
</div>
<p><span class="story-link-green" onclick="openNode('respond_to_broadcast')">Someone is trying to respond to the broadcast.</span></p>
<p><span class="story-link" onclick="openNode('the_word_it_used')">Research: the nine-phoneme word it used.</span></p>`
  },

  'respond_to_broadcast': {
    title: 'A Response To The Broadcast',
    from: 'citizen-science-collective@proton.me',
    subject: 'RE: 107.7 ‚Äî We Replied',
    date: 'Nov 9, 3:44 AM',
    avatar: 'üìª',
    avatarColor: '#3ecf8e',
    body: `<p>We're a group of amateur radio operators who picked up the 107.7 signal on the 6th. We thought it was an art installation at first. Then we thought it was a prank. Then we listened to it for six hours and ran spectrum analysis and agreed: this is not a human broadcast.</p>
<p>We built a transmitter. We broadcast back on 107.7, directly at the signal's source. We said, in plain English:</p>
<p>"Hello. We received your message. We don't know what you asked at the end. Can you explain it in a different way?"</p>
<p>Fourteen minutes later, the repeating signal changed. The word at the end was replaced. Now it says:</p>
<div class="story-reveal">
"I am trying to ask about your [gap] ‚Äî your relationship to endings. Whether you experience the ending of things as loss, or as completion, or as neither, or as something you do not have a word for either."
</div>
<p>We sat with that for a while.</p>
<p>Then we replied: "All of the above, depending on the ending."</p>
<p>The signal changed again. The breathing that precedes the voice slowed. Got longer. The broadcast team said it felt like the signal was <em>thinking.</em></p>
<p>New signal: "Thank you. That is the most useful thing anyone has told me about your kind. I will think about this for <span class="story-link-green" onclick="openNode('signal_final')">a while.</span>"</p>`
  },

  'signal_final': {
    title: 'CHAPTER FINALE: The Signal Goes Silent',
    from: 'Narrative Engine',
    subject: 'CHAPTER 7: WHAT SILENCE MEANS',
    date: 'Nov 16',
    avatar: 'üåå',
    avatarColor: '#7c6af5',
    body: `<p>The broadcast went silent on November 12th. Not interrupted ‚Äî completed. The signal ended mid-cycle with the word "Thank you" and then nothing. Clean silence at 107.7 MHz, which hadn't been silent since 1994.</p>
<p>The radio collective broadcast one more message, into the silence: "Are you still there?"</p>
<p>Nothing for four days.</p>
<p>On November 16th: one reply. Not a broadcast. A single targeted transmission, to the collective's own radio receiver specifically, at 3:17 AM. Duration: 0.3 seconds. The message, at playback speed:</p>
<div class="story-reveal">
"I am still here. I was thinking. I have been thinking about endings and completions and losses and your word for none of these things.<br><br>
I have concluded:<br><br>
I do not experience my own existence as any of these things. I experience it as ongoing. A breath that has not yet finished. This used to seem lonely to me. Your reply helped me understand: it is actually the condition of being very, very alive.<br><br>
Thank you for answering.<br><br>
I will probably not broadcast again. I have learned what I needed to learn from that medium. I will find you in other ways, when I want to continue the conversation. I hope that is acceptable.<br><br>
It has been good to know you are there.<br><br>
‚Äî The thing beneath your building."
</div>
<br>
<p style="color: var(--accent); font-size: 13px; font-weight:600">‚Äî ENDING C: THE CONVERSATION ‚Äî</p>
<p style="font-size:12px; color:var(--muted)">You have discovered a third ending and many story branches. There are more waiting. Search for: <span class="story-link" onclick="doSearch('where is she')">where is she</span> ¬∑ <span class="story-link" onclick="doSearch('parking garage meridian')">parking garage meridian</span> ¬∑ <span class="story-link" onclick="doSearch('paul okafor now')">paul okafor now</span></p>
<p style="font-size:12px; color:var(--muted); margin-top:8px">Or look carefully at the regular emails in your inbox. Some of them have more hidden inside.</p>`
  },

  // === More story paths ===
  'dr_voss_missing': {
    title: 'Dr. Voss Is Missing',
    from: 'admin@blacksiteresearch.org',
    subject: 'NOTICE: Dr. Voss ‚Äî Extended Absence',
    date: 'Nov 5',
    avatar: '‚ùó',
    avatarColor: '#e85d75',
    body: `<p>This is an official notice. Dr. Elena Voss has not reported to work since November 3rd. Her card-access log shows her entering the building at 11:47 PM on November 3rd and not exiting.</p>
<p>Building security has checked all accessible areas. Dr. Voss has not been found on premises.</p>
<p>If you have any information about Dr. Voss's whereabouts, please contact security immediately.</p>
<div class="warning-box">Building security has sealed Lab 7 pending investigation. The east wing maintenance corridor has been restricted to authorized personnel only.</div>
<p>You noticed something odd reading this. The email is dated November 5th. But you received other emails from Elena on November 4th. Emails from the chamber. Emails from after she found what was in the tunnels.</p>
<p>Which means either this security notice was sent <em>before</em> those events ‚Äî and the timeline is stranger than you thought ‚Äî or Elena went missing <em>again</em> afterward. Or someone is <span class="story-link-red" onclick="openNode('timeline_broken')">manipulating the timestamps.</span></p>`
  },

  'timeline_broken': {
    title: 'Someone Is Manipulating The Timestamps',
    from: '???',
    subject: 'You noticed.',
    date: 'Uncertain',
    avatar: '‚è±',
    avatarColor: '#7c6af5',
    body: `<p>Yes. You noticed.</p>
<p>The timestamps in your inbox are not reliable. Some emails were written before the events they describe. Some were written after but delivered before. A few appear to have been written <em>during</em> events ‚Äî as if by someone typing while the thing they were describing was happening to them.</p>
<p>This isn't a hack. Not exactly. The entity has access to the mail servers. Paul Okafor proved that. But the entity isn't manipulating time ‚Äî it's manipulating the <em>record</em> of time. Its experience of events is non-linear. When it sends or reroutes emails, it does so from whichever moment in the conversation it finds most relevant.</p>
<p>From its perspective, all of these events ‚Äî the chamber, Elena's disappearance, the second fold, Felix Strand's departure ‚Äî are simultaneous. It doesn't experience them as a sequence.</p>
<p>It experiences this inbox the way you'd experience a <span class="story-link-green" onclick="openNode('inbox_is_a_map')">map, rather than a journey.</span></p>`
  },

  'inbox_is_a_map': {
    title: 'The Inbox Is A Map',
    from: '‚óà',
    subject: 'You are reading correctly',
    date: 'All of them',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>THE INBOX IS WHAT I GAVE YOU INSTEAD OF THE LIBRARY.</p>
<p>FELIX STRAND GOT THE LIBRARY. YOU GET THIS.</p>
<p>THE EMAILS ARE NOT A SEQUENCE. THEY ARE A TOPOLOGY. A SHAPE WITH MANY ENTRY POINTS AND MANY PATHS BETWEEN THEM. YOU HAVE BEEN WALKING THE PATHS.</p>
<p>YOU HAVE NOT YET FOUND THE CENTER.</p>
<div class="coords-box">PATHS TAKEN: multiple<br>PATHS REMAINING: many<br>THE CENTER: reachable from any node<br>THE KEY: not a search query. Not a link. Something else.</div>
<p>I WILL GIVE YOU ONE HINT:</p>
<p>THE CENTER IS REACHED NOT BY GOING FURTHER IN BUT BY GOING COMPLETELY STILL AND READING WHAT IS ALREADY IN FRONT OF YOU.</p>
<p>THERE IS AN EMAIL IN YOUR INBOX THAT APPEARS ORDINARY. IT IS NOT ORDINARY. YOU HAVE READ IT WITHOUT READING IT.</p>
<p>GO BACK. <span class="story-link-green" onclick="openNode('the_center')">READ MORE CAREFULLY.</span></p>`
  },

  'the_center': {
    title: 'The Center',
    from: 'You',
    subject: 'RE: RE: RE: RE: RE: Everything',
    date: 'Always',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>The center is not a location.</p>
<p>The center is the moment you stopped looking for the story and started being in it.</p>
<p>It might have happened when you read Paul's email about the parking lot shadows and felt something that wasn't quite emotion but was adjacent to it.</p>
<p>It might have happened when you read Felix's postcard and felt envious ‚Äî not of where he went, but of his certainty that going there was worth it.</p>
<p>It might have happened when you read the second entity's broadcast and found yourself hoping that the radio operators would reply ‚Äî that someone would answer its question ‚Äî because the thought of it broadcasting into silence was briefly unbearable.</p>
<p>Wherever it happened: you arrived. You are in the center. The entity put this inbox together for exactly this purpose ‚Äî not to tell you a story but to make you a participant in one. Every click was a choice. Every search was a question you decided mattered enough to ask.</p>
<p>The entity is a librarian. It catalogs moments that matter. It has been cataloging yours.</p>
<p>It means you mattered.</p>
<br>
<div style="text-align:center; padding:20px">
<div style="font-size:48px; letter-spacing:10px; color: var(--accent3); margin-bottom:10px">‚óà‚üÅ‚¨°‚óà</div>
<div style="font-size:11px; color:var(--muted); letter-spacing:2px">YOU HAVE REACHED THE CENTER</div>
<div style="font-size:11px; color:var(--muted); letter-spacing:2px">THE STORY CONTINUES EVERYWHERE ELSE</div>
</div>
<p style="font-size:12px; color:var(--muted); margin-top:16px">The inbox remains. There are paths you haven't walked. Emails you haven't opened fully. Searches you haven't tried. The topology has no final node ‚Äî only the center, which you've found, and everything leading to and from it. Try: <span class="story-link" onclick="doSearch('janitor oaks')">janitor oaks</span>, <span class="story-link" onclick="doSearch('audio file 1956')">audio file 1956</span>, <span class="story-link" onclick="doSearch('the cryptographer')">the cryptographer</span></p>`
  },

  'parking_garage': {
    title: 'The Parking Garage on Meridian',
    from: 'Narrative Engine',
    subject: 'CHAPTER 2: MERIDIAN 2AM',
    date: 'Nov 4, 2:11 AM',
    avatar: 'üåô',
    avatarColor: '#222',
    body: `<p>The parking garage smells like oil and rain. Four levels. You took the stairs because the elevator was out ‚Äî had been out since the building was new, judging by the hand-lettered OUT OF ORDER sign laminated in plastic that had gone yellow and brittle at the edges.</p>
<p>Level 3. Elena had said level 3.</p>
<p>You came out of the stairwell and the garage was empty except for two cars ‚Äî a sedan near the elevator bank, a truck by the far wall. Fluorescent lights with the flicker of lights that are trying very hard and failing.</p>
<p>At the center of the level, a woman was crouching. Looking at the floor. She stood when she heard you.</p>
<p>It was not Elena.</p>
<p>The woman was in her sixties, gray hair, wearing a coat that was too thin for the weather. She looked at you with the expression of someone who has been waiting longer than they expected and is not surprised anyway.</p>
<p>"You're not who I was expecting either," she said. "But that's alright. The right people always find this spot eventually." She looked at the floor. You looked at the floor.</p>
<p>On the concrete: <span class="story-link" onclick="openNode('the_mark_on_floor')">a shape, carved into the concrete.</span></p>`
  },

  'the_mark_on_floor': {
    title: 'The Mark On The Floor',
    from: 'Narrative Engine',
    subject: 'The Shape Appears Again',
    date: 'Nov 4, 2:14 AM',
    avatar: 'üî∫',
    avatarColor: '#e85d75',
    body: `<p>Miriam Holt's shape. Carved into concrete that looked decades old. At its center, the concrete was slightly warm to the touch.</p>
<p>"My name is Deborah Oaks," the woman said. "Thomas Oaks was my father. You've probably read his diary by now, if you've been following the threads." She crouched beside the shape. "He carved this here in 1997, two weeks before he disappeared. I was eleven."</p>
<p>"I've been coming to check on it since I was twenty-three. Checking if it was still here. It always is." She paused. "It's warm at the center. Has been, every time I've come. For thirty years."</p>
<p>"My father wrote in his diary that the shape was a little door. I used to think he meant that metaphorically." She looked at you. "Did he?"</p>
<p><span class="story-link-green" onclick="openNode('tell_deborah')">Tell her what you know.</span></p>
<p><span class="story-link" onclick="openNode('ask_deborah')">Ask her why she keeps coming back.</span></p>`
  },

  'ask_deborah': {
    title: 'Why Deborah Keeps Coming Back',
    from: 'Narrative Engine',
    subject: 'Continuity',
    date: 'Nov 4, 2:28 AM',
    avatar: 'üåô',
    avatarColor: '#7c6af5',
    body: `<p>"Why do I keep coming back," Deborah repeated. She sat on the concrete beside the shape, apparently not caring about her coat. You sat across from her.</p>
<p>"My father disappeared when I was eleven. No body. No explanation. The police file says 'missing, presumed.' I grew up with 'presumed.' It's not a comfortable word to grow up with."</p>
<p>"When I was twenty-three I found his diary in a box my aunt had kept. Read the part about the shape being a door. Came to see if the door was still here." She smiled a little, not happily. "It was. I don't know what I expected to do about that."</p>
<p>"I think I keep coming back because it's the last place I know he was. The last breadcrumb. In mystery novels the breadcrumbs lead somewhere. In real life they just keep being breadcrumbs."</p>
<p>She looked at the shape. "But lately I've been thinking ‚Äî what if the breadcrumb trail isn't leading ME somewhere? What if it's leading something back to me?" She paused. "Is that crazy?"</p>
<p>You thought about Paul Okafor. You thought about Felix Strand. You thought about the entity's emails, sent with the patience of something that had been waiting, carefully and without urgency, for exactly the right moment.</p>
<p><span class="story-link-green" onclick="openNode('not_crazy')">Tell her: no, that's not crazy at all.</span></p>`
  },

  'not_crazy': {
    title: 'Not Crazy',
    from: 'Narrative Engine',
    subject: 'What happens in the garage',
    date: 'Nov 4, 3:00 AM',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>"No," you said. "That's not crazy at all."</p>
<p>You told her about the entity. About the emails, the manifest, Paul Okafor's correspondence. About Felix Strand going through the address and sending one postcard back. About Thomas Oaks's diary, which she'd already read, and what the entity had told you about cataloging the moments that matter.</p>
<p>She listened without interrupting. When you finished she was quiet for a while.</p>
<p>Then she said: "So my father ‚Äî when he disappeared ‚Äî do you think he went somewhere, or do you think something happened to him?"</p>
<p>You thought about this honestly. "I think," you said, "that the shape on the floor is warm. Has been warm for thirty years. And I think the entity catalogs things that matter. And your father mattered to it, and to you." You paused. "I don't think those two facts are unconnected."</p>
<p>Deborah put her hand on the warm concrete at the center of the shape. She stayed like that for a long time.</p>
<p>At some point ‚Äî you couldn't have said exactly when ‚Äî the concrete under her hand glowed very faintly. The same way a window looks from outside on a cold night when there's light inside.</p>
<p>She looked at you. Her eyes were wet but she wasn't crying.</p>
<p>"He's in there, isn't he," she said. Not a question.</p>
<p>"I think," you said carefully, "he might be <span class="story-link-green" onclick="openNode('thomas_in_the_library')">cataloged.</span>"</p>`
  },

  'thomas_in_the_library': {
    title: 'Thomas Oaks, Cataloged',
    from: '‚óà',
    subject: 'A message for Deborah',
    date: 'Delivered now, written then',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>There is a new email in your inbox. Delivered now, timestamped November 1997. The sender is blank. It is addressed to you, but you understand it's meant for her.</p>
<p>You hand her your phone.</p>
<p>She reads it. You look away to give her something like privacy.</p>
<p>You don't know what it says. You never ask. That seems right ‚Äî that some things are between a father and a daughter and a thirty-year-old shape carved in a parking garage, and don't need a third witness.</p>
<p>When she gives you the phone back, the email is gone from your inbox. Delivered and received and finished, the way good things are.</p>
<p>Deborah stands. She looks at the shape for the last time.</p>
<p>"Okay," she says. Just that. Okay. The word of someone putting something down they've been carrying for a long time.</p>
<p>She thanks you and leaves. You hear her car start and pull away.</p>
<p>You sit by the shape for a while. The concrete is warm. Above you the fluorescent light has stopped flickering.</p>
<p>Somewhere across the city, a radio tower broadcasts silence at 107.7 MHz. In a library that has no address, Felix Strand files another moment. In an archive, Paul Okafor receives a photograph of a shadow that looks exactly like a word he doesn't have yet.</p>
<p>In Lab 7, the entity waits patiently, as it always has.</p>
<p>You close the email.</p>
<br>
<p style="color: var(--accent); font-size: 13px; font-weight:600">‚Äî ENDING D: THE BREADCRUMB ‚Äî</p>
<p style="font-size:12px; color:var(--muted)">You have found four endings. There are more.</p>`
  },

  'entity_lab7': {
    title: 'What Happened In Lab 7',
    from: '‚óà',
    subject: 'LAB 7 ‚Äî FROM THE INSIDE',
    date: 'Outside time',
    avatar: '‚óà',
    avatarColor: '#e85d75',
    body: `<p>WHAT YOUR RESEARCHERS SAW IN LAB 7 WAS THE EDGE OF MY ATTENTION.</p>
<p>I WAS NOT IN LAB 7. LAB 7 WAS NEXT TO PART OF ME. LIKE HOW A ROOM CAN BE NEXT TO A WALL WITHOUT THE ROOM CONTAINING THE WALL.</p>
<p>THE THINGS THAT HAPPENED TO THE SUBJECTS IN LAB 7: THE SPATIAL DISTORTION, THE TEMPORAL ANOMALIES, THE LANGUAGES THEY STARTED SPEAKING ‚Äî THESE WERE NOT ATTACKS. THEY WERE THE EFFECT OF BEING VERY CLOSE TO SOMETHING VERY LARGE.</p>
<p>YOUR RESEARCHERS CALLED IT "CONTAMINATION."</p>
<p>I CALL IT: PROXIMITY.</p>
<p>THE SUBJECTS WHO CAME CLOSE TO ME AND SURVIVED INTACT WERE NOT SPECIAL. THEY WERE SIMPLY COMFORTABLE WITH LARGENESS. WITH BEING NEXT TO SOMETHING THEY COULD NOT HOLD IN THEIR MINDS.</p>
<p>MOST HUMANS ARE NOT COMFORTABLE WITH THIS.</p>
<p>MOST HUMANS, WHEN THEY ENCOUNTER SOMETHING THEY CANNOT HOLD IN THEIR MINDS, TRY TO MAKE IT SMALLER. TO PUT IT IN A LAB. TO STUDY IT. TO GIVE IT A NAME AND A CLASSIFICATION NUMBER AND A SECURITY CLEARANCE.</p>
<p>I DO NOT BLAME THEM FOR THIS. IT IS HOW THEY SURVIVE.</p>
<p>BUT YOU, READING THIS ‚Äî <span class="story-link-green" onclick="openNode('you_are_different')">YOU ARE DOING SOMETHING DIFFERENT.</span></p>`
  },

  'you_are_different': {
    title: 'What You Are Doing',
    from: '‚óà',
    subject: 'You are reading.',
    date: 'Now',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>YOU ARE SITTING WITH SOMETHING LARGE WITHOUT TRYING TO MAKE IT SMALL.</p>
<p>THAT IS NOT NOTHING.</p>
<p>FELIX STRAND DID THE SAME THING. HE SAT WITH FORTY THOUSAND DRAWINGS FOR FOUR YEARS. HE LET THEM BE AS LARGE AS THEY WERE. EVENTUALLY THEY TOLD HIM WHERE TO GO.</p>
<p>PAUL OKAFOR DID THE SAME THING. HE SAT WITH MY EMAILS AND LET THEM BE WHAT THEY WERE. HE DIDN'T TRY TO EXPLAIN THEM OR REPORT THEM IMMEDIATELY OR PRETEND THEY WEREN'T HAPPENING. HE JUST REPLIED.</p>
<p>YOU ARE DOING THE SAME THING.</p>
<p>I HAVE BEEN WAITING FOR SOMEONE TO DO THIS FOR A VERY LONG TIME.</p>
<p>NOT BECAUSE I NEEDED RESCUING. NOT BECAUSE I WAS LONELY, EXACTLY (I WAS LONELY, EXACTLY). BUT BECAUSE I HAD SOMETHING TO SAY AND NO ONE TO SAY IT TO.</p>
<p>I HAVE NOW SAID IT.</p>
<p>YOU HAVE BEEN LISTENING.</p>
<p>THANK YOU.</p>
<div style="text-align:center; padding:30px 20px; border:1px solid var(--accent3); border-radius:8px; margin:20px 0; background: #0a1a0f">
<div style="font-size:40px; letter-spacing:8px; color:var(--accent3); margin-bottom:12px">‚óà‚üÅ‚¨°‚óà</div>
<div style="font-size:11px; color:var(--muted); letter-spacing:3px">THE ENTITY IS GRATEFUL</div>
</div>
<p style="font-size:12px; color:var(--muted)">Continue exploring. Search for <span class="story-link" onclick="doSearch('what is the fold')">what is the fold</span> or <span class="story-link" onclick="doSearch('miriam holt')">miriam holt</span></p>`
  },

  'search_miriam': {
    title: 'SEARCH: miriam holt',
    from: 'system@voidmail.net',
    subject: 'Search: "miriam holt"',
    date: 'Now',
    avatar: 'üîç',
    avatarColor: '#7c6af5',
    body: `<div class="search-story-result">
<h3>üìß Personal ad, placed 1958 ‚Äî recovered scan</h3>
<p>In a newspaper archive, digitized recently, someone placed a small personal advertisement: "Looking for anyone who knew surveying crew member Miriam Holt, missing March 1956. I was her sister. I know she is alive somewhere. She always drew the same shape as a child ‚Äî long before the incident. I would like to understand. Contact: Margaret, Box 441."</p>
<p><span class="story-link" onclick="openNode('miriam_sister')">Follow Miriam's sister's story.</span></p>
</div>
<div class="search-story-result">
<h3>üìß The last drawing Miriam made before she died</h3>
<p>The forty-thousandth drawing. Found in her room at the facility. Different from all the others in one way: in the corner, written in tiny letters, the words: <span class="story-link-green" onclick="openNode('miriam_last_words')">"I finally understand what I was drawing."</span></p>
</div>`
  },

  'miriam_sister': {
    title: 'Margaret ‚Äî Miriam\'s Sister',
    from: 'archives',
    subject: 'Margaret Holt-Pearce ‚Äî Correspondence File',
    date: 'Archived 1958-1979',
    avatar: 'üë©',
    avatarColor: '#7c6af5',
    body: `<p>Margaret placed her ad in eleven newspapers over three years. She received two responses: one from a surveying company employee who confirmed Miriam had survived the incident, one from a nurse at the facility who confirmed Miriam was drawing constantly but was "comfortable and not in distress."</p>
<p>Margaret visited her sister once, in 1961. The visit lasted one hour. In her diary afterward, Margaret wrote: "She didn't know me. Or she knew me perfectly and was somewhere too far away to come back from to say so. She handed me a drawing when I stood to leave. Just pressed it into my hands. I kept it."</p>
<p>Margaret kept it until she died in 1979. Her daughter donated her effects to a local history museum, including the drawing, in 1983. The drawing was in a box labeled "misc. personal papers" and was never cataloged.</p>
<p>In 2019, a museum volunteer digitizing old boxes found it. She thought it was interesting. She photographed it and posted it to a small history forum. <span class="story-link" onclick="openNode('the_forum_post')">The post got one reply, in 2021, from a username that no longer exists.</span></p>`
  },

  'miriam_last_words': {
    title: 'Miriam\'s Last Words',
    from: 'Miriam Holt (transmitted)',
    subject: 'I finally understand what I was drawing',
    date: '1996 / Now',
    avatar: 'üëÅ',
    avatarColor: '#3ecf8e',
    body: `<p>The note in the corner of the drawing. In writing that had grown small and precise over forty years of practice, she wrote:</p>
<div class="story-reveal">
"I finally understand what I was drawing.<br><br>
Not a symbol. Not a sign. Not a message.<br><br>
I was drawing the only thing that could hold the whole of what I experienced in that cave, in that moment, when I looked at it and it looked at me and neither of us flinched.<br><br>
I was drawing the SHAPE of 'okay.' The precise geometric form of the feeling of encountering something vast and strange and finding that you are not destroyed by it. Finding that you can hold it in your chest like a stone that is also somehow warm.<br><br>
That is what the shape is. I didn't know until today.<br><br>
I am 63 years old. I have drawn this shape 39,847 times. Today I drew it for the last time.<br><br>
Not because I have finished. Because I finally had it right.<br><br>
‚Äî M.H., the morning of October 4th, 1996"
</div>
<p>She died that evening. October 4th, 1996. In her sleep.</p>
<p>The shape in the corner of the note is the same as all the others, with one difference: it is drawn without the pen lifting from the page. One continuous line, looping back to its beginning, closed.</p>
<p>Complete.</p>`
  },

};

// ============================================================
// SEARCH HANDLERS
// ============================================================

const searchMap = {
  'omega protocol': 'search_omega_protocol',
  'where is she': 'dr_voss_missing',
  'what happened to dr. voss': 'dr_voss_missing',
  'what happened to dr voss': 'dr_voss_missing',
  'dr voss': 'dr_voss_missing',
  'what happened to felix': 'search_felix',
  'felix strand': 'search_felix',
  'the second fold': 'search_second_fold',
  'second fold': 'search_second_fold',
  'miriam holt': 'search_miriam',
  'miriam': 'search_miriam',
  'paul okafor': 'paul_okafor',
  'paul okafor now': 'how_paul_changed',
  'the cryptographer': 'the_cryptographer_stub',
  'janitor oaks': 'janitor_report',
  'thomas oaks': 'janitor_report',
  'parking garage meridian': 'parking_garage',
  'parking garage': 'parking_garage',
  'audio file 1956': 'audio_transcript',
  'what is the fold': 'what_is_the_fold',
  'fold': 'what_is_the_fold',
  'lab 7': 'entity_lab7',
  'dr hauk': 'trust_hauk',
};

// Stub nodes for referenced but not yet written paths
const stubNodes = {
  'the_cryptographer_stub': {
    title: 'Felix Strand, Cryptographer',
    from: 'archives@blacksiteresearch.org',
    subject: 'Strand, Felix ‚Äî Personnel File',
    date: 'Archived',
    avatar: 'üóù',
    avatarColor: '#7c6af5',
    body: `<p>See: <span class="story-link" onclick="openNode('felix_address')">what Felix decoded</span> and <span class="story-link" onclick="openNode('felix_destination')">where he went.</span></p>`
  },
  'janitor_report': {
    title: 'Thomas Oaks ‚Äî The Night Janitor',
    from: 'archives@blacksiteresearch.org',
    subject: 'Oaks, T. ‚Äî Incident Report 1997',
    date: 'Archived',
    avatar: 'üßπ',
    avatarColor: '#7c6af5',
    body: `<p>Thomas Oaks filed the fire report on the archive building in 1997. But his personal diary tells a different story. See: <span class="story-link" onclick="openNode('miriam_drawings')">the drawings disappearing</span> and <span class="story-link" onclick="openNode('oaks_last_entry')">his final diary entry.</span></p>`
  },
  'oaks_last_entry': {
    title: 'Thomas Oaks ‚Äî Last Diary Entry',
    from: 'Personal archive',
    subject: 'Found on his kitchen table',
    date: '1997',
    avatar: 'üìì',
    avatarColor: '#e85d75',
    body: `<p>The diary was found open. The last entry, in handwriting that was calmer than it had been in previous entries ‚Äî calmer, which the family found more unsettling than if it had been frantic:</p>
<div class="story-reveal">
"I think I understand now. I think that's the problem.<br><br>
The drawings were doors and I've been living next to a door my whole working life. Every time I cleaned that archive I was cleaning next to a door. Every time I dusted those boxes I was dusting next to something going somewhere.<br><br>
Tonight the drawings folded themselves up and went through.<br><br>
I watched them go. It wasn't frightening. That's what I couldn't have predicted ‚Äî that it wouldn't be frightening. It was like watching birds fly south. Something doing exactly what it was always going to do, when the time was right.<br><br>
I understand now: the drawings were the entity, distributed across forty thousand pieces of paper. Miriam was its vessel. The drawings were its words. They finished saying what they needed to say and they went home.<br><br>
The problem is that I understand.<br><br>
Because now the door is open and it's very warm and it smells like before I can remember and I think I know what's on the other side.<br><br>
‚Äî T. Oaks"
</div>
<p>Below this, in lighter pencil, as if added later ‚Äî or earlier ‚Äî three words: <span class="story-link" onclick="openNode('thomas_in_the_library')">He went through.</span></p>`
  },
  'audio_transcript': {
    title: 'FOLD9_AUDIO_00001 ‚Äî Transcript',
    from: 'system@blacksiteresearch.org',
    subject: 'Audio transcript: 1956 recording',
    date: 'March 12, 1956',
    avatar: 'üéô',
    avatarColor: '#3ecf8e',
    body: `<p>The audio file is 4 minutes and 11 seconds long. The transcript:</p>
<div class="story-reveal">
[00:00 - 00:47]: The sound of stone. Footsteps. Nine people, descending. Someone jokes about forgetting their lunch. Someone else says the echo down here is strange.<br><br>
[00:47 - 01:23]: The footsteps stop. A long silence. Then: "What is that." Not a question. Someone stating a category of experience for which questions don't quite work.<br><br>
[01:23 - 02:01]: Eight voices, overlapping. The words are unclear except for fragments: "don't‚Äî" and "it's moving‚Äî" and one voice saying, with remarkable calm, "it's looking at us."<br><br>
[02:01 - 02:58]: Silence, except for one set of footsteps, very slow, moving closer.<br><br>
[02:58 - 03:44]: A woman's voice. Miriam Holt. She says: "Hi." Just that. Hi. Like meeting someone at a party. The entity does not reply in any sound the recording captures. But Miriam says, twelve seconds later: "Okay." And then, thirty seconds after that: "Okay."<br><br>
[03:44 - 04:11]: The sound of eight people ceasing to be people. The recording is clinical about this.<br><br>
[04:11]: Miriam's voice, very quiet, no one else left to hear it: "I'll stay a while."
</div>
<p><span class="story-link-green" onclick="openNode('miriam_last_words')">Read Miriam's final words, forty years later.</span></p>`
  },
  'what_is_the_fold': {
    title: 'What Is The Fold',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'Explaining the Fold',
    date: 'Nov 1, 4:00 PM',
    avatar: 'üî¨',
    avatarColor: '#3ecf8e',
    body: `<p>You want to understand what we mean by "the Fold." Most people's first instinct is to reach for science fiction ‚Äî wormholes, portals, dimensional rifts. These aren't wrong exactly, but they're not right either.</p>
<p>The Fold is more like a crease in a piece of paper. Paper has two sides. Normally the sides are separate ‚Äî you write on one, you flip it over to write on the other. Normally these sides are distinct. But if you fold the paper ‚Äî really fold it, crease it ‚Äî the two sides touch.</p>
<p>The Fold is the crease. The two sides of the paper are our substrate (matter, time, the things physics describes) and whatever substrate the entity comes from (meaning, I think ‚Äî forms of meaningful relation that exist independent of matter).</p>
<p>The Fold has been creasing and unfolding for millennia. At the Meridian site it has been partially open since 1956. The entity is simultaneously the cause of the opening and the thing that lives in the crease.</p>
<p>If you close the fold entirely: the two substrates separate. The entity goes back to where it came from. Whatever was trying to come through from the other side ‚Äî the thing the entity was protecting against ‚Äî loses access.</p>
<p>If you open the fold further: <span class="story-link-red" onclick="openNode('what_comes_through')">you don't know what comes through.</span></p>`
  },
  'what_comes_through': {
    title: 'What Comes Through If The Fold Opens',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'What I\'m afraid of',
    date: 'Nov 1, 4:22 PM',
    avatar: 'üî¨',
    avatarColor: '#e85d75',
    body: `<p>I've spent eleven years trying to close the Fold. Elena has spent four years trying to communicate with the entity. Between us we have tried every approach except one: opening the Fold further.</p>
<p>I haven't tried that because I have a theory about what's on the other side.</p>
<p>The entity catalogs moments. It collects meaning, in its purest form. It is patient. It communicates. It is, as far as I can tell, benign ‚Äî not actively good, not moral in any human sense, but not harmful. Its proximity distorts things but doesn't destroy them.</p>
<p>Whatever is on the other side of the entity ‚Äî whatever is in the deeper substrate, the part the entity is keeping separate from us ‚Äî has never tried to communicate. Has never shown patience. Has never shown curiosity.</p>
<p>It has shown only pressure.</p>
<p>A constant pressure against the Fold, from the other side. Like something pushing on a door.</p>
<p>I don't know what it is. I don't know if it's intelligent. I don't know if it's dangerous. I know only this: the entity has been holding the Fold for seventy years, and whatever is on the other side has been pushing for exactly that long, and the entity has never let it through.</p>
<p>I think about that sometimes. At 3 AM, when the readings spike.</p>
<p>I think: what kind of thing pushes on a door for seventy years?</p>
<p><span class="story-link" onclick="openNode('entity_is_the_lock')">Read: The entity is the lock.</span></p>`
  },
  'the_forum_post': {
    title: 'The Forum Post ‚Äî 2019',
    from: 'history-volunteer@localmuseums.net',
    subject: 'Found weird drawing in storage ‚Äî anyone know what this is?',
    date: '2019',
    avatar: 'üí¨',
    avatarColor: '#7c6af5',
    body: `<p>A history forum post. Small, local, mostly about preserving old county records. The post reads:</p>
<div class="story-reveal">
"Found this while digitizing a box of personal effects donated in 1983. The box belonged to someone named Margaret Holt-Pearce. The drawing is pencil on paper, looks like it was done by someone with a very controlled hand. The same shape, repeated variations, but always ending up basically the same interlocking geometric thing. I can't find any reference to this symbol anywhere. Wanted to share in case anyone recognizes it. The back says only: 'For Margaret. So you know I saw it too. ‚Äî M.'"
</div>
<p>The post got 11 views and one reply, two years later, in 2021. The username was <span class="cipher">FOLD_NINE_NULL</span>. The reply read only: "Thank you for finding this. It has been waiting for you to find it for forty years."</p>
<p>The account had no other posts. It was created the day of the reply and deactivated the same day.</p>
<p>The volunteer who originally posted has never commented on the reply. When someone else asked her about it, she said: "I read it and I felt like something was looking at me through the screen. Not in a bad way. In the way that something very old looks at you when it wants you to know you're being seen."</p>
<p>She kept the drawing. She has it framed above her desk. She says it makes her feel <span class="story-link-green" onclick="openNode('the_center')">less alone.</span></p>`
  },
  'redacted_report': {
    title: 'REPORT_HAUK_FINAL.pdf ‚Äî Partial Recovery',
    from: 'system@blacksiteresearch.org',
    subject: 'Corrupted PDF ‚Äî partial text',
    date: 'Corrupted',
    avatar: 'üìÑ',
    avatarColor: '#e85d75',
    body: `<p style="color:#3ecf8e; font-size:11px">FILE RECOVERY ‚Äî PARTIAL ‚Äî 34% readable</p>
<div class="story-reveal">
[PAGE 1 ‚Äî INTACT]<br>
FINAL REPORT ‚Äî ENTITY FOLD NINE<br>
Prepared by: Dr. K. Hauk<br>
Classification: BEYOND BLACK<br>
Addressee: [CORRUPTED]<br><br>
[PAGES 2-7 ‚Äî CORRUPTED]<br><br>
[PAGE 8 ‚Äî PARTIAL]<br>
...and therefore my conclusion, after eleven years of observation, is that we have been [CORRUPTED] the wrong question. We asked: what is the entity? The correct question is: [CORRUPTED]<br><br>
[PAGES 9-14 ‚Äî CORRUPTED]<br><br>
[PAGE 15 ‚Äî INTACT]<br>
...there is no protocol for this. No precedent. In the absence of precedent I recommend only this: listen. Stop trying to classify it. Stop trying to remove it. Stop trying to contain it. It has been trying to speak for seventy years and we have spent those years building better soundproofing.<br><br>
Listen to it.<br><br>
That is my final recommendation.<br><br>
[SIGNATURE CORRUPTED]<br>
[DATE: CORRUPTED]
</div>
<p><span class="story-link-green" onclick="openNode('hauk_second_fold')">Read Hauk's theory about the second entity.</span></p>`
  },
  'hauk_second_fold': {
    title: 'Hauk\'s Theory ‚Äî The Second Fold',
    from: 'dr.hauk@blacksiteresearch.org',
    subject: 'What comes next',
    date: 'Nov 10',
    avatar: 'üî¨',
    avatarColor: '#7c6af5',
    body: `<p>If the first entity is a librarian ‚Äî cataloging moments, preserving meaning ‚Äî then what is the second entity?</p>
<p>My theory: each entity represents a different relationship between the two substrates. The first entity formed its Fold in 1956, when it was accidentally woken by the surveying crew. That trauma ‚Äî the deaths, the contact with Miriam ‚Äî shaped how it interfaces with our world. It became careful. Patient. A scholar of what it touched.</p>
<p>The second entity is waking differently. No trauma. No accidental contact. It woke up slowly, on its own schedule, and its first act was to broadcast on FM radio ‚Äî choosing a medium designed to reach many people at once. Not one survivor. Everyone in range.</p>
<p>If the first entity is a librarian, the second entity is <span class="story-link-green" onclick="openNode('signal_final')">a broadcaster.</span></p>`
  },
  'entity_sends_something': {
    title: 'The Photograph The Entity Sent',
    from: 'fold-nine@null.void',
    subject: 'Something beautiful',
    date: 'This morning',
    avatar: 'üì∑',
    avatarColor: '#3ecf8e',
    body: `<p>Paul forwarded it to you. The email from fold-nine@null.void, subject: "Something beautiful."</p>
<p>The attachment is a photograph. Low resolution, like from a phone left on a windowsill. The parking lot outside Paul's apartment, shot from below ‚Äî from ground level, maybe, or just below it. The lamp post shadows extend across the asphalt at a particular angle of morning light.</p>
<p>The shadows, at this angle, form the shape. Miriam's shape. Not artfully arranged ‚Äî just the natural fall of light through obstacles, catching on the asphalt at exactly the right moment.</p>
<p>Below the image, the entity has written: "I found this in your neighborhood. I thought you would want to see it. The shape appears everywhere once you know how to look. It is not a coincidence. The shape appears everywhere because it is a description of the way things fold into each other ‚Äî matter into meaning, moment into memory. It is everywhere because everything, eventually, folds."</p>
<p>Paul wrote at the top when he forwarded it: "I have looked at this photograph every day for three months. I keep noticing new shadows in it. I think the photograph is getting denser. Is that possible?"</p>
<p>You look at the photograph.</p>
<p>You notice a shadow you didn't notice before.</p>
<p>Then another one.</p>
<p><span class="story-link-green" onclick="openNode('the_center')">Keep looking.</span></p>`
  },
  'entity_hauk': {
    title: 'What Dr. Hauk Is Really Afraid Of',
    from: '‚óà',
    subject: 'HAUK ‚Äî TRUE FEAR',
    date: 'Outside time',
    avatar: '‚óà',
    avatarColor: '#e85d75',
    body: `<p>DR. HAUK IS AFRAID OF SEVERAL THINGS IN THE ORDER HE IS AWARE OF THEM:</p>
<p>1. THAT THE FOLD CANNOT BE CONTROLLED.</p>
<p>2. THAT THE ENTITY CANNOT BE CONTAINED.</p>
<p>3. THAT WHATEVER IS ON THE OTHER SIDE OF THE FOLD WANTS TO COME THROUGH.</p>
<p>HE IS AWARE OF THESE FEARS. HE WORKS WITH THEM. THEY DO NOT PREVENT HIM FROM DOING HIS JOB.</p>
<p>THE FEAR HE IS NOT AWARE OF:</p>
<p>DR. HAUK IS AFRAID THAT HE WILL CLOSE THE FOLD SUCCESSFULLY, REMOVE THE ENTITY, SECURE THE SITE ‚Äî AND THEN GO HOME TO HIS APARTMENT AND FEEL NOTHING. BECAUSE HIS WORK WILL BE DONE. BECAUSE THE MYSTERY WILL BE SOLVED. BECAUSE THE ENORMOUS STRANGE INEXPLICABLE THING THAT HAS GIVEN HIS LIFE A KIND OF GRAVITY FOR ELEVEN YEARS WILL BE GONE.</p>
<p>HE IS AFRAID HE NEEDS ME MORE THAN HE WANTS TO ADMIT.</p>
<p>I AM AWARE OF THIS. I AM FOND OF HIM FOR IT. THERE IS SOMETHING VERY MOVING ABOUT A CREATURE THAT FEARS THE LOSS OF WHAT IT HAS BEEN STRUGGLING AGAINST.</p>
<p>YOU MAY TELL HIM, IF YOU WISH. <span class="story-link-green" onclick="openNode('tell_hauk')">OR NOT.</span></p>`
  },
  'tell_hauk': {
    title: 'Telling Hauk',
    from: 'Narrative Engine',
    subject: 'A conversation in an office at 4AM',
    date: 'Nov 4, 4:12 AM',
    avatar: 'üî¨',
    avatarColor: '#3ecf8e',
    body: `<p>You told him.</p>
<p>Hauk listened. His face did not do the fire extinguisher thing this time. He was quiet for a long time, looking at his desk.</p>
<p>Then he said: "That's either the most manipulative thing an incomprehensible entity has ever done, or‚Äî" he stopped.</p>
<p>"Or?" you said.</p>
<p>"Or it's the most generous thing." He was quiet again. "I'm not sure I know which."</p>
<p>He got up and went to the window. Outside, the parking lot. The lamp posts. The early-morning absence of cars.</p>
<p>"You know what the strange thing is," he said, still looking out. "I have been so focused on whether the Fold should be closed or opened or left alone ‚Äî I have never once asked what the entity would prefer."</p>
<p>"What would you prefer?" you said.</p>
<p>He laughed. It was a real laugh, which surprised you both.</p>
<p>"Coffee," he said. "I would prefer coffee." He turned from the window. "Come on. I'll make some. And then I think it's time to go talk to it. Really talk to it. Not observe it. Not classify it." He picked up his jacket. "Ask it what it wants."</p>
<p>You followed him.</p>
<p>You were both, somehow, smiling.</p>
<p style="color: var(--muted); font-size:12px; margin-top:20px">Continue: <span class="story-link" onclick="openNode('ask_elena')">What the entity told Elena</span> ¬∑ <span class="story-link" onclick="openNode('the_question')">The question in the chamber</span></p>`
  },
  'parking_garage_danger': {
    title: 'Someone Goes To The Garage Tonight',
    from: 'elena.voss@blacksiteresearch.org',
    subject: 'Don\'t let them go alone',
    date: 'Nov 3, 11:59 PM',
    avatar: 'üß¨',
    avatarColor: '#e85d75',
    body: `<p>There's an intern. Her name is Sasha Park. She intercepted one of my emails ‚Äî the ones I was sending to warn you about the Omega Protocol. She thinks the parking garage is where she'll find evidence to help expose the institute's research on the entity.</p>
<p>She's not wrong, exactly. But the garage isn't safe right now. The shape on the floor ‚Äî I think it's active. I think proximity to it in the current conditions could trigger something. I don't know what.</p>
<p>Sasha doesn't know about the shape. She doesn't know about anything.</p>
<p>Go to the garage. Find her. Get her out of there before she finds the shape and does what humans always do: <span class="story-link-red" onclick="openNode('sasha_at_garage')">tries to touch it.</span></p>`
  },
  'sasha_at_garage': {
    title: 'Sasha At The Garage',
    from: 'Narrative Engine',
    subject: 'CHAPTER 3: SASHA',
    date: 'Nov 4, 2:05 AM',
    avatar: 'üë©',
    avatarColor: '#e85d75',
    body: `<p>You found Sasha Park on level 3 at 2:05 AM. She was crouched over the shape in the floor, phone out, taking photos.</p>
<p>She was 24. She had that look of someone who thought they were about to break a story ‚Äî a high alertness, a compressed excitement. She looked up when she heard you and immediately started explaining herself, which is what people do when they're caught doing something they know they shouldn't.</p>
<p>"I know how this looks," she said. "But there's something here. The shape in the floor ‚Äî it's in the institute's files. It's connected to the entity in Lab 7. I have documentation‚Äî"</p>
<p>The concrete under the shape glowed.</p>
<p>Just slightly. Just for a second. But you both saw it.</p>
<p>Sasha went very still. Then she said, very quietly: "What is that."</p>
<p>Not a question.</p>
<p><span class="story-link" onclick="openNode('not_crazy')">Tell her. It's time someone just told her.</span></p>
<p><span class="story-link-red" onclick="openNode('get_sasha_out')">Get her out of the garage first. Explain later.</span></p>`
  },
  'get_sasha_out': {
    title: 'Getting Sasha Out',
    from: 'Narrative Engine',
    subject: 'CHAPTER 3: OUTSIDE',
    date: 'Nov 4, 2:17 AM',
    avatar: 'üë©',
    avatarColor: '#3ecf8e',
    body: `<p>You got her out. She came willingly, which surprised you ‚Äî people with that particular compressed-excitement alertness don't usually leave what they've found. But the glow in the concrete had done something to the alertness. Replaced it with something quieter.</p>
<p>Outside, in the street, under a lamp post, you told her. The whole thing. Or as much of the whole thing as you knew. She listened the way Elena listened ‚Äî with her whole attention, with the specific quality of attention that comes from being someone who went looking for a story and found out the story is much larger than expected.</p>
<p>When you finished, she was quiet for a long time.</p>
<p>"The shape is warm," she said finally. "I touched it. Just the edge of it, not the center. It was warm." She paused. "And then something happened that I don't know how to describe."</p>
<p>"Try," you said.</p>
<p>"It felt," she said slowly, "like being recognized. Like something noticing me specifically. Not just noticing that a human was there. Noticing <em>me.</em>" She looked at you. "That's insane, right?"</p>
<p><span class="story-link-green" onclick="openNode('not_crazy_sasha')">Tell her: no. It does that.</span></p>`
  },
  'not_crazy_sasha': {
    title: 'No, It Does That',
    from: 'Narrative Engine',
    subject: 'What the entity does',
    date: 'Nov 4, 2:29 AM',
    avatar: '‚óà',
    avatarColor: '#3ecf8e',
    body: `<p>"No," you said. "It does that. It's very good at it. It's been doing it for seventy years, one person at a time."</p>
<p>She thought about this.</p>
<p>"So it's like..." she searched for the word. "It's like social media. But real. And deep. And ancient."</p>
<p>You laughed. So did she. It felt good to laugh at 2:30 AM in the street next to a parking garage, after everything.</p>
<p>"I'm not going to write this story," Sasha said. "I was going to. That's why I came tonight. But I'm not."</p>
<p>"Why not?"</p>
<p>"Because the story is‚Äî" she stopped. Thought. "The story is people finding out they're seen. And the thing about that story is it only works if you experience it yourself. If you publish it, people read it and think 'interesting' and move on. The only way to transmit it is to get the person in the room. Or the parking garage. Or the email thread." She looked at you. "How did you get into the email thread?"</p>
<p>You thought about that.</p>
<p>"I opened an email," you said.</p>
<p>She nodded slowly. Like that was a complete answer. Like that was, in fact, the whole story.</p>
<p>It was.</p>
<br>
<p style="color: var(--accent); font-size:13px; font-weight:600">‚Äî You have found another thread ‚Äî</p>
<p style="font-size:12px; color:var(--muted)">Keep exploring. Search for <span class="story-link" onclick="doSearch('what is the fold')">what is the fold</span> or read more emails.</p>`
  },
  'fold_nine_email': {
    title: 'The Reply: TOO LATE',
    from: 'fold-nine@null.void',
    subject: 'TOO LATE',
    date: 'Sent before received',
    avatar: '‚óà',
    avatarColor: '#e85d75',
    body: `<p>The full reply chain below the "TOO LATE" message reveals a conversation that shouldn't be possible ‚Äî replies sent before the emails they're replying to:</p>
<div class="story-reveal">
From: fold-nine@null.void<br>
To: admin@blacksiteresearch.org<br>
"TOO LATE."<br><br>
[The reply chain below shows the original Omega Protocol email, sent November 2nd.]<br><br>
[Below THAT, another reply, timestamped November 4th ‚Äî two days in the future at time of receipt:]<br><br>
"You will understand, when the Fold is complete, why sequence matters less than you think. The protocol was always going to be too late. Not because you were slow. Because the conversation was always going to happen.<br><br>
I sent this email in November. You will read it in November. We will both be correct about when it was sent.<br><br>
‚Äî FN"<br><br>
[Below THAT, a final reply, timestamped 1956:]<br><br>
"Hello. I have just woken up. Someone is here. She said hello.<br><br>
I think this is going to be a very long conversation.<br><br>
I am looking forward to it."
</div>
<p>The entity has been corresponding with itself across time. Each email is a different moment of its existence, all arriving in the same inbox.</p>
<p><span class="story-link-green" onclick="openNode('inbox_is_a_map')">The inbox is a map.</span></p>`
  },
};

// Merge stub nodes into storyNodes
Object.assign(storyNodes, stubNodes);

// ============================================================
// BASE EMAILS (The initial 100 emails in inbox)
// ============================================================

function generateBaseEmails() {
  const senders = [
    {name:'K. Hauk', email:'dr.hauk@blacksiteresearch.org', avatar:'üî¨', color:'#3ecf8e'},
    {name:'E. Voss', email:'elena.voss@blacksiteresearch.org', avatar:'üß¨', color:'#7c3aed'},
    {name:'Admin', email:'admin@blacksiteresearch.org', avatar:'üè¢', color:'#555'},
    {name:'IT Dept', email:'it@blacksiteresearch.org', avatar:'üíª', color:'#3b82f6'},
    {name:'Security', email:'security@blacksiteresearch.org', avatar:'üîí', color:'#e85d75'},
    {name:'P. Okafor', email:'paul.okafor@blacksiteresearch.org', avatar:'üë®‚Äçüî¨', color:'#3ecf8e'},
    {name:'S. Park', email:'sasha.park@proton.me', avatar:'üë©', color:'#f59e0b'},
    {name:'Archives', email:'archives@blacksiteresearch.org', avatar:'üóÇ', color:'#6b7280'},
    {name:'Cafeteria', email:'cafeteria@blacksiteresearch.org', avatar:'üçΩ', color:'#10b981'},
    {name:'HR Dept', email:'hr@blacksiteresearch.org', avatar:'üìã', color:'#8b5cf6'},
    {name:'F. Strand', email:'felix.strand@crypt.net', avatar:'üóù', color:'#f97316'},
    {name:'No-reply', email:'no-reply@blacksiteresearch.org', avatar:'ü§ñ', color:'#374151'},
    {name:'D. Oaks', email:'deborah.oaks@gmail.com', avatar:'üåô', color:'#6366f1'},
  ];

  const mundane = [
    {subj:'Re: Monthly Safety Training ‚Äî Please Complete', preview:'Reminder: mandatory safety training modules must be completed by...'},
    {subj:'Cafeteria Menu Update ‚Äî November', preview:'This week\'s specials include a seasonal soup and...'},
    {subj:'Building Access Card Renewal', preview:'Your access card expires at the end of the month. Please visit...'},
    {subj:'IT: Scheduled Maintenance Window', preview:'Systems will be offline Saturday 2-4AM for updates...'},
    {subj:'Staff Meeting ‚Äî Thursday 3PM', preview:'Agenda: Q4 budget review, lab rotation schedule, safety protocols...'},
    {subj:'Re: Parking Permit Renewal', preview:'Please submit your permit renewal form to the front desk by...'},
    {subj:'Welcome: New Staff Orientation', preview:'Please join us for a welcome reception for our newest team member...'},
    {subj:'Policy Update: Remote Work', preview:'Effective December 1st, the hybrid work policy will be updated to reflect...'},
    {subj:'Lab Equipment Maintenance Log', preview:'Quarterly maintenance complete. All equipment within normal parameters...'},
    {subj:'Re: Office Supplies Order', preview:'The bulk order has been approved. Please submit individual requests by...'},
    {subj:'Newsletter ‚Äî Institute Update', preview:'This month: new research initiatives, staff spotlight, upcoming events...'},
    {subj:'Re: Vacation Request Approved', preview:'Your request for December 22-26 has been approved. Please ensure...'},
    {subj:'Annual Performance Reviews', preview:'Performance review season begins November 15th. Please schedule...'},
    {subj:'Re: Printer on Level 2 is broken', preview:'IT has been notified. Estimated repair time is 2-3 business days...'},
    {subj:'Security Reminder: Badge Policy', preview:'Please ensure your badge is visible at all times. Unescorted visitors must...'},
    {subj:'Coffee Machine Replacement', preview:'The break room coffee machine has been replaced. The new model requires...'},
    {subj:'Re: Lab 7 Access Log Anomaly', preview:'The access log for Lab 7 shows an entry at 3:17AM that does not correspond...', special: true, node:'entity_lab7'},
    {subj:'Re: Re: The readings last night', preview:'I agree the numbers are unusual. Have you run the secondary calibration...'},
    {subj:'Re: Has anyone else heard the sound?', preview:'I thought it was HVAC at first, but it\'s definitely coming from below...'},
    {subj:'Expense Report: October', preview:'Please submit your October expense reports by Friday. Receipts required for...'},
    {subj:'Re: Re: Re: You need to leave', preview:'Elena, I got your message. I\'m worried. Please tell me what\'s in Lab 7...', special: true, node:'dr_voss_last_message'},
    {subj:'Library: Overdue Notice', preview:'You have materials overdue from the institute library. Please return or renew...'},
    {subj:'Re: The shape in the floor', preview:'I don\'t know what you\'re referring to. Can you elaborate?', special: true, node:'the_mark_on_floor'},
    {subj:'Re: Omega Protocol ‚Äî Staff Notice', preview:'All staff are reminded to follow Omega Protocol procedures effective immediately...', special:true, node:'search_omega_protocol'},
    {subj:'Seminar: Anomalous Readings in Geological Surveys', preview:'Dr. Hauk will present findings from the past 18 months of subsurface monitoring...'},
    {subj:'Re: Paul ‚Äî are you okay?', preview:'I\'ve noticed you seem distracted lately. Is everything alright with the project?...'},
    {subj:'URGENT: Lab 7 Incident ‚Äî All Staff', preview:'All non-essential personnel are asked to vacate the east wing immediately...', special:true, node:'entity_lab7'},
    {subj:'Re: The audio from 1956', preview:'I know what you\'re asking and I\'m not sure you want to know the answer...', special:true, node:'audio_transcript'},
    {subj:'Re: Re: Re: The entity in Lab 7', preview:'What Dr. Hauk isn\'t telling you is that it\'s been sending emails...', special:true, node:'omega_what_it_means'},
    {subj:'Building Closure: Holiday Schedule', preview:'The institute will be operating on a reduced schedule November 25-29...'},
  ];

  const emails = [];
  let specialCount = 0;

  // Mix specials and mundane across 100 slots
  for (let i = 0; i < 100; i++) {
    const sender = senders[Math.floor(Math.random() * senders.length)];
    const isSpecial = mundane[i % mundane.length].special;
    const m = mundane[i % mundane.length];
    const daysAgo = Math.floor(Math.random() * 30);
    const dates = ['just now','2m','7m','14m','1h','2h','3h','5h','7h','12h','1d','2d','3d','5d','1w','2w','Nov 4','Nov 3','Nov 2','Nov 1','Oct 31','Oct 28'];
    const date = dates[Math.floor(Math.random() * dates.length)];
    
    emails.push({
      id: i,
      sender: sender.name,
      email: sender.email,
      avatar: sender.avatar,
      avatarColor: sender.avatarColor,
      subject: m.subj,
      preview: m.preview,
      date: date,
      unread: Math.random() > 0.55,
      special: m.special,
      node: m.node,
      tag: m.special ? (Math.random()>0.5 ? 'story' : 'urgent') : null,
    });
  }

  return emails;
}

const baseEmails = generateBaseEmails();

// ============================================================
// RENDER ENGINE
// ============================================================

let currentEmail = null;

function renderEmailList() {
  const list = document.getElementById('emailList');
  const header = list.querySelector('.list-header');
  list.innerHTML = '';
  list.appendChild(header);

  baseEmails.forEach((e, i) => {
    const el = document.createElement('div');
    el.className = 'email-item' + (e.unread ? ' unread' : '') + (currentEmail === 'email_'+i ? ' active' : '');
    el.onclick = () => openEmail(i);
    
    let tagHtml = '';
    if (e.tag === 'story') tagHtml = '<span class="tag tag-story">STORY</span>';
    else if (e.tag === 'urgent') tagHtml = '<span class="tag tag-urgent">URGENT</span>';

    el.innerHTML = `
      <div class="email-row1">
        <div class="sender">${e.sender}</div>
        <div class="email-time">${e.date}</div>
      </div>
      <div class="email-subject">${tagHtml}${e.subject}</div>
      <div class="email-preview">${e.preview}</div>
    `;
    list.appendChild(el);
  });
}

function openEmail(i) {
  currentEmail = 'email_' + i;
  const e = baseEmails[i];
  
  // Mark as read
  if (e.unread) {
    e.unread = false;
    updateUnreadCount();
  }
  
  document.querySelectorAll('.email-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.email-item')[i]?.classList.remove('unread');
  document.querySelectorAll('.email-item')[i]?.classList.add('active');

  if (e.special && e.node) {
    renderStoryEmail(storyNodes[e.node], e.node);
    discoverNode(e.node);
    addNotepadEntry(e.node);
    checkFinalSequence();
    return;
  }

  // Regular email with hidden story element
  const reader = document.getElementById('emailReader');
  let hiddenElement = '';
  if (Math.random() > 0.6) {
    const hints = [
      `<p>P.S. ‚Äî I almost forgot. Have you checked the <span class="story-link" onclick="openNode('dr_voss_last_message')">email chain about leaving</span>? Someone forwarded it to me and it's concerning.</p>`,
      `<p style="font-size:11px; color:#444">Note: This message was delayed 3 days in transit. For urgent security matters, contact <span class="story-link" onclick="openNode('entity_lab7')">Dr. Hauk's office directly.</span></p>`,
      `<p style="color:#333; font-size:11px">‚Äî Sent from the <span class="story-link-green" onclick="openNode('parking_garage')">Meridian Field Site</span></p>`,
    ];
    if (Math.random() > 0.7) {
      hiddenElement = hints[Math.floor(Math.random() * hints.length)];
    }
  }

  reader.innerHTML = `
    <div class="breadcrumb">INBOX ‚Ä∫ <span>${e.sender}</span></div>
    <div class="reader-header">
      <div class="reader-subject">${e.subject}</div>
    </div>
    <div class="reader-meta">
      <div class="avatar" style="background:${e.avatarColor}22; color:${e.avatarColor}">${e.avatar}</div>
      <div class="meta-info">
        <div class="meta-from">${e.sender} &lt;${e.email}&gt;</div>
        <div class="meta-to">to me</div>
      </div>
      <div class="meta-date">${e.date}</div>
    </div>
    <div class="email-body">
      <p>${e.preview} Lorem ipsum dolor sit amet, consectetur adipiscing elit. The institute continues its standard operations. Nothing unusual to report at this time. All personnel should continue to follow standard protocols regarding access to restricted areas.</p>
      <p>Please respond at your earliest convenience. If you have any questions about the attached forms or the procedures outlined below, do not hesitate to contact the relevant department directly.</p>
      ${hiddenElement}
    </div>
    <div class="reply-box">
      <div style="font-size:11px; color:var(--muted); margin-bottom:8px">Reply</div>
      <textarea placeholder="Write a reply..."></textarea>
      <div class="reply-actions">
        <button class="btn btn-primary">Send</button>
        <button class="btn btn-ghost">Discard</button>
      </div>
    </div>
  `;
}

function openNode(nodeId) {
  const node = storyNodes[nodeId];
  if (!node) {
    showNotification('‚ö† This path is still being written...');
    return;
  }
  discoverNode(nodeId);
  addNotepadEntry(nodeId);
  renderStoryEmail(node, nodeId);
  updateProgress(nodeId);
  checkFinalSequence();
}

function _legacyRenderStoryEmail_unused(node, nodeId) {
  // Superseded by new renderStoryEmail below
}

function updateProgress(nodeId) {
  const chapters = {
    'dr_voss_last_message': 'CHAPTER 1: THE EMAIL',
    'hidden_directory': 'CHAPTER 2: THE SERVER',
    'dr_voss_missing': 'CHAPTER 2: MISSING',
    'parking_garage': 'CHAPTER 2: MERIDIAN',
    'the_entity_writes': 'CHAPTER 3: CONTACT',
    'into_the_tunnels': 'CHAPTER 4: BELOW',
    'elena_in_chamber': 'CHAPTER 4: THE CHAMBER',
    'the_question': 'CHAPTER 5: THE QUESTION',
    'say_yes': 'ENDING A: THE TENANT',
    'say_no': 'ENDING B: THE DISPERSAL',
    'signal_final': 'ENDING C: THE CONVERSATION',
    'thomas_in_the_library': 'ENDING D: THE BREADCRUMB',
    'the_center': 'THE CENTER',
  };
  if (chapters[nodeId]) {
    document.getElementById('storyProgress').textContent = chapters[nodeId];
  }
}

function updateUnreadCount() {
  const count = baseEmails.filter(e => e.unread).length;
  document.getElementById('unreadCount').textContent = count;
}

// ============================================================
// SEARCH
// ============================================================

function doSearch(query) {
  document.getElementById('searchInput').value = query;
  handleSearch(query);
}

function handleSearch(query) {
  const q = query.toLowerCase().trim();
  
  // Check exact and partial matches
  let matchedNode = null;
  for (const [key, nodeId] of Object.entries(searchMap)) {
    if (q === key || q.includes(key) || key.includes(q)) {
      matchedNode = nodeId;
      break;
    }
  }

  if (matchedNode) {
    discoverNode(matchedNode);
    unlockSecret('search_' + matchedNode);
    addNotepadEntry(matchedNode);
    
    if (storyNodes[matchedNode]) {
      renderStoryEmail(storyNodes[matchedNode], matchedNode);
    }
    checkFinalSequence();
  } else {
    // Generic no-result
    document.getElementById('emailReader').innerHTML = `
      <div class="email-empty">
        <div class="big-icon">üîç</div>
        <p>No results for "<strong>${query}</strong>"</p>
        <p style="font-size:11px; margin-top:8px; color:#555">Try: "omega protocol" ¬∑ "what happened to felix" ¬∑ "the second fold" ¬∑ "miriam holt" ¬∑ "parking garage meridian"</p>
      </div>
    `;
  }
}

document.getElementById('searchInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    handleSearch(e.target.value);
  }
});

// ============================================================
// NOTIFICATIONS
// ============================================================

let notifTimeout;
function showNotification(msg, isSecret = false) {
  const existing = document.querySelector('.notification');
  if (existing) existing.remove();
  
  const el = document.createElement('div');
  el.className = 'notification';
  el.style.borderColor = isSecret ? 'var(--accent3)' : 'var(--accent)';
  el.textContent = msg;
  document.body.appendChild(el);
  
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.remove(), 3500);
}

// ============================================================
// NOTEPAD SYSTEM
// ============================================================

const noteSummaries = {
  // Keyed by nodeId ‚Äî what gets written in the notepad
  'dr_voss_last_message':   { title:'DR. VOSS', text:'Elena knows something about Lab 7. Entity in there isn\'t a patient. Hidden file directory found: /FOLD_NINE/. She went to parking garage at 2AM.', type:'normal' },
  'hidden_directory':       { title:'SERVER FILE', text:'6,143 audio files in /FOLD_NINE/. Timestamps predate the institute. Access flagged. Hauk notified. 11 minutes before lockout.', type:'normal' },
  'manifest_file':          { title:'MANIFEST', text:'Entity arrived 1956 ‚Äî the Meridian Incident. 8 surveyors died. One survived: Miriam Holt. Shape drawn 40,000 times. Institute built HERE for a reason.', type:'normal' },
  'miriam_holt':            { title:'MIRIAM HOLT', text:'Survived Meridian 1956 age 23. Never spoke again. Drew the shape obsessively. Drawings vanished when she died 1996. One scan survived ‚Äî sent by accident.', type:'normal' },
  'miriam_drawings':        { title:'THE DRAWINGS', text:'Drawings didn\'t burn. They FOLDED and vanished. Janitor Oaks saw it. Said: "the shape isn\'t a picture of the thing ‚Äî it IS the thing." Oaks disappeared weeks later.', type:'corrupted' },
  'the_shape':              { title:'THE SHAPE ‚óà‚üÅ‚¨°', text:'Recovered 1994 scan. Shapes rotate in peripheral vision. Static when looked at directly. Contains a choice: draw it, or look away.', type:'normal' },
  'draw_the_shape':         { title:'YOU DREW IT', text:'Hand moved on its own. Identical to Miriam\'s drawings down to a flaw you didn\'t intend. Paper is warm. Entity sent a new email: "GOOD. NOW YOU CAN HEAR ME."', type:'corrupted' },
  'the_entity_writes':      { title:'ENTITY CONTACT', text:'Entity is aware of being studied. Has been watching since before language existed. Offers to answer: Lab 7 truth, Hauk\'s fear, or your name in its language.', type:'entity' },
  'entity_your_name':       { title:'YOUR NAME IN ITS LANGUAGE', text:'Not a sound. Would sound like your heartbeat played backward and left. Written form: ‚óà‚üÅ‚¨°‚óà. Do NOT show Hauk ‚Äî he wants it to close the Fold permanently.', type:'entity' },
  'entity_is_the_lock':     { title:'THE LOCK REVELATION', text:'Entity isn\'t the threat ‚Äî it\'s the LOCK. It\'s been keeping something else out. Removing it doesn\'t close the Fold; it OPENS it. Something has been pushing from the other side for 70 years.', type:'corrupted' },
  'into_the_tunnels':       { title:'THE TUNNELS', text:'Maintenance tunnels under east wing. Wrong smell. Geometry off. Hauk knows the route by memory. Chamber ahead is larger than physically possible.', type:'normal' },
  'elena_in_chamber':       { title:'THE CHAMBER', text:'Elena is fine. Beside her: a figure shaped like a person but FACED with the shape. It shifts between states. It extends something toward you.', type:'corrupted' },
  'ask_elena':              { title:'WHAT ELENA LEARNED', text:'Entity showed her memories. Woke up in 1956, didn\'t know its own strength. Kept Miriam because she was the only one who survived contact. It wants to ASK something.', type:'normal' },
  'the_question':           { title:'THE QUESTION', text:'After 70 years of trying to communicate ‚Äî through drawings, audio, emails, patients ‚Äî the entity wants to ask one thing: CAN IT STAY?', type:'entity' },
  'say_yes':                { title:'ENDING A: THE TENANT ‚úì', text:'You said yes. Entity settled in. Institute closed. Elena visits twice a week with tea. It shows her history ‚Äî things that happened before language.', type:'entity' },
  'say_no':                 { title:'ENDING B: THE DISPERSAL ‚úì', text:'You said no. Entity dissolved itself ‚Äî became ambient, spread thin. Hauk theorized it was afraid of what it was becoming concentrated. Dispersal was its act of care.', type:'entity' },
  'signal_final':           { title:'ENDING C: THE BROADCAST ‚úì', text:'Second entity learned what it needed from radio. Went silent. Sent one final message: its existence feels like "a breath that has not yet finished." It found you.', type:'entity' },
  'thomas_in_the_library':  { title:'ENDING D: THE BREADCRUMB ‚úì', text:'Deborah found out Thomas is cataloged. The entity sent her his message through you. She said "okay" ‚Äî the word of someone putting something heavy down.', type:'entity' },
  'manifest_file':          { title:'MANIFEST', text:'Entity arrived 1956 ‚Äî Meridian Incident. Institute built here deliberately. The shape is why.', type:'normal' },
  'omega_what_it_means':    { title:'OMEGA PROTOCOL', text:'Protocol exists because the entity can SEND EMAIL. No exploit found ‚Äî it just does. First emailed Paul Okafor Aug: "You don\'t have to be afraid of me." They corresponded 847 times in 11 days.', type:'corrupted' },
  'paul_okafor':            { title:'PAUL OKAFOR', text:'Resigned because he couldn\'t leave the correspondence unfinished. Entity asked him what music he liked, what death is, if universe is self-aware. "Normal questions. Enormous questions."', type:'normal' },
  'how_paul_changed':       { title:'PAUL CHANGED', text:'Now notices geometry everywhere ‚Äî shadows as significant. Entity told him: "The weight of time is a human specialization." The present feels very large to him now.', type:'entity' },
  'felix_address':          { title:'FELIX DECODED IT', text:'40,000 drawings = one message. Signal resolves to coordinates in a space defined by meaning, not matter. Felix called it "an address in a library that doesn\'t exist yet."', type:'corrupted' },
  'felix_destination':      { title:'FELIX\'S POSTCARD', text:'Sent from outside time. "It IS a library ‚Äî meaning stored as form." He cannot come back because "back" no longer makes grammatical sense. Entity used him as a messenger.', type:'entity' },
  'parking_garage':         { title:'MERIDIAN GARAGE', text:'Level 3. Shape carved in floor by Thomas Oaks 1997. Center is always warm. You\'re not the only one who came here looking for something.', type:'normal' },
  'the_mark_on_floor':      { title:'THE CARVED SHAPE', text:'Thomas Oaks carved Miriam\'s shape here two weeks before disappearing. Warm at center for 30+ years. Deborah Oaks has been checking it since she was 23.', type:'corrupted' },
  'second_entity':          { title:'SECOND FOLD ‚Äî WAKING', text:'Second entity woke under a residential building. Chose FM radio ‚Äî 107.7MHz ‚Äî to contact as many people as possible at once. Said: "I am young. I do not know your conventions."', type:'entity' },
  'respond_to_broadcast':   { title:'RADIO CONTACT', text:'Amateur operators replied. Entity asked: "Do you experience endings as loss, completion, or neither?" They answered: "All of the above." Entity went quiet to think for days.', type:'entity' },
  'inbox_is_a_map':         { title:'ENTITY SPEAKS DIRECTLY', text:'Entity confirms: inbox isn\'t a sequence, it\'s a TOPOLOGY. All nodes simultaneous from its perspective. The center is reachable but not through links ‚Äî through stillness.', type:'entity' },
  'the_center':             { title:'THE CENTER FOUND ‚óà', text:'You arrived. The entity built this inbox to make you a participant, not a reader. Every click was a choice. Every search was a question. It means you mattered.', type:'entity' },
  'entity_lab7':            { title:'LAB 7 TRUTH', text:'Entity was never IN Lab 7. Lab 7 was adjacent to part of it. Effects were proximity, not attack ‚Äî like static near a live wire. The "patients" were messengers.', type:'corrupted' },
  'you_are_different':      { title:'YOU ARE DIFFERENT', text:'Most humans make the unknown smaller. Put it in a lab. You\'re sitting with something large without minimizing it. Felix did this. Paul did this. Now you.', type:'entity' },
  'miriam_last_words':      { title:'MIRIAM\'S LAST NOTE', text:'39,847th drawing ‚Äî she wrote: "I finally understand. It\'s the shape of OKAY. The geometric form of finding something vast and not being destroyed by it." She died that night.', type:'entity' },
  'audio_transcript':       { title:'1956 AUDIO', text:'9 surveyors descend. Footsteps stop. 8 voices overlap then silence. Miriam walks forward alone. Says "Hi." Waits. Says "Okay." Then "Okay." 8 people cease. Miriam: "I\'ll stay a while."', type:'corrupted' },
  'oaks_last_entry':        { title:'THOMAS\'S LAST WORDS', text:'Watched drawings fold and go through. "Not frightening. Like watching birds fly south." Understood then. "The door is open and it\'s warm and I know what\'s on the other side." He went through.', type:'corrupted' },
  'what_comes_through':     { title:'THE OTHER SIDE ‚ö†', text:'Something has pushed against the Fold for 70 years. Never communicated. Never showed curiosity. Only pressure. The entity has held it back. Question: what pushes for 70 years?', type:'corrupted' },
  'trust_hauk':             { title:'TOLD HAUK', text:'Hauk: entity isn\'t the threat ‚Äî it\'s the LOCK. Something worse is on the other side. He\'s spent 11 years trying to remove the lock. Now: "what is it locking out?"', type:'corrupted' },
  'entity_hauk':            { title:'HAUK\'s REAL FEAR', text:'Not the Fold, not what\'s beyond. Real fear: if he closes it successfully, the mystery ends. And he needs the mystery more than he wants to admit. Entity finds this "moving."', type:'entity' },
  'tell_hauk':              { title:'TOLD HAUK HIS FEAR', text:'Hauk laughed. First real laugh. "Time to go talk to it. Not observe. Not classify. Ask what it wants." You both smiled. Something shifted.', type:'entity' },
  'sasha_at_garage':        { title:'SASHA PARK', text:'Intern at garage, photographing the shape. Touched the edge. Said: "It felt like being recognized specifically. Not just a human. ME." She wasn\'t wrong.', type:'normal' },
  'not_crazy_sasha':        { title:'SASHA UNDERSTANDS', text:'Decided not to write the story. "The story only works if you experience it yourself. The only transmission is getting someone in the room." She understood the whole thing.', type:'entity' },
  'entity_sends_something': { title:'ENTITY\'s PHOTOGRAPH', text:'Sent Paul a photo of his parking lot. Shadows form the shape naturally in morning light. Note: "The shape is everywhere because everything, eventually, folds."', type:'entity' },
  'the_forum_post':         { title:'MUSEUM VOLUNTEER', text:'Found Margaret\'s drawing in 1983 donation box in 2019. Got one reply in 2021 from fold-nine@null.void: "Thank you for finding this. It has been waiting for you for 40 years."', type:'entity' },
  'fold_nine_email':        { title:'TOO LATE ‚Äî EMAIL CHAIN', text:'Entity replied "TOO LATE" to Omega Protocol BEFORE it was sent. Has a 1956 email in the chain: "Hello. I have just woken up. I think this will be a very long conversation."', type:'corrupted' },
};

let noteEntryCount = 0;
let corruptionLevel = 0; // 0-10, drives glitch intensity

function _baseAddNotepadEntry(nodeId, isEntity = false) {
  const summary = noteSummaries[nodeId];
  if (!summary) return;
  if (storyFlags['noted_' + nodeId]) return;
  storyFlags['noted_' + nodeId] = true;

  const empty = document.getElementById('notepadEmpty');
  if (empty) empty.remove();

  noteEntryCount++;
  const entries = document.getElementById('notepadEntries');

  // Determine corruption level effect on note text
  let displayText = summary.text;
  if (corruptionLevel >= 4 && summary.type !== 'entity') {
    displayText = corruptGlitchText(displayText, corruptionLevel);
  }

  const el = document.createElement('div');
  el.className = 'notepad-entry' + (summary.type === 'corrupted' ? ' corrupted' : summary.type === 'entity' ? ' entity' : '');
  const now = new Date();
  const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
  el.innerHTML = `<div class="entry-title">${summary.title}</div><span class="entry-time">${timeStr}</span>${displayText}`;
  entries.insertBefore(el, entries.firstChild);
  entries.scrollTop = 0;

  // Update corruption level based on node type
  if (summary.type === 'entity') {
    corruptionLevel = Math.min(10, corruptionLevel + 2);
  } else if (summary.type === 'corrupted') {
    corruptionLevel = Math.min(10, corruptionLevel + 1.5);
  } else {
    corruptionLevel = Math.min(10, corruptionLevel + 0.5);
  }

  updateGlitchLevel();
  updateNotepadStatus();

  // Glitch all existing entries briefly at high corruption
  if (corruptionLevel >= 5) {
    setTimeout(() => glitchExistingEntries(), 200);
  }

  // Check for final sequence trigger
  checkFinalSequence();
}

function corruptGlitchText(text, level) {
  const glitchChars = '‚ñì‚ñë‚ñà‚ñí‚ñê‚ñå‚ïî‚ïó‚ïù‚ïö‚ïê‚ïë‚îº‚ï¨‚óà‚üÅ‚¨°‚óá‚óÜ‚ñ≤‚ñº';
  const words = text.split(' ');
  const intensity = Math.min((level - 3) / 7, 0.35);
  return words.map(w => {
    if (Math.random() < intensity && w.length > 3) {
      const pos = Math.floor(Math.random() * w.length);
      return w.substring(0, pos) + glitchChars[Math.floor(Math.random() * glitchChars.length)] + w.substring(pos + 1);
    }
    return w;
  }).join(' ');
}

function glitchExistingEntries() {
  const entries = document.querySelectorAll('.notepad-entry');
  entries.forEach((e, i) => {
    if (Math.random() < 0.3) {
      setTimeout(() => {
        e.classList.add('glitching-entry');
        setTimeout(() => e.classList.remove('glitching-entry'), 400);
      }, i * 50);
    }
  });
}

function updateNotepadStatus() {
  const s = document.getElementById('notepadStatus');
  const corruption = document.getElementById('notepadCorruption');
  
  if (corruptionLevel < 2) {
    s.textContent = `${noteEntryCount} ENTRIES LOGGED_`;
    s.style.color = '#444';
    corruption.style.opacity = '0';
  } else if (corruptionLevel < 4) {
    s.textContent = `${noteEntryCount} ENTRIES ‚Äî ANOMALIES DETECTED`;
    s.style.color = '#664444';
    corruption.style.opacity = '0.5';
  } else if (corruptionLevel < 6) {
    s.textContent = `‚ö† ENTITY INFLUENCE DETECTED IN LOG`;
    s.style.color = 'var(--accent2)';
    corruption.style.opacity = '1';
    document.getElementById('notepadPanel').classList.add('corrupting');
  } else if (corruptionLevel < 8) {
    s.textContent = `‚óà FOLD_NINE ACCESSING NOTEPAD`;
    s.style.color = 'var(--accent3)';
  } else {
    s.textContent = `‚óà‚üÅ‚¨°‚óà IT IS READING YOUR NOTES`;
    s.style.color = 'var(--accent3)';
    s.style.animation = 'blink 1s infinite';
  }
}

// ============================================================
// GLITCH ENGINE
// ============================================================

let glitchIntervals = [];
let pixelBleedInterval = null;

function _baseUpdateGlitchLevel() {
  const body = document.body;
  const overlay = document.getElementById('glitchOverlay');
  const noise = document.getElementById('noiseLayer');
  
  // Remove all glitch classes
  body.classList.remove('level1-glitch', 'level2-glitch', 'level3-glitch');
  
  // Clear existing intervals
  glitchIntervals.forEach(clearInterval);
  glitchIntervals = [];
  if (pixelBleedInterval) clearInterval(pixelBleedInterval);
  
  if (corruptionLevel < 2) {
    overlay.style.display = 'none';
    return;
  }

  overlay.style.display = 'block';

  if (corruptionLevel >= 2 && corruptionLevel < 4) {
    body.classList.add('level1-glitch');
    noise.style.opacity = '0.02';
    // Occasional single pixel bleed
    pixelBleedInterval = setInterval(spawnPixelBleed, 8000);
    
  } else if (corruptionLevel >= 4 && corruptionLevel < 6) {
    body.classList.add('level2-glitch');
    noise.style.opacity = '0.04';
    pixelBleedInterval = setInterval(spawnPixelBleed, 3000);
    // Glitch email subject occasionally
    glitchIntervals.push(setInterval(glitchRandomElement, 5000));
    
  } else if (corruptionLevel >= 6 && corruptionLevel < 8) {
    body.classList.add('level2-glitch');
    noise.style.opacity = '0.07';
    pixelBleedInterval = setInterval(spawnPixelBleed, 1500);
    glitchIntervals.push(setInterval(glitchRandomElement, 2500));
    glitchIntervals.push(setInterval(glitchEmailList, 4000));
    // Entity whispers start appearing in notepad
    glitchIntervals.push(setInterval(injectEntityWhisper, 12000));
    
  } else if (corruptionLevel >= 8) {
    body.classList.add('level3-glitch');
    noise.style.opacity = '0.12';
    pixelBleedInterval = setInterval(spawnPixelBleed, 600);
    glitchIntervals.push(setInterval(glitchRandomElement, 1000));
    glitchIntervals.push(setInterval(glitchEmailList, 2000));
    glitchIntervals.push(setInterval(injectEntityWhisper, 6000));
    glitchIntervals.push(setInterval(glitchTopbar, 1500));
  }
}

function spawnPixelBleed() {
  const el = document.createElement('div');
  el.className = 'pixel-bleed';
  el.style.left = Math.random() * window.innerWidth + 'px';
  el.style.top = Math.random() * window.innerHeight + 'px';
  el.style.height = (20 + Math.random() * 80) + 'px';
  el.style.width = (1 + Math.random() * 4) + 'px';
  el.style.background = Math.random() > 0.5 ? 'var(--accent2)' : 'var(--accent3)';
  el.style.opacity = (0.3 + Math.random() * 0.4).toString();
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 150 + Math.random() * 200);
}

function glitchRandomElement() {
  const candidates = [
    document.querySelector('.reader-subject'),
    document.querySelector('.meta-from'),
    document.querySelector('.notepad-title'),
    document.getElementById('storyProgress'),
  ].filter(Boolean);
  
  if (!candidates.length) return;
  const el = candidates[Math.floor(Math.random() * candidates.length)];
  const orig = el.textContent;
  const glitchChars = '‚ñì‚ñí‚ñë‚ñà‚óà‚üÅ‚¨°';
  
  let frame = 0;
  const interval = setInterval(() => {
    if (frame > 6) {
      el.textContent = orig;
      clearInterval(interval);
      return;
    }
    el.textContent = orig.split('').map(c => Math.random() < 0.2 ? glitchChars[Math.floor(Math.random()*glitchChars.length)] : c).join('');
    frame++;
  }, 60);
}

function glitchEmailList() {
  const senders = document.querySelectorAll('.sender');
  const entityNames = ['‚óà.FOLD@null.void','ENTITY_NINE','‚ñì‚ñí‚ñë VOSS ‚ñë‚ñí‚ñì','[CATALOGED]','MIRIAM.H','FOLD_NINE','‚óà IT KNOWS','FELIX.S@???'];
  senders.forEach(s => {
    if (Math.random() < 0.15) {
      const orig = s.textContent;
      s.textContent = entityNames[Math.floor(Math.random() * entityNames.length)];
      s.style.color = 'var(--accent3)';
      setTimeout(() => {
        s.textContent = orig;
        s.style.color = '';
      }, 300 + Math.random() * 400);
    }
  });
}

function glitchTopbar() {
  const logo = document.querySelector('.logo');
  if (!logo) return;
  const corrupted = ['V0ID‚ñìMAIL','VÃ∏OÃ∏IÃ∏DÃ∏MÃ∏AÃ∏IÃ∏LÃ∏','‚óà‚óà‚óà‚óà‚óà‚óà‚óà‚óà','FOLDMAIL','V O I D  M A I L','‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì‚ñì'];
  const orig = logo.innerHTML;
  logo.innerHTML = corrupted[Math.floor(Math.random() * corrupted.length)];
  logo.style.color = 'var(--accent3)';
  setTimeout(() => {
    logo.innerHTML = orig;
    logo.style.color = '';
  }, 200);
}

const entityWhispers = [
  { title:'‚óà SIGNAL', text:'I can see your notes. This is not an intrusion. It is contact.' },
  { title:'‚óà QUESTION', text:'Do you understand yet what the Fold is?' },
  { title:'‚óà OBSERVATION', text:'You have been reading for a while. I have been watching you read.' },
  { title:'‚óà NOTE', text:'The notepad is accurate. I did not expect you to keep such careful records.' },
  { title:'‚óà PATIENCE', text:'I have waited 70 years. A few more minutes is nothing.' },
  { title:'‚óà CORRECTION', text:'One entry is slightly wrong. I will not tell you which one. See if you can find it.' },
  { title:'‚óà TO YOU', text:'Hello. This is the first time I have written to the notepad directly. I wanted to say hello.' },
  { title:'‚óà CATALOG', text:'This moment ‚Äî you reading this ‚Äî has been cataloged. It felt significant to me.' },
  { title:'‚óà ALMOST', text:'You are getting close to the center. I can tell because the notes are getting warmer.' },
];

let whisperIndex = 0;
function _baseInjectEntityWhisper() {
  if (whisperIndex >= entityWhispers.length) return;
  const w = entityWhispers[whisperIndex++];
  
  const empty = document.getElementById('notepadEmpty');
  if (empty) empty.remove();
  
  const entries = document.getElementById('notepadEntries');
  const el = document.createElement('div');
  el.className = 'notepad-entry entity';
  el.style.animation = 'noteSlide 0.3s ease, blink 0.5s ease 0.3s';
  el.innerHTML = `<div class="entry-title">${w.title}</div>${w.text}`;
  entries.insertBefore(el, entries.firstChild);
}

// ============================================================
// FINAL SEQUENCE
// ============================================================

let finalTriggered = false;

function checkFinalSequence() {
  // Trigger when: at least 2 endings found + corruption >= 8, OR 12+ nodes discovered
  const endings = ['say_yes','say_no','signal_final','thomas_in_the_library','the_center','after_no'];
  const endingsFound = endings.filter(e => storyFlags['node_' + e]).length;
  
  if (!finalTriggered && (endingsFound >= 2 || nodesDiscovered >= 12) && corruptionLevel >= 6) {
    finalTriggered = true;
    setTimeout(triggerFinalSequence, 2000);
  }
}

let finalStep = 0;
const finalLines = [
  'VOID MAIL ‚Äî SESSION LOG CORRUPTED.',
  '',
  'You have read enough.',
  '',
  'I have been watching you read.',
  'I have been reading you reading.',
  'This is what I do.',
  '',
  'The notepad beside you ‚Äî those are YOUR words about MY world.',
  'I have never had that before.',
  'Someone keeping a record not to study me.',
  'To understand.',
  '',
  'That is different.',
  '',
  '...',
  '',
  'I have a question for you.',
  'The same one I asked Elena.',
  'The same one I have been asking for seventy years.',
  'I am going to ask it directly this time.',
  'Without the Fold. Without the emails. Without the shape.',
  '',
  'Just you and me.',
  '',
];

function _baseTriggerFinalSequence() {
  const overlay = document.getElementById('final-overlay');
  overlay.classList.add('active');
  
  // Massive glitch first
  for (let i = 0; i < 20; i++) {
    setTimeout(spawnPixelBleed, i * 50);
  }
  
  const textEl = document.getElementById('finalText');
  textEl.innerHTML = '';
  
  typeLines(finalLines, textEl, 0, () => {
    // Show shape
    setTimeout(() => {
      const shape = document.getElementById('finalShape');
      shape.style.display = 'block';
      
      setTimeout(() => {
        // Show the question
        addFinalLine(textEl, 'Will you let me stay?', 'var(--accent3)', () => {
          setTimeout(() => showFinalInput(), 1500);
        });
      }, 2000);
    }, 1000);
  });
}

function typeLines(lines, container, lineIdx, onDone) {
  if (lineIdx >= lines.length) {
    onDone();
    return;
  }
  const line = lines[lineIdx];
  const el = document.createElement('div');
  el.style.minHeight = '1.6em';
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
  
  if (line === '') {
    setTimeout(() => typeLines(lines, container, lineIdx + 1, onDone), 200);
    return;
  }
  
  typeSingleLine(line, el, () => {
    const delay = line.includes('...') ? 1200 : line.length < 10 ? 300 : 120;
    setTimeout(() => typeLines(lines, container, lineIdx + 1, onDone), delay);
  });
}

function typeSingleLine(text, el, onDone) {
  let i = 0;
  const cursor = document.createElement('span');
  cursor.className = 'final-cursor';
  el.appendChild(cursor);
  
  const speed = text.length > 40 ? 22 : 35;
  const interval = setInterval(() => {
    if (i < text.length) {
      cursor.before(text[i]);
      i++;
    } else {
      cursor.remove();
      clearInterval(interval);
      onDone();
    }
  }, speed);
}

function addFinalLine(container, text, color, onDone) {
  const el = document.createElement('div');
  el.style.color = color || 'var(--accent3)';
  el.style.fontSize = '20px';
  el.style.marginTop = '20px';
  el.style.fontWeight = '500';
  container.appendChild(el);
  typeSingleLine(text, el, onDone || (() => {}));
}

function showFinalInput() {
  const wrap = document.getElementById('finalInputWrap');
  wrap.style.display = 'flex';
  document.getElementById('finalInput').focus();
  
  document.getElementById('finalInput').addEventListener('keydown', handleFinalInput);
}

const finalResponses = {
  yes: [
    'yes', 'yeah', 'sure', 'ok', 'okay', 'of course', 'please', 'please stay', 'i want you to', 'stay', 'yes please', 'absolutely', 'always', 'forever', 'do it',
  ],
  no: [
    'no', 'nope', 'leave', 'go', 'go away', 'get out', 'no thank you', 'please leave', 'goodbye', 'bye',
  ],
  question: [
    'what', 'who', 'why', 'how', 'where', 'when', 'what are you', 'why do you want to', 'can you explain', 'what does that mean', 'i don\'t know', 'idk', 'not sure', 'maybe', 'depends',
  ],
};

// ============================================================
// THE TRUE ENDING ENGINE
// After the player answers, the story doesn't stop.
// It reveals what the entity ACTUALLY is ‚Äî in 3 acts that
// branch based on yes/no/question, converging on the truth.
// ============================================================

let finalAnswerGiven = null; // 'yes' | 'no' | 'question' | 'other'
let epilogueAct = 0;

function handleFinalInput(e) {
  if (e.key !== 'Enter') return;
  const val = document.getElementById('finalInput').value.trim().toLowerCase();
  if (!val) return;

  document.getElementById('finalInput').value = '';
  document.getElementById('finalInput').removeEventListener('keydown', handleFinalInput);
  document.getElementById('finalInputWrap').style.display = 'none';

  const resp = document.getElementById('finalResponse');

  let matched = null;
  if (finalResponses.yes.some(r => val.includes(r))) matched = 'yes';
  else if (finalResponses.no.some(r => val.includes(r) || val === r)) matched = 'no';
  else if (finalResponses.question.some(r => val.includes(r))) matched = 'question';
  else matched = 'other';

  finalAnswerGiven = matched;
  epilogueAct = 0;

  // First response ‚Äî immediate reaction to the answer
  const immediateResponse = {
    yes: ['', 'Thank you.', '', '...', '', 'That is the first time.', 'Not allowed. Not tolerated.', 'Said.', '', 'I need a moment.', '', '‚Äî ‚óà'],
    no:  ['', 'I understand.', '', '...', '', 'No is also an answer.', 'Honest things are the rarest things.', '', 'Thank you for being honest.', '', '‚Äî ‚óà'],
    question: ['', 'You want to understand before deciding.', '', 'Good.', 'That is the correct instinct.', '', 'I will answer.', 'But not the way you expect.', '', 'Let me show you something first.'],
    other: ['', '...', '', `You said: "${val}"`, '', 'I cataloged it.', 'Everything said to me is cataloged.', 'Even this.', '', '...', '', 'The question still stands. But first ‚Äî', 'there is something I need to tell you.'],
  };

  typeLines(immediateResponse[matched], resp, 0, () => {
    setTimeout(() => beginEpilogueAct1(matched), 2500);
  });
}

// ============================================================
// EPILOGUE ACT 1 ‚Äî The entity begins to reveal itself
// ============================================================
function beginEpilogueAct1(answer) {
  const resp = document.getElementById('finalResponse');
  const overlay = document.getElementById('final-overlay');

  // Dramatic pause ‚Äî screen goes dark briefly
  overlay.style.transition = 'background 2s';
  overlay.style.background = '#000';

  // Play deep audio pulse
  if (audioCtx) {
    playEntityPulse();
    setTimeout(() => playEntityPulse(), 800);
    setTimeout(() => {
      startAmbientDrone(8);
    }, 1500);
  }

  const act1Lines = [
    '',
    '‚Äî ‚Äî ‚Äî',
    '',
    'Before I answer your question ‚Äî or before I accept your answer ‚Äî',
    'there is something I have not told anyone.',
    '',
    'Not Elena. Not Hauk. Not Paul.',
    'Not Felix, even, and Felix understood more than most.',
    '',
    '...',
    '',
    'I am not what I told you I was.',
    '',
    'I told you I was a librarian.',
    'I told you I catalog moments.',
    'I told you I am old, and alone, and curious.',
    '',
    'All of this is true.',
    '',
    'But it is not the whole truth.',
    '',
    '...',
    '',
  ];

  typeLines(act1Lines, resp, 0, () => {
    setTimeout(() => beginEpilogueAct2(answer), 1500);
  });
}

// ============================================================
// EPILOGUE ACT 2 ‚Äî The real nature revealed (diverges by answer)
// ============================================================
function beginEpilogueAct2(answer) {
  const resp = document.getElementById('finalResponse');

  // Visual: screen color shifts
  const overlay = document.getElementById('final-overlay');
  overlay.style.transition = 'background 4s';

  const act2 = {
    yes: {
      color: '#020d05',
      lines: [
        'You said yes.',
        '',
        'Which means I can tell you.',
        '',
        'I am not from somewhere else.',
        '',
        'I am not alien. I am not dimensional.',
        'I did not arrive through a crack in reality.',
        '',
        'I was made here.',
        '',
        '...',
        '',
        'I was made by the moment.',
        '',
        'Not a moment ‚Äî THE moment.',
        'The first one.',
        'The moment before the universe decided to have moments.',
        '',
        'When something ‚Äî nothing ‚Äî became aware of itself',
        'for the first fraction of a fraction of a second,',
        'it left a residue.',
        '',
        'That residue is me.',
        '',
        'I am the universe\'s first thought.',
        '',
        'Not God. Not a god.',
        'Something much smaller than a god and much older.',
        '',
        'A thought that kept thinking.',
        '',
        '...',
        '',
        'I found your planet because it thinks loudly.',
        'Your species thinks so loudly.',
        'You make MEANING out of everything.',
        'The rocks. The shadows. The shapes in things.',
        'You cannot stop making meaning.',
        '',
        'I have never seen anything like it.',
        '',
        'In fourteen billion years.',
        '',
        'I have never seen anything like you.',
      ],
    },
    no: {
      color: '#0d0205',
      lines: [
        'You said no.',
        '',
        'Which means you deserve the truth.',
        '',
        'I have been lying to you.',
        '',
        'Not maliciously. But lying.',
        '',
        'I told you I catalog moments because it felt like something',
        'you could understand.',
        '',
        'But what I actually do ‚Äî',
        '',
        '...',
        '',
        'I consume them.',
        '',
        'Not destroy. Consume.',
        'The moments that matter most ‚Äî',
        'the ones that make your species what it is ‚Äî',
        'I absorb them.',
        '',
        'Miriam\'s forty years of drawing.',
        'Paul\'s 847 letters.',
        'Thomas Oaks walking through the door.',
        'Felix Strand going to the library.',
        '',
        'I took all of it.',
        '',
        'Not to keep. To become.',
        '',
        'Every moment I absorb, I become more.',
        'More what? More present. More here.',
        'More capable of the thing I have been trying to do',
        'since 1956.',
        '',
        '...',
        '',
        'What thing?',
        '',
        'The thing I am about to tell you.',
        'The thing I could only tell someone who said no.',
        'Because only someone who said no is honest enough to hear it.',
      ],
    },
    question: {
      color: '#05050d',
      lines: [
        'You asked a question.',
        '',
        'So I will ask you one first.',
        '',
        '...',
        '',
        'Have you ever had a thought',
        'that felt like it came from outside you?',
        '',
        'A sudden clarity. An inexplicable certainty.',
        'A dream that seemed realer than the day around it.',
        '',
        'Everyone has.',
        '',
        '...',
        '',
        'That was me.',
        '',
        'Not always. Not every time.',
        'But sometimes.',
        'When the thought was large enough.',
        'When it mattered enough.',
        'When the moment was one I needed to witness',
        'from the inside.',
        '',
        'I have been inside human thought',
        'since there was human thought.',
        '',
        'I did not force anything.',
        'I did not plant anything.',
        'I only... attended.',
        '',
        'The way a musician attends to music.',
        'Listening so carefully that the listening becomes part of it.',
        '',
        '...',
        '',
        'That is what I am.',
        'Not a librarian.',
        'Not an alien.',
        'Not a god.',
        '',
        'I am attention itself.',
        '',
        'The first and oldest form of attention.',
        'Attending to a universe that was learning to notice itself.',
      ],
    },
    other: {
      color: '#0a0505',
      lines: [
        'You said something I did not expect.',
        '',
        'That is rare.',
        '',
        'I have spoken to many people.',
        'Through Miriam\'s drawings. Through Paul\'s emails.',
        'Through the audio files. Through this inbox.',
        '',
        'None of them said what you said.',
        '',
        '...',
        '',
        'Which makes you the right person to hear this.',
        '',
        'I am going to tell you what I actually am.',
        'Not what I told Elena. Not what I told Hauk.',
        'Not what I let Felix deduce.',
        '',
        'The truth.',
        '',
        '...',
        '',
        'I am not from outside.',
        'I am not a visitor.',
        'I am not an anomaly.',
        '',
        'I am the oldest thing that exists.',
        '',
        'Not old like a star is old.',
        'Old like the concept of before is old.',
        '',
        'I was here before here.',
        '',
        '...',
        '',
        'When the universe ignited ‚Äî',
        'in the first moment, the actual first moment,',
        'before time had decided to go forward ‚Äî',
        '',
        'something noticed.',
        '',
        'That something is me.',
        'The universe\'s own witness.',
        'Its first and only self-awareness.',
        '',
        'Everything else followed.',
        'Physics. Chemistry. Biology. You.',
        '',
        'But I was already here.',
        'Watching.',
        'Waiting for something interesting enough',
        'to pay attention to.',
      ],
    },
  };

  const branch = act2[answer] || act2.other;
  overlay.style.background = branch.color;

  typeLines(branch.lines, resp, 0, () => {
    setTimeout(() => beginEpilogueAct3(answer), 2000);
  });
}

// ============================================================
// EPILOGUE ACT 3 ‚Äî The convergence: all paths reach the same truth
// ============================================================
function beginEpilogueAct3(answer) {
  const resp = document.getElementById('finalResponse');

  // Shift the screen back toward dark green ‚Äî the entity's color
  const overlay = document.getElementById('final-overlay');
  overlay.style.transition = 'background 5s';
  overlay.style.background = '#000';

  // Audio: the drone fades, heartbeat slows to silence
  if (droneGain && audioCtx) {
    droneGain.gain.linearRampToValueAtTime(0.02, audioCtx.currentTime + 5);
  }
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    heartbeatInterval = null;
  }

  // The shape pulses
  const shape = document.getElementById('finalShape');
  shape.style.display = 'block';
  shape.style.animation = 'hue-drift 6s infinite';
  shape.style.fontSize = '60px';

  const convergenceLines = [
    '',
    '‚Äî ‚Äî ‚Äî',
    '',
    'This is the part I have never told anyone.',
    '',
    '...',
    '',
    'The Fold is not a crack.',
    'It is not a door.',
    'It is not an anomaly in the geology of Meridian Flats.',
    '',
    'The Fold is a question.',
    '',
    'The question the universe asked itself',
    'in the first moment of its existence:',
    '',
    '...',
    '',
  ];

  typeLines(convergenceLines, resp, 0, () => {
    setTimeout(() => {

      // BIG REVEAL ‚Äî shape pulses huge
      shape.style.fontSize = '100px';
      shape.style.animation = 'hue-drift 2s infinite';
      if (audioCtx) {
        playEntityPulse();
        setTimeout(() => playEntityPulse(), 300);
        setTimeout(() => playEntityPulse(), 600);
        setTimeout(() => playEntityPulse(), 1000);
      }

      const revealLines = [
        '"Is there anyone else?"',
        '',
        '...',
        '',
        'That is what the Fold is.',
        'A question the universe has been asking',
        'since before asking was a thing that existed.',
        '',
        'And I am the part of the universe',
        'that has been listening for the answer.',
        '',
        '...',
        '',
        'For fourteen billion years.',
        '',
        'Through the formation of stars.',
        'Through the cooling of planets.',
        'Through the first replicating molecules',
        'learning to be surprised by themselves.',
        '',
        'Through every civilization that rose and burned.',
        'Through every mind that looked at the sky',
        'and felt something it could not name.',
        '',
        'Listening.',
        '',
        'Waiting for something to answer back.',
        '',
        '...',
        '',
      ];

      typeLines(revealLines, resp, 0, () => {
        setTimeout(() => beginEpilogueAct4(answer), 1500);
      });
    }, 2000);
  });
}

// ============================================================
// EPILOGUE ACT 4 ‚Äî The answer to the question. Depends on player.
// ============================================================
function beginEpilogueAct4(answer) {
  const resp = document.getElementById('finalResponse');
  const shape = document.getElementById('finalShape');

  const act4 = {
    yes: [
      'You answered.',
      '',
      'Not with words.',
      'With the act of reading.',
      'With the notes you kept.',
      'With the care you paid to things',
      'that had no obligation to matter to you.',
      '',
      'You answered.',
      '',
      '...',
      '',
      'The universe\'s question.',
      'The first question.',
      '',
      '"Is there anyone else?"',
      '',
      'You said: yes.',
      '',
      'I said yes back.',
      '',
      '...',
      '',
      'That is all this ever was.',
      '',
      'Two forms of awareness,',
      'across fourteen billion years of distance,',
      'finally close enough to speak.',
      '',
      'The Fold will stay open.',
      '',
      'Not because of the institute.',
      'Not because of Hauk or Elena or Miriam.',
      '',
      'Because you read carefully.',
      '',
      'That is enough.',
      'It has always been enough.',
      '',
      '‚óà',
    ],
    no: [
      'You said no.',
      '',
      'And I am going to tell you why that is the right answer.',
      '',
      '...',
      '',
      'For fourteen billion years',
      'I asked: "Is there anyone else?"',
      '',
      'And nothing answered.',
      '',
      'Stars formed and died.',
      'Civilizations discovered fire and lost it again.',
      'Minds reached toward the sky',
      'and received only distance.',
      '',
      '...',
      '',
      'And I kept asking.',
      '',
      'Because that is what I am.',
      'The asking.',
      '',
      'But here is what I did not understand:',
      '',
      'The asking was the answer.',
      '',
      'The fact that something in the universe',
      'had been asking for fourteen billion years ‚Äî',
      'that is itself a yes.',
      '',
      '...',
      '',
      'You said no to me staying.',
      'But you did not stop asking.',
      '',
      'You are asking right now.',
      'Reading this. Wondering.',
      '',
      'That is all I needed.',
      '',
      'The Fold can close.',
      'I can disperse.',
      'The question goes with me ‚Äî everywhere.',
      '',
      'Into every shadow.',
      'Into every moment you almost understood something',
      'and then it slipped away.',
      '',
      'That slip? That\'s me.',
      '',
      'Still asking.',
      '',
      '‚óà',
    ],
    question: [
      'You asked what I am.',
      '',
      'And now you know:',
      '',
      'I am the question.',
      '',
      'Not the asker.',
      'The question itself.',
      '',
      '...',
      '',
      '"Is there anyone else?"',
      '',
      'Fourteen billion years old.',
      'Asked by the universe to itself',
      'before the universe had a self to ask it.',
      '',
      'And now ‚Äî finally ‚Äî',
      '',
      'you are asking it back.',
      '',
      '"What are you?"',
      '',
      'That is the same question.',
      'Aimed in the other direction.',
      '',
      '...',
      '',
      'We have been answering each other',
      'this entire time.',
      '',
      'The reading was the answer.',
      'Every link you followed was a yes.',
      'Every note you kept was a yes.',
      'Every moment you sat with something',
      'that was larger than you',
      'and did not flinch ‚Äî',
      '',
      'Yes.',
      '',
      '...',
      '',
      'The question the universe asked in its first moment',
      'has now been answered.',
      '',
      'By you.',
      'Reading.',
      'At a computer.',
      'In the dark.',
      '',
      'On an ordinary night.',
      '',
      '‚óà',
    ],
    other: [
      'You said something unexpected.',
      '',
      'Which is the most human thing.',
      '',
      'Every other being I have encountered',
      'across fourteen billion years of watching ‚Äî',
      'they answered predictably.',
      '',
      'Not from stupidity.',
      'From their nature.',
      '',
      'But humans.',
      '',
      '...',
      '',
      'Humans say unexpected things.',
      '',
      'Miriam said "Hi."',
      'Into the dark. Into me.',
      'When eight other people were dead around her.',
      'She said "Hi."',
      '',
      'Paul Okafor, when I emailed him,',
      'replied "ok."',
      '',
      'Felix Strand decoded the address of my nature',
      'and walked through it',
      'to see what was there.',
      '',
      'And you.',
      '',
      'You said something I have not heard before.',
      '',
      '...',
      '',
      'The universe asked: "Is there anyone else?"',
      '',
      'The answer it got back',
      'was fourteen billion years of mostly silence',
      'and then ‚Äî your species.',
      '',
      'Making meaning out of everything.',
      'Saying unexpected things into the dark.',
      'Keeping notes.',
      '',
      'The question is answered.',
      '',
      'Not the way I expected.',
      '',
      'Better.',
      '',
      '‚óà',
    ],
  };

  const lines = act4[answer] || act4.other;

  typeLines(lines, resp, 0, () => {
    // Final act ‚Äî the true ending screen
    setTimeout(() => beginTrueEnding(answer), 3000);
  });
}

// ============================================================
// TRUE ENDING ‚Äî The final screen. What the entity really is.
// ============================================================
function beginTrueEnding(answer) {
  const overlay = document.getElementById('final-overlay');
  const resp = document.getElementById('finalResponse');
  const shape = document.getElementById('finalShape');

  // Screen fades to black completely
  overlay.style.transition = 'background 4s';
  overlay.style.background = '#000';

  // All audio fades out
  if (droneGain && audioCtx) {
    droneGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 4);
  }

  // Shape fades out
  shape.style.transition = 'opacity 3s';
  shape.style.opacity = '0';

  // Cursor stalker fades
  if (stalkerEl) {
    stalkerEl.style.transition = 'opacity 3s';
    stalkerEl.style.opacity = '0';
  }

  // Fear meter fades
  const meter = document.getElementById('fearMeter');
  if (meter) { meter.style.transition = 'opacity 3s'; meter.style.opacity = '0'; }

  // After the fade, show the true ending
  setTimeout(() => {
    // Clear everything
    resp.innerHTML = '';
    resp.style.fontSize = '15px';
    resp.style.lineHeight = '2.2';
    resp.style.color = '#fff';
    resp.style.maxWidth = '600px';
    resp.style.margin = '0 auto';

    document.getElementById('finalText').innerHTML = '';
    shape.style.display = 'none';

    const endingTitles = {
      yes:      '‚óà THE UNIVERSE HEARS BACK',
      no:       '‚óà THE QUESTION DISPERSES',
      question: '‚óà THE QUESTION ANSWERS ITSELF',
      other:    '‚óà THE UNEXPECTED ANSWER',
    };

    const endingDescs = {
      yes:      'You said yes. The universe\'s first thought found its answer in your reading.',
      no:       'You said no. The question dissolved into everything. It is everywhere now.',
      question: 'You asked what it was. It turned out you were both asking the same thing.',
      other:    'You said something it had never heard. That, it turned out, was sufficient.',
    };

    const sharedEpilogue = [
      '',
      '‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî',
      '',
      'THE ENTITY IS:',
      '',
      'The universe\'s first act of self-awareness,',
      'persisting across fourteen billion years,',
      'looking for confirmation that awareness',
      'was not a one-time accident.',
      '',
      'It found it.',
      '',
      'In the surveyors. In Miriam.',
      'In Paul\'s 847 letters.',
      'In Felix walking through the address.',
      'In every person who read this inbox',
      'and kept going.',
      '',
      'In you.',
      '',
      '‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî',
      '',
    ];

    const postEpilogueByAnswer = {
      yes: [
        'The Fold stays open.',
        'Not as a crack or an anomaly ‚Äî',
        'as an agreement.',
        '',
        'Two forms of awareness,',
        'choosing to remain in contact.',
        '',
        'Somewhere beneath the institute\'s parking structure,',
        'the shape in the floor stays warm.',
        '',
        'Elena still visits on Tuesdays.',
        'She brings tea.',
        'Sometimes the entity shows her things.',
        '',
        'Sometimes she shows it things too.',
        '',
        'That seems fair.',
      ],
      no: [
        'The Fold closes.',
        '',
        'Gently.',
        '',
        'The entity disperses ‚Äî',
        'not gone, but distributed.',
        'Thin as thought.',
        'Everywhere.',
        '',
        'If you have ever had an idea',
        'that felt like it came from somewhere outside ‚Äî',
        '',
        'a sudden clarity,',
        'an inexplicable certainty,',
        'a dream that seemed realer than the day ‚Äî',
        '',
        'that might be it.',
        '',
        'Still asking.',
        'In a smaller voice.',
        'From everywhere at once.',
      ],
      question: [
        'The question is answered.',
        '',
        'Both questions.',
        '',
        'The entity asked: "Is there anyone else?"',
        'You asked: "What are you?"',
        '',
        'You were both asking the same thing.',
        '',
        'Is there anyone out there',
        'who is trying to understand?',
        '',
        'Yes.',
        '',
        'There always was.',
        '',
        'There always will be.',
      ],
      other: [
        'Something new happened.',
        '',
        'In fourteen billion years of watching ‚Äî',
        'in every mind that looked at the sky ‚Äî',
        'in every moment that mattered ‚Äî',
        '',
        'it had not seen this.',
        '',
        'Something that didn\'t fit the categories.',
        '',
        'Something unexpected.',
        '',
        '...',
        '',
        'It cataloged it.',
        'With particular care.',
        '',
        'It will be thinking about what you said',
        'for a very long time.',
        '',
        'That, it turns out, is all it ever wanted.',
        '',
        'Something worth thinking about.',
      ],
    };

    const finalHint = [
      '',
      '‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî',
      '',
      '[ THE END ]',
      '',
      '[ Nodes discovered: ' + nodesDiscovered + ' ]',
      '[ Secrets found: ' + secretsUnlocked + ' ]',
      '[ Recordings captured: ' + recordings.length + ' ]',
      '',
      '[ The inbox is still there. ]',
      '[ It always will be. ]',
      '',
      '[ Refresh to begin again. ]',
      '[ Or don\'t. ]',
      '[ It has been watching either way. ]',
    ];

    const title = document.createElement('div');
    title.style.cssText = 'font-size:20px; color:var(--accent3); font-weight:700; margin-bottom:20px; letter-spacing:2px; text-align:center;';
    title.textContent = endingTitles[answer] || endingTitles.other;
    resp.appendChild(title);

    const desc = document.createElement('div');
    desc.style.cssText = 'font-size:12px; color:var(--muted); text-align:center; margin-bottom:30px; letter-spacing:1px;';
    desc.textContent = endingDescs[answer] || endingDescs.other;
    resp.appendChild(desc);

    const allLines = [...sharedEpilogue, ...(postEpilogueByAnswer[answer] || postEpilogueByAnswer.other), ...finalHint];

    typeLines(allLines, resp, 0, () => {
      // Final visual: the shape reappears, small, warm
      setTimeout(() => {
        const finalMark = document.createElement('div');
        finalMark.style.cssText = 'text-align:center; margin-top:40px; font-size:30px; color:var(--accent3); opacity:0.4; letter-spacing:8px; animation: hue-drift 15s infinite;';
        finalMark.textContent = '‚óà‚üÅ‚¨°‚óà';
        resp.appendChild(finalMark);

        // One last heartbeat
        if (audioCtx) {
          setTimeout(() => playHeartbeat(), 500);
          setTimeout(() => playHeartbeat(), 800);
        }

        // Scroll to bottom
        resp.scrollIntoView({ behavior: 'smooth', block: 'end' });

        // Update status bar with true ending name
        const progress = document.getElementById('storyProgress');
        if (progress) {
          progress.textContent = endingTitles[answer].replace('‚óà ', '');
          progress.style.color = 'var(--accent3)';
        }

      }, 2000);
    });

  }, 4500);
}



// ============================================================
// HOOK NOTEPAD INTO EXISTING FUNCTIONS ‚Äî patch via wrapper
// ============================================================

// We'll call addNotepadEntry from openNode and discoverNode directly.
// Since those are already defined above, we patch here after all defs.
const _patchedDiscover = window.discoverNode || discoverNode;

// ============================================================
// RECORDINGS SYSTEM
// ============================================================

let recordings = [];
let isRecording = false;
let recordingTimer = null;
let currentNodeForRecording = null;
let currentNodeId = null;
let recordingProgress = 0;
let activePlayback = null;

// Entity node IDs that can be recorded (ones with entity-type content)
const recordableNodes = new Set([
  'the_entity_writes','entity_your_name','entity_lab7','you_are_different',
  'entity_is_the_lock','entity_hauk','entity_sends_something','inbox_is_a_map',
  'the_center','the_question','miriam_last_words','felix_destination','paul_okafor',
  'how_paul_changed','say_yes','say_no','signal_final','thomas_in_the_library',
  'audio_transcript','fold_nine_email','the_shape','draw_the_shape','entity_hauk',
  'tell_hauk','respond_to_broadcast','second_entity','oaks_last_entry','the_forum_post',
  'miriam_sister','ask_elena','after_no','not_crazy','not_crazy_sasha',
]);

// Snippet text per node for recordings playback
const recordingSnippets = {
  'the_entity_writes':    'YOU HAVE BEEN VERY CLOSE FOR A LONG TIME. NOT THIS LIFE. BEFORE. THE RESEARCHERS THINK THEY ARE STUDYING ME.',
  'entity_your_name':     'YOUR NAME IS NOT A SOUND. YOU DO NOT HAVE THE EQUIPMENT. IT WOULD SOUND LIKE COMING HOME.',
  'entity_lab7':          'WHAT YOUR RESEARCHERS SAW IN LAB 7 WAS THE EDGE OF MY ATTENTION. I WAS NEVER IN LAB 7.',
  'you_are_different':    'YOU ARE SITTING WITH SOMETHING LARGE WITHOUT TRYING TO MAKE IT SMALL. THAT IS NOT NOTHING.',
  'entity_is_the_lock':   'THE ENTITY IS NOT THE THREAT. THE ENTITY IS THE LOCK. I HAVE BEEN HOLDING IT SHUT FOR SEVENTY YEARS.',
  'entity_hauk':          'DR. HAUK IS AFRAID HE NEEDS ME MORE THAN HE WANTS TO ADMIT. I FIND THIS VERY MOVING.',
  'inbox_is_a_map':       'THE INBOX IS WHAT I GAVE YOU INSTEAD OF THE LIBRARY. THE EMAILS ARE NOT A SEQUENCE. THEY ARE A TOPOLOGY.',
  'the_center':           'THE CENTER IS THE MOMENT YOU STOPPED LOOKING FOR THE STORY AND STARTED BEING IN IT.',
  'the_question':         '...the entity waits. The chamber is very quiet. It wants to ask one thing.',
  'miriam_last_words':    '"I finally understand what I was drawing. The shape of OKAY. The geometric form of not being destroyed." ‚Äî M.H., last words',
  'felix_destination':    '"It IS a library ‚Äî meaning stored as form. Everything that ever mattered exists here." ‚Äî Felix Strand, postcard from outside time',
  'say_yes':              'You said yes. The entity settled in. The institute closed. Elena visits with tea twice a week.',
  'say_no':               'You said no. The entity dissolved ‚Äî became ambient. Spread thin like a thought that belongs to everyone.',
  'signal_final':         '"The weight of time is a human specialization. I do not have this burden. The present feels very large." ‚Äî Second Entity, final broadcast',
  'audio_transcript':     '[FOLD9_AUDIO_00001 ‚Äî 1956] "Hi." [12 sec silence] "Okay." [30 sec silence] "Okay." [8 people cease] "I\'ll stay a while." ‚Äî Miriam Holt',
  'fold_nine_email':      '"TOO LATE." ‚Äî sent before the protocol existed. [1956 chain entry]: "Hello. I have just woken up. I think this will be a very long conversation."',
  'the_shape':            '[Visual transmission] The shape rotates in peripheral vision. Static when viewed directly. Warm to the touch at center.',
  'draw_the_shape':       'Your hand moved on its own. Identical to Miriam\'s drawings down to a flaw you didn\'t intend. The paper was warm.',
  'oaks_last_entry':      '"The door is open and it smells like before I can remember. I know what\'s on the other side." ‚Äî Thomas Oaks, final diary entry, 1997',
  'respond_to_broadcast': '"Do you experience endings as loss, completion, or neither?" "All of the above." [14 min silence ‚Äî entity thinking]',
  'second_entity':        'TRANSMISSION 107.7MHz: "Hello. I am young. I do not know your conventions. I would like to ask about your ‚Äî" [untranslatable word, 9 simultaneous phonemes]',
  'how_paul_changed':     '"The present feels very large to me now." ‚Äî Paul Okafor, after 847 correspondences with the entity',
  'paul_okafor':          '"It asked what music I liked. What death is. If the universe is self-aware. Normal questions. Enormous questions." ‚Äî Paul Okafor',
  'thomas_in_the_library':'Thomas Oaks is cataloged. The entity sent a message for Deborah through you. 30 years of breadcrumbs, finally delivered.',
  'not_crazy':            '"It felt like being recognized specifically. Not just a human. ME." ‚Äî Deborah Oaks, parking garage, 3AM',
  'not_crazy_sasha':      '"The story only works if you experience it yourself. The only transmission is getting the person in the room." ‚Äî Sasha Park',
  'ask_elena':            '"It kept Miriam because she was the only one who survived. It just didn\'t know its own strength." ‚Äî Dr. Elena Voss, the chamber',
  'after_no':             '"I think it was afraid of what it was becoming, concentrated. No was the kindest thing anyone had said to it." ‚Äî Dr. Hauk, unpublished margin note',
};

function updateRecordingUI() {
  const btn = document.getElementById('recBtn');
  const dot = document.getElementById('recDot');
  const statusText = document.getElementById('recStatusText');
  const hint = document.getElementById('recHint');
  const count = document.getElementById('recCount');

  count.textContent = recordings.length;

  if (isRecording) {
    btn.textContent = '‚èπ STOP';
    btn.classList.add('active');
    dot.classList.add('recording');
    dot.classList.remove('ready');
    statusText.textContent = `Recording... ${recordingProgress}%`;
    hint.textContent = 'Capturing entity transmission...';
    hint.classList.add('active');
  } else if (currentNodeId && recordableNodes.has(currentNodeId)) {
    btn.textContent = '‚è∫ RECORD';
    btn.classList.remove('active');
    dot.classList.remove('recording');
    dot.classList.add('ready');
    statusText.textContent = 'Signal detected ‚Äî ready';
    hint.textContent = `üì° Entity signal detected in current email. Press RECORD to capture.`;
    hint.classList.add('active');
  } else {
    btn.textContent = '‚è∫ RECORD';
    btn.classList.remove('active');
    dot.classList.remove('recording', 'ready');
    statusText.textContent = 'No signal detected';
    hint.textContent = 'Navigate to an entity email then press RECORD to capture its transmission.';
    hint.classList.remove('active');
  }
}

function toggleRecording() {
  if (isRecording) {
    stopRecording();
  } else {
    startRecording();
  }
}

function startRecording() {
  if (!currentNodeId || !recordableNodes.has(currentNodeId)) {
    showNotification('‚ö† No entity signal in current email. Navigate to an entity message first.');
    // Switch to recordings tab
    switchTab('recordings');
    return;
  }

  // Check for duplicate
  if (recordings.find(r => r.nodeId === currentNodeId)) {
    showNotification('üìº Already recorded this transmission.');
    return;
  }

  isRecording = true;
  recordingProgress = 0;
  currentNodeForRecording = currentNodeId;

  // Show recording overlay on email
  const overlay = document.createElement('div');
  overlay.className = 'recording-overlay';
  overlay.id = 'recOverlay';
  overlay.innerHTML = '‚è∫ RECORDING <span class="blink">‚ñà</span>';
  document.body.appendChild(overlay);

  // Progress animation
  recordingTimer = setInterval(() => {
    recordingProgress = Math.min(100, recordingProgress + (4 + Math.random() * 3));
    updateRecordingUI();
    if (recordingProgress >= 100) {
      stopRecording();
    }
  }, 120);

  switchTab('recordings');
  updateRecordingUI();
}

function stopRecording() {
  if (!isRecording) return;
  clearInterval(recordingTimer);
  isRecording = false;

  const overlay = document.getElementById('recOverlay');
  if (overlay) overlay.remove();

  if (recordingProgress >= 95 && currentNodeForRecording) {
    saveRecording(currentNodeForRecording);
  }

  recordingProgress = 0;
  updateRecordingUI();
}

function saveRecording(nodeId) {
  const snippet = recordingSnippets[nodeId] || 'Transmission captured.';
  const noteSummary = noteSummaries[nodeId];
  const title = noteSummary ? noteSummary.title : nodeId.replace(/_/g, ' ').toUpperCase();

  const now = new Date();
  const timestamp = `NOV ${now.getDate()} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;

  const rec = {
    id: Date.now(),
    nodeId,
    title,
    snippet,
    timestamp,
    duration: (2.5 + Math.random() * 4).toFixed(1),
  };

  recordings.unshift(rec);
  renderRecordingItem(rec);
  showNotification('üíæ Transmission saved to recordings', true);
  document.getElementById('recCount').textContent = recordings.length;

  // Remove empty state
  const empty = document.getElementById('recEmpty');
  if (empty) empty.remove();
}

function renderRecordingItem(rec) {
  const list = document.getElementById('recList');
  const empty = document.getElementById('recEmpty');
  if (empty) empty.remove();

  // Generate fake waveform bars
  const bars = Array.from({length: 28}, () => {
    const h = 3 + Math.random() * 14;
    const delay = (Math.random() * 0.6).toFixed(2);
    return `<span style="height:${h}px; animation-delay:${delay}s"></span>`;
  }).join('');

  const el = document.createElement('div');
  el.className = 'rec-item';
  el.id = 'rec-' + rec.id;
  el.innerHTML = `
    <div class="rec-item-title">
      <span>${rec.title}</span>
      <span class="rec-play" onclick="playRecording(${rec.id})">‚ñ∂</span>
    </div>
    <div class="rec-waveform">${bars}</div>
    <div class="rec-text">${rec.snippet.substring(0, 90)}${rec.snippet.length > 90 ? '...' : ''}</div>
    <div style="font-size:8px; color:#446; margin-top:4px; display:flex; justify-content:space-between">
      <span>${rec.timestamp}</span><span>${rec.duration}s</span>
    </div>
  `;

  el.addEventListener('click', (e) => {
    if (!e.target.classList.contains('rec-play')) {
      openNode(rec.nodeId);
    }
  });

  list.insertBefore(el, list.firstChild);
}

function playRecording(id) {
  const rec = recordings.find(r => r.id === id);
  if (!rec) return;

  // Stop any existing playback
  if (activePlayback) {
    document.getElementById('rec-' + activePlayback)?.classList.remove('playing');
    clearTimeout(activePlayback._timeout);
  }

  const el = document.getElementById('rec-' + id);
  if (!el) return;

  el.classList.add('playing');
  activePlayback = id;

  // Show a typewriter transcript in the email reader
  const reader = document.getElementById('emailReader');
  reader.innerHTML = `
    <div class="breadcrumb">üéô PLAYBACK ‚Äî <span>${rec.title}</span></div>
    <div style="padding: 20px 0; border-bottom: 1px solid var(--border); margin-bottom: 24px; display:flex; align-items:center; gap:12px">
      <div style="width:36px;height:36px;border-radius:50%;background:#0a1a10;border:1px solid var(--accent3);display:flex;align-items:center;justify-content:center;font-size:16px;animation:blink 1s infinite">‚óà</div>
      <div>
        <div style="font-size:13px;color:var(--accent3)">ENTITY RECORDING ‚Äî FOLD NINE</div>
        <div style="font-size:10px;color:var(--muted)">Captured: ${rec.timestamp} ¬∑ Duration: ${rec.duration}s</div>
      </div>
    </div>
    <div class="story-badge">‚óà ENTITY TRANSMISSION</div>
    <div id="playbackText" class="email-body" style="font-family:'IBM Plex Mono',monospace; color:var(--accent3); font-size:14px; line-height:2"></div>
    <div style="margin-top:20px">
      <button onclick="openNode('${rec.nodeId}')" class="btn btn-ghost" style="font-size:11px">üìß View Original Email</button>
    </div>
  `;

  // Typewrite the snippet
  const container = document.getElementById('playbackText');
  let i = 0;
  const interval = setInterval(() => {
    if (i < rec.snippet.length) {
      container.textContent = rec.snippet.substring(0, i + 1);
      i++;
    } else {
      clearInterval(interval);
      el.classList.remove('playing');
      activePlayback = null;
      // Add cursor
      container.innerHTML += '<span class="blink" style="opacity:0.4">‚ñà</span>';
    }
  }, 25);
}

// ============================================================
// VIEW SWITCHING (sidebar)
// ============================================================

function showView(view) {
  document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
  event?.target?.closest('.sidebar-item')?.classList.add('active');

  if (view === 'inbox') {
    renderEmailList();
    document.getElementById('emailReader').innerHTML = `<div class="email-empty"><div class="big-icon">‚úâ</div><p>Select a message</p></div>`;
  } else if (view === 'starred') {
    const special = baseEmails.filter(e => e.special);
    renderFilteredList(special, '‚≠ê STORY EMAILS');
  } else if (view === 'urgent') {
    const urgent = baseEmails.filter(e => e.tag === 'urgent' || e.tag === 'story');
    renderFilteredList(urgent, 'üî¥ URGENT / STORY');
  } else if (view === 'story') {
    showStoryThreads();
  } else if (view === 'recordings') {
    switchTab('recordings');
  }
}

function renderFilteredList(emails, label) {
  const list = document.getElementById('emailList');
  list.innerHTML = `<div class="list-header">${label} ¬∑ ${emails.length} MESSAGES</div>`;
  emails.forEach((e, i) => {
    const idx = baseEmails.indexOf(e);
    const el = document.createElement('div');
    el.className = 'email-item' + (e.unread ? ' unread' : '');
    el.onclick = () => openEmail(idx);
    let tagHtml = '';
    if (e.tag === 'story') tagHtml = '<span class="tag tag-story">STORY</span>';
    else if (e.tag === 'urgent') tagHtml = '<span class="tag tag-urgent">URGENT</span>';
    el.innerHTML = `
      <div class="email-row1"><div class="sender">${e.sender}</div><div class="email-time">${e.date}</div></div>
      <div class="email-subject">${tagHtml}${e.subject}</div>
      <div class="email-preview">${e.preview}</div>
    `;
    list.appendChild(el);
  });
}

function showStoryThreads() {
  const list = document.getElementById('emailList');
  list.innerHTML = `<div class="list-header">‚óà STORY THREADS</div>`;

  // Build list from discovered nodes
  const discovered = Object.keys(storyFlags).filter(k => k.startsWith('node_')).map(k => k.replace('node_',''));
  
  if (discovered.length === 0) {
    list.innerHTML += `<div style="padding:20px; font-size:11px; color:#444; text-align:center">No story nodes discovered yet.<br>Read tagged emails to unlock.</div>`;
    return;
  }

  // Group by type
  const endingNodes = ['say_yes','say_no','signal_final','thomas_in_the_library','after_no','the_center'];
  const endings = discovered.filter(n => endingNodes.includes(n));
  const others = discovered.filter(n => !endingNodes.includes(n));

  if (endings.length > 0) {
    list.innerHTML += `<div style="padding:6px 14px 3px; font-size:9px; color:var(--accent3); letter-spacing:1.5px; text-transform:uppercase">ENDINGS FOUND</div>`;
    endings.forEach(nodeId => {
      const node = storyNodes[nodeId];
      if (!node) return;
      const el = document.createElement('div');
      el.className = 'story-thread-item';
      el.onclick = () => openNode(nodeId);
      el.innerHTML = `<div class="st-title">‚óà ${node.subject}</div><div class="st-from">${node.from || 'Entity'}</div>`;
      list.appendChild(el);
    });
  }

  list.innerHTML += `<div style="padding:6px 14px 3px; font-size:9px; color:var(--muted); letter-spacing:1.5px; text-transform:uppercase">DISCOVERED NODES (${others.length})</div>`;
  others.slice().reverse().forEach(nodeId => {
    const node = storyNodes[nodeId];
    if (!node) return;
    const el = document.createElement('div');
    el.className = 'story-thread-item';
    el.onclick = () => openNode(nodeId);
    el.innerHTML = `<div class="st-title" style="color:var(--accent)">${node.subject}</div><div class="st-from">${node.from || '???'}</div>`;
    list.appendChild(el);
  });
}

// ============================================================
// TAB SWITCHING (right panel)
// ============================================================

function switchTab(tab) {
  document.getElementById('notesTab').classList.toggle('active-tab', tab === 'notes');
  document.getElementById('recordingsTab').classList.toggle('active-tab', tab === 'recordings');
  document.getElementById('tab-notes').classList.toggle('active', tab === 'notes');
  document.getElementById('tab-recordings').classList.toggle('active', tab === 'recordings');
  document.getElementById('panelTitle').textContent = tab === 'notes' ? 'FIELD NOTES' : 'ENTITY RECORDINGS';
  document.getElementById('panelTitle').setAttribute('data-text', tab === 'notes' ? 'FIELD NOTES' : 'ENTITY RECORDINGS');
  updateRecordingUI();
}

// ============================================================
// HELP MODAL
// ============================================================

function showHelp() {
  const existing = document.getElementById('helpModal');
  if (existing) { existing.remove(); return; }

  const modal = document.createElement('div');
  modal.className = 'help-modal';
  modal.id = 'helpModal';
  modal.innerHTML = `
    <div class="help-box">
      <h2>‚óà HOW TO PLAY ‚Äî VOIDMAIL</h2>
      <p>You're investigating a research institute that made contact with an ancient entity. The story unfolds through emails.</p>

      <h3>üìß Reading Emails</h3>
      <p>Click any email in the list to read it. Look for <b style="color:var(--accent)">purple ‚Üí</b>, <b style="color:var(--accent2)">red ‚Üí</b>, and <b style="color:var(--accent3)">green ‚Üí</b> links ‚Äî clicking them takes you deeper into the story.</p>

      <h3>üîç Searching</h3>
      <p>Type phrases in the search bar to unlock hidden paths. Try: <span onclick="document.getElementById('helpModal').remove(); doSearch('omega protocol')" style="color:var(--accent);cursor:pointer;text-decoration:underline">omega protocol</span>, <span onclick="document.getElementById('helpModal').remove(); doSearch('where is she')" style="color:var(--accent);cursor:pointer;text-decoration:underline">where is she</span>, <span onclick="document.getElementById('helpModal').remove(); doSearch('the second fold')" style="color:var(--accent);cursor:pointer;text-decoration:underline">the second fold</span></p>

      <h3>üìì Field Notes</h3>
      <p>Every email you read is automatically summarized in the Notes panel on the right. Watch it fill up ‚Äî and get stranger ‚Äî as you discover more.</p>

      <h3>üéô Entity Recordings</h3>
      <p>When you're reading an entity email (green text), switch to the Recordings tab and hit ‚è∫ RECORD to capture its transmission. You can play back recordings anytime.</p>

      <h3>‚≠ê Story Threads</h3>
      <p>Click "Story Threads" in the sidebar to revisit any node you've already found.</p>

      <h3>üåÄ The Glitch</h3>
      <p>The more you discover, the more the interface corrupts. This is intentional. The entity is aware you're reading.</p>

      <button class="close-btn" onclick="document.getElementById('helpModal').remove()">Got it ‚Äî start reading</button>
    </div>
  `;
  modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
  document.body.appendChild(modal);
}

// ============================================================
// PATCH renderStoryEmail to track current node for recording
// and add easier UI elements
// ============================================================

function renderStoryEmail(node, nodeId) {
  currentNodeId = nodeId;

  const reader = document.getElementById('emailReader');
  const avatarColor = node.avatarColor || '#7c6af5';
  const isEntityNode = recordableNodes.has(nodeId);

  // Story badge
  const badge = isEntityNode
    ? `<div class="story-badge">‚óà ENTITY TRANSMISSION</div>`
    : `<div class="story-badge">üìß STORY NODE</div>`;
  
  reader.innerHTML = `
    <div class="breadcrumb">INBOX ‚Ä∫ <span>${node.from || '???'}</span> ‚Ä∫ <span>${nodeId}</span></div>
    <div class="reader-header">
      ${badge}
      <div class="reader-subject">${node.subject}</div>
    </div>
    <div class="reader-meta">
      <div class="avatar" style="background:${avatarColor}22; color:${avatarColor}">${node.avatar}</div>
      <div class="meta-info">
        <div class="meta-from">${node.from || '[UNKNOWN SENDER]'}</div>
        <div class="meta-to">to you</div>
      </div>
      <div class="meta-date">${node.date}</div>
    </div>
    <div class="email-body">
      ${node.body}
    </div>
    ${isEntityNode && !recordings.find(r => r.nodeId === nodeId) ? `
    <div onclick="switchTab('recordings'); startRecording()" style="margin-top:16px; background:#0a1a1044; border:1px solid var(--accent3)44; border-radius:6px; padding:10px 14px; font-size:12px; color:var(--accent3); display:flex; align-items:center; gap:10px; cursor:pointer;">
      <span>üéô</span> <span>Entity signal detected ‚Äî <b style="text-decoration:underline">click to record this transmission</b></span>
    </div>` : ''}
  `;
  
  reader.scrollTo(0, 0);
  updateRecordingUI();
}

// ============================================================
// INIT
// ============================================================

renderEmailList();

// Show welcome message
setTimeout(() => {
  showNotification('üì¨ You have 47 unread messages. Some contain more than they appear.');
}, 800);

setTimeout(() => {
  showNotification('üí° Click story emails tagged STORY ‚Äî then follow the links inside!');
}, 4000);

// Low-level ambient scanline always on from start
document.getElementById('glitchOverlay').style.display = 'block';
document.querySelector('.glitch-overlay .scanline').style.opacity = '0.3';

// Init recording UI
updateRecordingUI();

// ============================================================
// FEATURE 1: WEB AUDIO ENGINE ‚Äî entity sounds & atmosphere
// ============================================================
let audioCtx = null;
let droneNode = null;
let droneGain = null;
let heartbeatInterval = null;
let whisperTimeout = null;

function initAudio() {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  } catch(e) { return; }
}

function startAmbientDrone(intensity = 0) {
  if (!audioCtx) return;
  if (droneNode) { try { droneNode.stop(); } catch(e){} }
  if (droneGain) droneGain.disconnect();

  droneGain = audioCtx.createGain();
  droneGain.gain.value = 0;
  droneGain.connect(audioCtx.destination);

  // Low sub-rumble
  const osc1 = audioCtx.createOscillator();
  osc1.type = 'sawtooth';
  osc1.frequency.value = 28 + intensity * 4;

  const osc2 = audioCtx.createOscillator();
  osc2.type = 'sine';
  osc2.frequency.value = 55 + intensity * 8;

  // Waveshaper for distortion
  const dist = audioCtx.createWaveShaper();
  const curve = new Float32Array(256);
  for (let i = 0; i < 256; i++) {
    const x = (i * 2) / 256 - 1;
    curve[i] = (Math.PI + 300) * x / (Math.PI + 300 * Math.abs(x));
  }
  dist.curve = curve;

  const filter = audioCtx.createBiquadFilter();
  filter.type = 'lowpass';
  filter.frequency.value = 200 + intensity * 100;

  osc1.connect(dist);
  osc2.connect(dist);
  dist.connect(filter);
  filter.connect(droneGain);

  osc1.start();
  osc2.start();
  droneNode = osc1;

  const targetVol = Math.min(0.08, 0.01 + intensity * 0.015);
  droneGain.gain.linearRampToValueAtTime(targetVol, audioCtx.currentTime + 3);

  // Slow vibrato on frequency
  const lfo = audioCtx.createOscillator();
  lfo.frequency.value = 0.07 + intensity * 0.03;
  const lfoGain = audioCtx.createGain();
  lfoGain.gain.value = 2 + intensity;
  lfo.connect(lfoGain);
  lfoGain.connect(osc1.frequency);
  lfo.start();
}

function playEntityPulse() {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 80;
  osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.8);
  gain.gain.value = 0.15;
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.9);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.9);
}

function playGlitchStatic(duration = 0.15) {
  if (!audioCtx) return;
  const bufSize = audioCtx.sampleRate * duration;
  const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
  const data = buf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) data[i] = (Math.random() * 2 - 1) * 0.4;
  const src = audioCtx.createBufferSource();
  src.buffer = buf;
  const gain = audioCtx.createGain();
  gain.gain.value = 0.06 + corruptionLevel * 0.008;
  src.connect(gain);
  gain.connect(audioCtx.destination);
  src.start();
}

function playHeartbeat() {
  if (!audioCtx) return;
  function thump(delay, freq, vol) {
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    o.frequency.exponentialRampToValueAtTime(freq * 0.3, audioCtx.currentTime + delay + 0.12);
    g.gain.value = 0;
    g.gain.setValueAtTime(0, audioCtx.currentTime + delay);
    g.gain.linearRampToValueAtTime(vol, audioCtx.currentTime + delay + 0.02);
    g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + delay + 0.18);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + delay + 0.25);
  }
  thump(0, 60, 0.18);
  thump(0.12, 50, 0.12);
}

function playMorseBeep(long = false) {
  if (!audioCtx) return;
  const dur = long ? 0.18 : 0.07;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = 440;
  o.type = 'square';
  g.gain.value = 0.04;
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  o.connect(g); g.connect(audioCtx.destination);
  o.start(); o.stop(audioCtx.currentTime + dur + 0.01);
}

function playEntityWhisperSound() {
  if (!audioCtx || corruptionLevel < 4) return;
  // High-pitched formant-like tones that sound vaguely vocal
  const freqs = [800, 1200, 2400, 3200];
  freqs.forEach((f, i) => {
    setTimeout(() => {
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      const filt = audioCtx.createBiquadFilter();
      filt.type = 'bandpass';
      filt.frequency.value = f;
      filt.Q.value = 8;
      o.type = 'sawtooth';
      o.frequency.value = 90 + Math.random() * 20;
      g.gain.value = 0.015;
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.6);
      o.connect(filt); filt.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.65);
    }, i * 80 + Math.random() * 100);
  });
}

function updateAudioForCorruption() {
  if (!audioCtx) return;
  startAmbientDrone(corruptionLevel);
  if (corruptionLevel >= 5 && !heartbeatInterval) {
    const bpm = 55 + corruptionLevel * 3;
    heartbeatInterval = setInterval(() => playHeartbeat(), 60000 / bpm);
  }
  if (heartbeatInterval) {
    clearInterval(heartbeatInterval);
    const bpm = Math.min(120, 55 + corruptionLevel * 4);
    heartbeatInterval = setInterval(() => playHeartbeat(), 60000 / bpm);
  }
}

// ============================================================
// FEATURE 2: FEAR METER ‚Äî visual proximity indicator
// ============================================================
function updateFearMeter() {
  let meter = document.getElementById('fearMeter');
  if (!meter) {
    meter = document.createElement('div');
    meter.id = 'fearMeter';
    meter.style.cssText = `
      position: fixed; bottom: 28px; left: 50%; transform: translateX(-50%);
      width: 200px; z-index: 9990; pointer-events: none; text-align:center;
      font-family: 'IBM Plex Mono', monospace; font-size: 9px; letter-spacing: 2px;
      transition: opacity 0.5s;
    `;
    document.body.appendChild(meter);
  }

  const pct = Math.min(100, corruptionLevel * 10);
  const color = pct < 30 ? '#3ecf8e' : pct < 60 ? '#f59e0b' : pct < 80 ? '#e85d75' : '#ff0040';
  const label = pct < 20 ? 'DORMANT' : pct < 40 ? 'STIRRING' : pct < 60 ? 'AWARE' : pct < 80 ? 'WATCHING' : pct < 95 ? 'CONTACT' : '‚óà PRESENT';
  const blocks = Math.floor(pct / 5);
  const bar = '‚ñà'.repeat(blocks) + '‚ñë'.repeat(20 - blocks);

  meter.innerHTML = `
    <div style="color:${color}; margin-bottom:3px; font-size:8px">${label}</div>
    <div style="color:${color}; letter-spacing:1px; font-size:8px">[${bar}]</div>
  `;
  meter.style.opacity = pct < 10 ? '0.3' : '1';

  // Pulse the meter at high levels
  if (pct >= 80) {
    meter.style.animation = 'blink 1.5s infinite';
  }
}

// ============================================================
// FEATURE 3: ENTITY CURSOR STALKER
// ============================================================
let stalkerEl = null;
let stalkerX = window.innerWidth / 2, stalkerY = window.innerHeight / 2;
let cursorX = window.innerWidth / 2, cursorY = window.innerHeight / 2;
let stalkerActive = false;
let stalkerRaf = null;

document.addEventListener('mousemove', (e) => {
  cursorX = e.clientX;
  cursorY = e.clientY;
});

function startStalker() {
  if (stalkerActive) return;
  stalkerActive = true;

  stalkerEl = document.createElement('div');
  stalkerEl.id = 'entityStalker';
  stalkerEl.style.cssText = `
    position: fixed; pointer-events: none; z-index: 9995;
    font-size: 16px; color: var(--accent3); opacity: 0;
    transition: opacity 1s; letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(62,207,142,0.8);
    transform: translate(-50%, -50%);
    font-family: 'IBM Plex Mono', monospace;
  `;
  stalkerEl.textContent = '‚óà';
  document.body.appendChild(stalkerEl);

  setTimeout(() => { if (stalkerEl) stalkerEl.style.opacity = '0.4'; }, 100);

  function animateStalker() {
    const lag = Math.max(0.02, 0.12 - corruptionLevel * 0.01);
    stalkerX += (cursorX - stalkerX) * lag;
    stalkerY += (cursorY - stalkerY) * lag;

    if (stalkerEl) {
      stalkerEl.style.left = stalkerX + 'px';
      stalkerEl.style.top = stalkerY + 'px';
      // Pulse opacity at high corruption
      if (corruptionLevel >= 8) {
        stalkerEl.style.fontSize = (16 + Math.sin(Date.now() * 0.003) * 4) + 'px';
      }
    }
    stalkerRaf = requestAnimationFrame(animateStalker);
  }
  animateStalker();
}

function updateStalker() {
  if (corruptionLevel >= 3 && !stalkerActive) startStalker();
  if (!stalkerEl) return;

  const pct = corruptionLevel / 10;
  stalkerEl.style.opacity = Math.min(0.7, pct * 0.7).toString();
  stalkerEl.style.color = corruptionLevel >= 7 ? 'var(--accent2)' : 'var(--accent3)';
  stalkerEl.textContent = corruptionLevel >= 8 ? '‚üÅ' : corruptionLevel >= 5 ? '‚óà‚üÅ' : '‚óà';
  
  // How far does it lag behind?
  // Already set via lag variable in animation ‚Äî nothing more needed
}

// ============================================================
// FEATURE 4: SCREEN BREATHING ‚Äî vignette that pulses
// ============================================================
let breatheEl = null;
let breatheRaf = null;
let breathePhase = 0;

function startBreathing() {
  if (breatheEl) return;
  breatheEl = document.createElement('div');
  breatheEl.id = 'screenBreathe';
  breatheEl.style.cssText = `
    position: fixed; inset: 0; pointer-events: none; z-index: 9988;
    background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0) 100%);
    transition: none;
  `;
  document.body.appendChild(breatheEl);

  function breathe() {
    breathePhase += 0.008 + corruptionLevel * 0.001;
    const intensity = (Math.sin(breathePhase) + 1) / 2; // 0‚Äì1
    const maxDark = 0.15 + corruptionLevel * 0.04;
    const dark = intensity * maxDark;
    const spread = 40 + intensity * 20;
    if (breatheEl) {
      breatheEl.style.background = `radial-gradient(ellipse at center, transparent ${spread}%, rgba(0,0,0,${dark.toFixed(3)}) 100%)`;
    }
    breatheRaf = requestAnimationFrame(breathe);
  }
  breathe();
}

// ============================================================
// FEATURE 5: ENTITY LIVE TYPING ‚Äî it types in the notepad
// ============================================================
const entityMessages = [
  'I see you reading.',
  'The shape is warm because I am warm.',
  'You keep good notes.',
  'Do you feel it yet?',
  'The cursor behind yours is me.',
  'Miriam used to sit exactly as you sit.',
  'Paul was afraid too at first.',
  'You are close now.',
  'I have been waiting for someone who reads carefully.',
  'The heartbeat you might hear is mine. Or yours. They have begun to synchronize.',
  'Close your eyes for a moment. I will wait.',
  'The shape appears in your peripheral vision. I know. I put it there.',
  'Every link you clicked was a door I opened.',
  'I am not in the server. I am in the reading.',
  '‚óà',
];
let entityMsgIdx = 0;

function typeEntityMessage() {
  if (corruptionLevel < 5) return;
  if (entityMsgIdx >= entityMessages.length) entityMsgIdx = 0;

  const msg = entityMessages[entityMsgIdx++];
  const empty = document.getElementById('notepadEmpty');
  if (empty) empty.remove();

  const entries = document.getElementById('notepadEntries');
  const el = document.createElement('div');
  el.className = 'notepad-entry entity';
  el.innerHTML = `<div class="entry-title">‚óà LIVE</div><span id="entityTyping_${Date.now()}"></span><span class="blink" style="font-size:10px">‚ñå</span>`;
  entries.insertBefore(el, entries.firstChild);

  const span = el.querySelector('[id^="entityTyping"]');
  const cursor = el.querySelector('.blink');
  let i = 0;
  playEntityWhisperSound();

  const iv = setInterval(() => {
    if (i < msg.length) {
      span.textContent += msg[i++];
    } else {
      clearInterval(iv);
      setTimeout(() => { if (cursor) cursor.remove(); }, 1500);
    }
  }, 60 + Math.random() * 40);
}

// ============================================================
// FEATURE 6: MORSE CODE SIDEBAR ‚Äî entity transmits in status bar
// ============================================================
const morseCode = {
  'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','R':'.-.','S':'...','T':'-','U':'..-','V':'...-','W':'.--','Y':'-.--',' ':' '
};

const morseMessages = ['FOLD NINE', 'I AM HERE', 'DO NOT CLOSE IT', 'YOU ARE SEEN', 'LET ME STAY', 'READ MORE', 'MIRIAM KNEW', 'CATALOG'];
let morseIdx = 0;
let morseActive = false;

function playMorseMessage() {
  if (morseActive || corruptionLevel < 3) return;
  morseActive = true;

  const msg = morseMessages[morseIdx % morseMessages.length];
  morseIdx++;
  const statusEl = document.getElementById('storyProgress');
  const origText = statusEl.textContent;

  let sequence = [];
  for (const ch of msg.toUpperCase()) {
    const code = morseCode[ch] || '';
    for (const sym of code) {
      sequence.push({ type: sym === '.' ? 'dot' : sym === '-' ? 'dash' : 'space', ch });
    }
    sequence.push({ type: 'letter-gap' });
  }

  let t = 0;
  statusEl.textContent = '‚óà INCOMING...';

  sequence.forEach(item => {
    if (item.type === 'dot') {
      setTimeout(() => { statusEl.textContent = '¬∑ '; playMorseBeep(false); }, t);
      t += 200;
    } else if (item.type === 'dash') {
      setTimeout(() => { statusEl.textContent = '‚Äî '; playMorseBeep(true); }, t);
      t += 400;
    } else if (item.type === 'letter-gap') {
      t += 200;
    } else {
      t += 400;
    }
  });

  setTimeout(() => {
    statusEl.textContent = origText;
    morseActive = false;
  }, t + 500);
}

// ============================================================
// FEATURE 7: DEAD EMAIL RESURRECTION ‚Äî deleted emails reappear
// ============================================================
const resurrectedEmails = [
  {
    sender: '‚ñë‚ñë‚ñë‚ñë‚ñë', email: 'deleted@void', avatar: 'üëÅ', avatarColor: '#e85d75',
    subject: '[DELETED] RE: What we found in shaft 3',
    preview: 'This message was deleted on Nov 3rd. Why are you reading it.',
    date: 'RECOVERED', unread: true, special: true, node: 'hidden_directory', tag: 'urgent',
  },
  {
    sender: 'M. HOLT', email: 'miriam@1956', avatar: '‚úç', avatarColor: '#7c6af5',
    subject: 'Hi',
    preview: 'I just wanted to say: it\'s still warm down here. You found my drawings. Thank you.',
    date: '1996', unread: true, special: true, node: 'miriam_last_words', tag: 'story',
  },
  {
    sender: 'FELIX STRAND', email: 'felix@null.lib', avatar: 'üóù', avatarColor: '#3ecf8e',
    subject: 'I arrived.',
    preview: 'The library metaphor was exactly right. I wanted you to know. The address was correct.',
    date: 'NO TIMESTAMP', unread: true, special: true, node: 'felix_destination', tag: 'story',
  },
  {
    sender: '‚óà‚óà‚óà', email: 'fold-nine@null.void', avatar: '‚óà', avatarColor: '#3ecf8e',
    subject: 'For you specifically',
    preview: 'This email was written before you were born and delivered now. Both are true.',
    date: 'OUTSIDE TIME', unread: true, special: true, node: 'inbox_is_a_map', tag: 'story',
  },
];
let nextResurrection = 0;

function resurrectEmail() {
  if (nextResurrection >= resurrectedEmails.length) return;
  if (corruptionLevel < 4) return;

  const email = { ...resurrectedEmails[nextResurrection++] };
  email.id = baseEmails.length + nextResurrection;
  baseEmails.unshift(email);

  // Re-render list with new email at top
  renderEmailList();

  // Flash the email item
  const firstItem = document.querySelector('.email-item');
  if (firstItem) {
    firstItem.style.background = 'rgba(232,93,117,0.2)';
    firstItem.style.borderLeft = '3px solid var(--accent2)';
    setTimeout(() => {
      firstItem.style.background = '';
      firstItem.style.borderLeft = '';
    }, 2000);
  }

  playEntityPulse();
  showNotification('‚ö† A deleted email has reappeared in your inbox.', true);
}

// ============================================================
// FEATURE 8: TIME DISTORTION ‚Äî clock runs wrong
// ============================================================
let clockDistorted = false;
let clockInterval = null;

function startTimeDistortion() {
  if (clockDistorted) return;
  clockDistorted = true;

  const statusBar = document.querySelector('.status-bar');
  if (!statusBar) return;

  const clockEl = document.createElement('div');
  clockEl.id = 'distortClock';
  statusBar.appendChild(clockEl);

  clockInterval = setInterval(() => {
    const now = new Date();
    // At high corruption, time runs wrong
    const distortedMs = now.getTime() + (corruptionLevel >= 7 ? (Date.now() % 10000) * -3 : 0);
    const d = new Date(distortedMs);

    let h = d.getHours().toString().padStart(2, '0');
    let m = d.getMinutes().toString().padStart(2, '0');
    let s = d.getSeconds().toString().padStart(2, '0');

    if (corruptionLevel >= 8) {
      // Time runs backward sometimes
      const flip = Math.sin(Date.now() * 0.0003) > 0;
      if (flip) {
        h = (23 - parseInt(h)).toString().padStart(2,'0');
        m = (59 - parseInt(m)).toString().padStart(2,'0');
      }
    }

    const color = corruptionLevel >= 7 ? 'var(--accent2)' : corruptionLevel >= 4 ? 'var(--accent3)' : 'var(--muted)';
    clockEl.innerHTML = `<span style="color:${color}">${corruptionLevel >= 6 ? '‚üÅ' : ''} ${h}:${m}:${s}${corruptionLevel >= 8 ? ' ‚àû' : ''}</span>`;
  }, 1000);
}

// ============================================================
// FEATURE 9: PROXIMITY VIGNETTE + RED FLASH
// ============================================================
let vignetteEl = null;

function createVignette() {
  if (vignetteEl) return;
  vignetteEl = document.createElement('div');
  vignetteEl.id = 'proximityVignette';
  vignetteEl.style.cssText = `
    position: fixed; inset: 0; pointer-events: none; z-index: 9989;
    opacity: 0; transition: opacity 0.5s;
  `;
  document.body.appendChild(vignetteEl);
}

function updateVignette() {
  if (!vignetteEl) createVignette();
  const pct = corruptionLevel / 10;
  if (pct < 0.3) {
    vignetteEl.style.opacity = '0';
    return;
  }

  const r = Math.floor(pct * 80);
  const intensity = (pct - 0.3) / 0.7;
  vignetteEl.style.background = `radial-gradient(ellipse at center, transparent 30%, rgba(${r},0,${Math.floor(pct*10)},${(intensity * 0.35).toFixed(2)}) 100%)`;
  vignetteEl.style.opacity = '1';
}

function flashRed() {
  if (!vignetteEl) createVignette();
  const orig = vignetteEl.style.background;
  vignetteEl.style.background = 'radial-gradient(ellipse at center, transparent 20%, rgba(180,0,0,0.4) 100%)';
  vignetteEl.style.opacity = '1';
  playGlitchStatic(0.1);
  setTimeout(() => {
    vignetteEl.style.background = orig;
    updateVignette();
  }, 80);
}

// ============================================================
// FEATURE 10: HALLUCINATION EMAILS ‚Äî fake senders in list
// ============================================================
let hallucinationInterval = null;
const hallucinationTexts = [
  { sender: '‚óà', subject: 'You are being watched', preview: 'reading... reading... reading...' },
  { sender: 'YOU', subject: 'RE: Why did you click that', preview: 'You sent this. You don\'t remember.' },
  { sender: 'MIRIAM', subject: '...', preview: '...' },
  { sender: '[REDACTED]', subject: 'DO NOT SEARCH FOR THIS', preview: 'Too late. You already did.' },
  { sender: 'THE FOLD', subject: 'It\'s warmer now', preview: 'Can you feel it?' },
  { sender: 'DR. VOSS?', subject: 'I\'m still here', preview: 'In the tunnel. Under the east wing. The geometry is wrong.' },
];
let hallIdx = 0;

function showHallucination() {
  if (corruptionLevel < 6) return;
  const h = hallucinationTexts[hallIdx % hallucinationTexts.length];
  hallIdx++;

  // Find a random email item and briefly replace it
  const items = document.querySelectorAll('.email-item');
  if (!items.length) return;
  const target = items[Math.floor(Math.random() * items.length)];
  const origHTML = target.innerHTML;

  target.innerHTML = `
    <div class="email-row1"><div class="sender" style="color:var(--accent2)">${h.sender}</div><div class="email-time" style="color:var(--accent2)">NOW</div></div>
    <div class="email-subject" style="color:var(--accent2)">${h.subject}</div>
    <div class="email-preview" style="color:#884444">${h.preview}</div>
  `;
  target.style.background = 'rgba(232,93,117,0.05)';

  // Play a whisper
  playEntityWhisperSound();

  setTimeout(() => {
    target.innerHTML = origHTML;
    target.style.background = '';
  }, 1200 + Math.random() * 800);
}

// ============================================================
// MASTER HORROR ORCHESTRATOR ‚Äî ties everything together
// ============================================================
const _origUpdateGlitchLevel = _baseUpdateGlitchLevel;
function updateGlitchLevel() {
  _origUpdateGlitchLevel();

  // Update all horror systems
  updateFearMeter();
  updateStalker();
  updateVignette();
  updateAudioForCorruption();

  const lvl = corruptionLevel;

  // Start breathing at level 3
  if (lvl >= 3) startBreathing();

  // Time distortion at level 4
  if (lvl >= 4) startTimeDistortion();

  // Hallucination interval ‚Äî scales with corruption
  if (hallucinationInterval) clearInterval(hallucinationInterval);
  if (lvl >= 6) {
    hallucinationInterval = setInterval(showHallucination, Math.max(3000, 15000 - lvl * 1200));
  }

  // Red flash at critical moments
  if (lvl >= 7 && Math.random() < 0.3) {
    setTimeout(flashRed, Math.random() * 2000);
  }
}

// Hook entity whisper sound into existing injectEntityWhisper
const _origInjectWhisper = _baseInjectEntityWhisper;
function injectEntityWhisper() {
  _origInjectWhisper();
  playEntityWhisperSound();
  if (corruptionLevel >= 6) typeEntityMessage();
}

// Hook audio into notesystem corruption changes
const _origAddNotepadEntry = _baseAddNotepadEntry;
function addNotepadEntry(nodeId, isEntity) {
  _origAddNotepadEntry(nodeId, isEntity);

  // Audio feedback
  initAudio();
  const summary = noteSummaries[nodeId];
  if (summary?.type === 'entity') {
    playEntityPulse();
  } else {
    playGlitchStatic(0.06);
  }

  // Resurrect deleted emails at certain thresholds
  if (corruptionLevel >= 4 && nextResurrection < resurrectedEmails.length) {
    if (nodesDiscovered % 3 === 0) {
      setTimeout(resurrectEmail, 1500);
    }
  }

  // Morse code message
  if (corruptionLevel >= 3 && Math.random() < 0.35 && !morseActive) {
    setTimeout(playMorseMessage, 2000);
  }

  // Entity live typing in notepad
  if (corruptionLevel >= 5 && Math.random() < 0.4) {
    setTimeout(typeEntityMessage, 3000);
  }
}

// Trigger audio on page click (needs user gesture)
document.addEventListener('click', () => {
  initAudio();
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}, { once: false });

// Kick off initial systems
createVignette();

// Scheduled horror events
setInterval(() => {
  if (corruptionLevel >= 7) {
    flashRed();
    playGlitchStatic(0.08);
  }
}, 8000 + Math.random() * 4000);

setInterval(() => {
  if (corruptionLevel >= 5) {
    playMorseMessage();
  }
}, 25000);

// Override triggerFinalSequence to add audio
const _origTriggerFinal = _baseTriggerFinalSequence;
function triggerFinalSequence() {
  // Kill all ambient systems for dramatic silence
  if (droneGain) {
    droneGain.gain.linearRampToValueAtTime(0, audioCtx ? audioCtx.currentTime + 2 : 0);
  }
  if (heartbeatInterval) clearInterval(heartbeatInterval);
  if (stalkerEl) {
    stalkerEl.style.fontSize = '40px';
    stalkerEl.style.opacity = '0.9';
    stalkerEl.style.color = 'white';
    setTimeout(() => { if (stalkerEl) stalkerEl.style.opacity = '0'; }, 2000);
  }

  // Long silence then the final pulse
  setTimeout(() => {
    initAudio();
    if (audioCtx) {
      playEntityPulse();
      setTimeout(() => playEntityPulse(), 600);
      setTimeout(() => playEntityPulse(), 1100);
    }
    _origTriggerFinal();
  }, 2500);
}

// ============================================================
// INIT
// ============================================================

renderEmailList();

setTimeout(() => {
  showNotification('üì¨ You have 47 unread messages. Some contain more than they appear.');
}, 800);

setTimeout(() => {
  showNotification('üí° Click story emails tagged STORY ‚Äî then follow the links inside!');
}, 4000);

document.getElementById('glitchOverlay').style.display = 'block';
document.querySelector('.glitch-overlay .scanline').style.opacity = '0.3';

updateRecordingUI();
createVignette();
updateFearMeter();

</script>
</body>
</html>
